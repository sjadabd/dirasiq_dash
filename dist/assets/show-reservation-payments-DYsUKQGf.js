import{_ as R}from"./ConfirmDangerDialog-DiOiWQFz.js";import{_ as B}from"./SmartTable-DRD1z7i0.js";import{_ as O}from"./AppBreadcrumbs-5PWjj0AR.js";import D from"./teacher_api-DSYadeDI.js";import{V as h,a as N,c as C}from"./VCard-DkKUq9Xw.js";import{z as L,c as P,b as t,e as s,o as S,s as T,p as Y,t as m,d as r,aZ as k,at as M,f as V,n as I,a as J,v as U}from"./index-DzRnBGoW.js";import{V as b}from"./VCardText-DxpVkpnf.js";import{V as v,a as i}from"./VRow-1sXKMjVm.js";import{V as A}from"./VDivider-DOU2dJa1.js";import{n as z}from"./number-DRUmGIrN.js";import{_ as j}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as W}from"./VSelect-DPU1_UF_.js";import{V as q}from"./VChip-BxDWJl9X.js";import"./VDialog-B-d6xDxs.js";import"./VDataTable-DKHI-dYN.js";import"./VPagination-DPnje41R.js";import"./VTable-CGzAcL7O.js";import"./filter-BD0O1YfX.js";import"./VTooltip-CZZ_rwxI.js";import"./axios-CwDcW8lj.js";import"./VAvatar-gDhFptrY.js";import"./VImg-DAcp9xse.js";import"./VList-C_vO-TC7.js";const E={class:"text-h6"},F={class:"text-h6"},Z={class:"text-h6"},G={class:"text-h6"},H={class:"text-h6"},K={class:"text-h6"},Q={class:"text-h6"},X={class:"text-h6"},$={class:"d-flex align-center mb-2"},tt={__name:"report-reservation",props:{data:{type:Object,required:!0,default:()=>({})},studyYear:{type:String,default:""}},setup(e){const l=e,n=a=>Number(a||0).toLocaleString(),d=L(()=>{const a=Number(l.data.totalAmount||0),o=Number(l.data.totalPaid||0);return a<=0?0:Math.min(100,Math.max(0,o/a*100))});return(a,o)=>(S(),P("div",null,[t(h,{elevation:"2",rounded:"lg",class:"mb-4"},{default:s(()=>[t(N,{class:"d-flex align-center"},{default:s(()=>[t(Y,{icon:"ri-bar-chart-2-line",class:"me-2"}),T(" ملخص السنة الدراسية "+m(e.studyYear),1)]),_:1}),t(b,null,{default:s(()=>[t(v,null,{default:s(()=>[t(i,{cols:"12",md:"3"},{default:s(()=>[t(h,{variant:"tonal"},{default:s(()=>[t(b,null,{default:s(()=>[o[0]||(o[0]=r("div",{class:"text-caption"},"إجمالي المبالغ",-1)),r("div",E,m(n(e.data.totalAmount)),1)]),_:1})]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:s(()=>[t(h,{variant:"tonal"},{default:s(()=>[t(b,null,{default:s(()=>[o[1]||(o[1]=r("div",{class:"text-caption"},"إجمالي المدفوع",-1)),r("div",F,m(n(e.data.totalPaid)),1)]),_:1})]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:s(()=>[t(h,{variant:"tonal"},{default:s(()=>[t(b,null,{default:s(()=>[o[2]||(o[2]=r("div",{class:"text-caption"},"إجمالي الخصومات",-1)),r("div",Z,m(n(e.data.totalDiscount)),1)]),_:1})]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:s(()=>[t(h,{variant:"tonal"},{default:s(()=>[t(b,null,{default:s(()=>[o[3]||(o[3]=r("div",{class:"text-caption"},"المتبقي",-1)),r("div",G,m(n(e.data.totalRemaining)),1)]),_:1})]),_:1})]),_:1})]),_:1}),t(A,{class:"my-4"}),t(v,null,{default:s(()=>[t(i,{cols:"12",md:"3"},{default:s(()=>[t(k,{type:"success",variant:"tonal"},{default:s(()=>[o[4]||(o[4]=r("div",{class:"text-caption"},"عدد المدفوعة",-1)),r("div",H,m(n(e.data.paidCount)),1)]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:s(()=>[t(k,{type:"warning",variant:"tonal"},{default:s(()=>[o[5]||(o[5]=r("div",{class:"text-caption"},"عدد المتبقية",-1)),r("div",K,m(n(e.data.remainingCount)),1)]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:s(()=>[t(k,{type:"info",variant:"tonal"},{default:s(()=>[o[6]||(o[6]=r("div",{class:"text-caption"},"عدد بخصم",-1)),r("div",Q,m(n(e.data.discountCount)),1)]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:s(()=>[t(k,{color:"primary",variant:"tonal"},{default:s(()=>[o[7]||(o[7]=r("div",{class:"text-caption"},"إجمالي الفواتير",-1)),r("div",X,m(n(e.data.totalCount)),1)]),_:1})]),_:1})]),_:1}),t(v,{class:"mt-4"},{default:s(()=>[t(i,{cols:"12"},{default:s(()=>[r("div",$,[o[8]||(o[8]=r("span",{class:"me-2"},"نسبة المدفوع",-1)),r("strong",null,m(d.value.toFixed(1))+"%",1)]),t(M,{"model-value":d.value,color:"success",height:"10",rounded:""},null,8,["model-value"])]),_:1})]),_:1})]),_:1})]),_:1})]))}},et={components:{ReportCharts:tt},data(){return{keyName:"show-reservation-payments",results:JSON.parse(localStorage.getItem("user")),breadcrumbItems:[{title:"الرئيسية",disabled:!1,to:"/teacher/index"},{title:"فواتير العربون",disabled:!0}],loading:!1,progress:0,studyYears:[],yearsLoading:!1,table:{totalItems:0,Data:[],actions:["تسديد عربون"],loading:!1,headers:[{title:"#",type:"strong",sortable:!1,key:"num"},{title:"اسم الطالب",type:"strong",sortable:!0,key:"studentName"},{title:"اسم الكورس",type:"strong",sortable:!0,key:"courseName"},{title:"المبلغ",type:"number",sortable:!0,key:"amount"},{title:"الحالة",type:"status",sortable:!0,key:"status"},{title:"تاريخ الدفع",type:"date",sortable:!0,key:"paidAt"},{title:"تفاصيل",type:"link",sortable:!1,key:"reportText"},{title:"العمليات",type:"strong",sortable:!1,key:"actions"}],tableSettings:{options:{page:1,limit:10,sortBy:"",search:null,study_year:JSON.parse(localStorage.getItem("studyYear")),sort:JSON.stringify({key:"paidAt",order:"desc"})}}},report:null,fetchedStudyYear:null,reportChartsData:null,alert:{open:!1,message:null,type:"success"},confirmDialog:{open:!1,item:null,messages:[],title:null,confirmButtonText:null}}},created(){const e=JSON.parse(localStorage.getItem(this.keyName));e&&(this.table.tableSettings=e),this.loadAcademicYears()},methods:{numberWithComma:z,async loadAcademicYears(){var e,l,n,d;try{this.yearsLoading=!0;const a=await D.getAcademicYears(),o=((e=a==null?void 0:a.data)==null?void 0:e.data)||{},y=Array.isArray(o.years)?o.years:[],c=o.active||null;this.studyYears=y.map(u=>({label:u.year,value:u.year})),(d=(n=(l=this.table)==null?void 0:l.tableSettings)==null?void 0:n.options)!=null&&d.study_year||(this.table.tableSettings.options.study_year=(c==null?void 0:c.year)||null),this.getDataAxios()}catch{this.getDataAxios()}finally{this.yearsLoading=!1}},reload(){localStorage.removeItem(this.keyName),this.table.tableSettings.options={page:1,limit:10,sortBy:"",search:null,study_year:JSON.parse(localStorage.getItem("studyYear")),sort:JSON.stringify({key:"paidAt",order:"desc"})},this.getDataAxios()},updateTableOptions(e){this.table.tableSettings.options={...this.table.tableSettings.options,...e,search:e.search?e.search:null},this.getDataAxios()},async getDataAxios(){var l,n,d,a,o,y,c;this.progress=0,this.loading=!0;const e=setInterval(()=>{this.progress<90&&(this.progress+=10)},100);try{localStorage.setItem(this.keyName,JSON.stringify(this.table.tableSettings));const u=await D.getReservationPayments(this.table.tableSettings),p=((l=u==null?void 0:u.data)==null?void 0:l.data)||{},f=p.items||[];this.report=p.report||null;const _=((n=this.report)==null?void 0:n.counts)||{},x=((d=this.report)==null?void 0:d.totals)||{};this.fetchedStudyYear=p.studyYear||((a=this.report)==null?void 0:a.studyYear)||this.table.tableSettings.options.study_year,this.reportChartsData={totalAmount:Number(x.totalAmount||0),totalPaid:Number(x.totalPaidAmount||0),totalDiscount:Number(x.discountAmount||0),totalRemaining:Number(x.remainingAmount||0),totalCount:Number((_.totalPaid||0)+(_.totalPending||0)),paidCount:Number(_.totalPaid||0),remainingCount:Number(_.totalPending||0),discountCount:0},this.table.Data=f.map((g,w)=>({bookingId:g.bookingId||g.booking_id,num:(this.table.tableSettings.options.page-1)*this.table.tableSettings.options.limit+w+1,studentName:g.studentName,courseName:g.courseName,amount:g.amount,status:g.status,paidAt:g.paidAt,reportText:"عرض",reportLink:g.reportLink})),this.table.totalItems=((o=p==null?void 0:p.pagination)==null?void 0:o.total)||f.length}catch(u){this.showAlert("error",((c=(y=u==null?void 0:u.response)==null?void 0:y.data)==null?void 0:c.message)||"حدث خطأ أثناء جلب البيانات")}finally{clearInterval(e),this.progress=100,setTimeout(()=>{this.loading=!1,this.progress=0},300)}},goToDetails(e){const l=(e==null?void 0:e.reportLink)||(e==null?void 0:e.report)&&e.report.to||null;l&&this.$router.push(l)},handleMarkReservationPaid(e){e!=null&&e.bookingId&&(this.confirmDialog.item=e,this.confirmDialog.messages=["هل أنت متأكد من تسديد عربون هذا الحجز؟",e.studentName?`الطالب: ${e.studentName}`:"",e.courseName?`الكورس: ${e.courseName}`:""].filter(Boolean),this.confirmDialog.title="تأكيد تسديد العربون",this.confirmDialog.confirmButtonText="تسديد العربون",this.confirmDialog.open=!0)},async confirmMarkReservationPaid(){var l,n,d;const e=this.confirmDialog.item;if(e!=null&&e.bookingId){this.loading=!0;try{const a=await D.markReservationPaymentPaid(e.bookingId),o=((l=a==null?void 0:a.data)==null?void 0:l.message)||"تم تسديد عربون الحجز بنجاح";this.showAlert("success",o),this.getDataAxios()}catch(a){this.showAlert("error",((d=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:d.message)||"حدث خطأ أثناء تسديد عربون الحجز")}finally{this.loading=!1,this.confirmDialog.open=!1}}},showAlert(e,l){Object.assign(this.alert,{type:e,message:l,open:!0})}}};function at(e,l,n,d,a,o){const y=O,c=J("ReportCharts"),u=B,p=R;return S(),P("div",null,[t(y,{items:a.breadcrumbItems},null,8,["items"]),l[5]||(l[5]=r("br",null,null,-1)),a.reportChartsData?(S(),V(c,{key:0,data:a.reportChartsData,studyYear:a.fetchedStudyYear||a.report&&a.report.studyYear},null,8,["data","studyYear"])):I("",!0),t(h,{class:"my-4 filter-card",elevation:"3",rounded:"lg"},{default:s(()=>[t(N,{class:"d-flex align-center py-4 px-6"},{default:s(()=>[t(Y,{icon:"mdi mdi-filter-outline",color:"primary",class:"me-2",size:"24"}),l[3]||(l[3]=r("h3",{class:"text-h5 font-weight-bold"},"تصفية",-1))]),_:1}),t(A),t(C,null,{default:s(()=>[t(v,{style:{"padding-block":"10px"}},{default:s(()=>[t(i,{cols:"12",md:"4"},{default:s(()=>[t(W,{modelValue:a.table.tableSettings.options.study_year,"onUpdate:modelValue":[l[0]||(l[0]=f=>a.table.tableSettings.options.study_year=f),o.getDataAxios],items:a.studyYears,"item-title":"label","item-value":"value",label:"السنة الدراسية",variant:"outlined",loading:a.yearsLoading},null,8,["modelValue","items","loading","onUpdate:modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(h,{class:"my-4 data-table-card",elevation:"3",rounded:"lg"},{default:s(()=>[t(N,{class:"py-4 px-6"},{default:s(()=>[t(v,{class:"align-center"},{default:s(()=>[t(i,{cols:"auto"},{default:s(()=>[t(U,{color:"primary",onClick:l[1]||(l[1]=f=>o.reload()),icon:"ri-refresh-line",variant:"tonal",rounded:"circle",size:"small",class:"rotate-on-hover"})]),_:1}),t(i,null,{default:s(()=>l[4]||(l[4]=[r("h3",{class:"text-h5 font-weight-bold text-center"},"فواتير عربون الحجوزات",-1)])),_:1}),t(i,{cols:"auto",class:"d-flex gap-2"},{default:s(()=>[t(q,{color:"primary",variant:"elevated",class:"font-weight-medium"},{default:s(()=>[T(m(o.numberWithComma(a.table.totalItems))+" عدد السجلات ",1)]),_:1})]),_:1})]),_:1})]),_:1}),t(A),t(C,null,{default:s(()=>[t(u,{headers:a.table.headers,items:a.table.Data,actions:a.table.actions,loading:a.table.loading,totalItems:a.table.totalItems,tableOptions:a.table.tableSettings.options,onUpdateTableOptions:o.updateTableOptions,onShowItem:o.goToDetails,onMarkReservationPaidItem:o.handleMarkReservationPaid,class:"reservation-payments-table"},null,8,["headers","items","actions","loading","totalItems","tableOptions","onUpdateTableOptions","onShowItem","onMarkReservationPaidItem"])]),_:1})]),_:1}),a.confirmDialog.open?(S(),V(p,{key:1,modelValue:a.confirmDialog.open,"onUpdate:modelValue":l[2]||(l[2]=f=>a.confirmDialog.open=f),messages:a.confirmDialog.messages,title:a.confirmDialog.title,confirmButtonText:a.confirmDialog.confirmButtonText,showCheckbox:!0,checkboxLabel:"أفهم وأؤكد تسديد هذا العربون",confirmIcon:"mdi-cash-multiple",confirmIconActive:"mdi-cash-check",onConfirm:o.confirmMarkReservationPaid},null,8,["modelValue","messages","title","confirmButtonText","onConfirm"])):I("",!0)])}const At=j(et,[["render",at]]);export{At as default};
