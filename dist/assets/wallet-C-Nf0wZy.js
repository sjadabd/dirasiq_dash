import{_ as G}from"./AppBreadcrumbs-C2qXUlsW.js";import L from"./teacher_api-CttZnCtW.js";import{n as k}from"./number-DRUmGIrN.js";import{k as H,l as K,r as i,m as X,ba as Y,c as T,o as x,b as o,e as n,d as s,p as $,s as d,v as V,f as tt,n as q,t as c,i as A,aZ as et,F as at,x as lt,a_ as ot,V as nt}from"./index-omKhXJNb.js";import{a as U,V as E,b as st}from"./VCard-DlaxaK5b.js";import{V as j}from"./VCardText-C-Z2woWC.js";import{V as ut}from"./VTable-2KcgklgL.js";import{V as rt}from"./VPagination-DWTsJtGR.js";import{V as it}from"./VDialog-Cxtu-VAV.js";import{V as dt}from"./VSnackbar-AaMtNobt.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./axios-CERTCeax.js";import"./VAvatar-wQju2yKo.js";import"./VImg-iVV7VdE5.js";const mt={class:"pa-6 d-flex flex-column gap-4"},ft={class:"d-flex align-center gap-2"},pt={class:"d-flex align-center gap-2"},ct={class:"text-h4 font-weight-bold"},vt={class:"d-flex align-center gap-2"},gt={key:0},yt={class:"d-flex justify-end mt-4"},ht={__name:"wallet",setup(Vt){const R=H(),C=K(),z=i(0),N=i([]),_=i(1),F=i(20),M=i(0),W=i(!1),w=i(!1),B=i(!1),b=i(!1),D=i(1e4),I=i(!1),p=i({show:!1,message:"",color:"success"});let g=null,y=null;async function S(){var r,t,m,a,f;W.value=!0;try{const l=await L.getWallet(),e=((r=l==null?void 0:l.data)==null?void 0:r.success)||(l==null?void 0:l.success),v=((t=l==null?void 0:l.data)==null?void 0:t.data)||(l==null?void 0:l.data)||l;if(!e)throw new Error(((m=l==null?void 0:l.data)==null?void 0:m.message)||"تعذر جلب الرصيد");z.value=Number((v==null?void 0:v.balance)??0)}catch(l){p.value={show:!0,message:((f=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:f.message)||(l==null?void 0:l.message)||"تعذر جلب الرصيد",color:"error"}}finally{W.value=!1}}async function h(){var r,t,m,a,f,l;w.value=!0;try{const e=await L.getWalletTransactions(_.value,F.value),v=((r=e==null?void 0:e.data)==null?void 0:r.success)||(e==null?void 0:e.success),u=((t=e==null?void 0:e.data)==null?void 0:t.data)||(e==null?void 0:e.data)||e;if(!v)throw new Error(((m=e==null?void 0:e.data)==null?void 0:m.message)||"تعذر جلب الحركات");const Q=Array.isArray(u==null?void 0:u.items)?u.items:Array.isArray(u==null?void 0:u.data)?u.data:Array.isArray(u)?u:[];N.value=Q,M.value=Number(((a=u==null?void 0:u.pagination)==null?void 0:a.total)??(u==null?void 0:u.total)??Q.length)}catch(e){p.value={show:!0,message:((l=(f=e==null?void 0:e.response)==null?void 0:f.data)==null?void 0:l.message)||(e==null?void 0:e.message)||"تعذر جلب الحركات",color:"error"}}finally{w.value=!1}}function J(r=6e4,t=4e3){g&&clearInterval(g),y&&clearTimeout(y),B.value=!0,g=setInterval(()=>{S()},t),y=setTimeout(()=>{P()},r)}function P(){B.value=!1,g&&clearInterval(g),y&&clearTimeout(y),g=null,y=null}async function O(){var t,m,a,f,l;const r=Number(D.value);if(Number.isNaN(r)||r<=0){p.value={show:!0,message:"يرجى إدخال مبلغ صحيح أكبر من 0",color:"error"};return}I.value=!0;try{const e=await L.createWaylTopupLink(r),v=((t=e==null?void 0:e.data)==null?void 0:t.success)||(e==null?void 0:e.success),u=((m=e==null?void 0:e.data)==null?void 0:m.data)||(e==null?void 0:e.data)||e;if(!v||!(u!=null&&u.url))throw new Error(((a=e==null?void 0:e.data)==null?void 0:a.message)||"تعذر إنشاء رابط الدفع");localStorage.setItem("pending_wayl_action",JSON.stringify({type:"wallet_topup",createdAt:Date.now(),amount:r})),R.push({path:"/teacher/payment/redirecting",query:{url:u.url}})}catch(e){p.value={show:!0,message:((l=(f=e==null?void 0:e.response)==null?void 0:f.data)==null?void 0:l.message)||(e==null?void 0:e.message)||"تعذر إنشاء رابط الدفع",color:"error"}}finally{I.value=!1}}function Z(r){if(!r)return"-";try{return new Date(r).toLocaleString("en-IQ")}catch{return"-"}}return X(async()=>{var r;await S(),await h(),((r=C==null?void 0:C.query)==null?void 0:r.poll)==="1"&&J()}),Y(()=>{P()}),(r,t)=>{const m=G;return x(),T("div",mt,[o(m,{items:[{title:"الرئيسية",disabled:!1,to:"/teacher/index"},{title:"المحفظة",disabled:!0}]}),o(E,{elevation:"2"},{default:n(()=>[o(U,{class:"d-flex align-center justify-space-between"},{default:n(()=>[s("div",ft,[o($,{color:"primary"},{default:n(()=>t[7]||(t[7]=[d("mdi-wallet")])),_:1}),t[8]||(t[8]=s("span",null,"المحفظة",-1))]),s("div",pt,[o(V,{variant:"text",size:"small",loading:W.value,onClick:S},{default:n(()=>t[9]||(t[9]=[d(" تحديث الرصيد ")])),_:1},8,["loading"]),o(V,{color:"primary",onClick:t[0]||(t[0]=a=>b.value=!0)},{default:n(()=>t[10]||(t[10]=[d("شحن المحفظة")])),_:1})])]),_:1}),o(j,null,{default:n(()=>[t[12]||(t[12]=s("div",{class:"text-caption text-medium-emphasis"},"الرصيد الحالي (IQD)",-1)),s("div",ct,c(A(k)(z.value))+" د.ع ",1),B.value?(x(),tt(et,{key:0,type:"info",variant:"tonal",density:"comfortable",class:"mt-4"},{default:n(()=>t[11]||(t[11]=[d(" جارٍ التحقق من تحديث الرصيد بعد الدفع... ")])),_:1})):q("",!0)]),_:1})]),_:1}),o(E,{elevation:"2"},{default:n(()=>[o(U,{class:"d-flex align-center justify-space-between"},{default:n(()=>[s("div",vt,[o($,{color:"primary"},{default:n(()=>t[13]||(t[13]=[d("mdi-swap-horizontal")])),_:1}),t[14]||(t[14]=s("span",null,"حركات المحفظة",-1))]),o(V,{variant:"text",size:"small",loading:w.value,onClick:h},{default:n(()=>t[15]||(t[15]=[d(" تحديث ")])),_:1},8,["loading"])]),_:1}),o(j,null,{default:n(()=>[o(ut,{density:"comfortable"},{default:n(()=>[t[17]||(t[17]=s("thead",null,[s("tr",null,[s("th",null,"التاريخ"),s("th",null,"النوع"),s("th",null,"المبلغ"),s("th",null,"قبل/بعد"),s("th",null,"المرجع")])],-1)),s("tbody",null,[(x(!0),T(at,null,lt(N.value,(a,f)=>(x(),T("tr",{key:a.id||f},[s("td",null,c(Z(a.createdAt||a.date)),1),s("td",null,c(a.type||"-"),1),s("td",null,c(A(k)(a.amount||0)),1),s("td",null,c(A(k)(a.balanceBefore||0))+" / "+c(A(k)(a.balanceAfter||0)),1),s("td",null,c(a.reference||a.referenceType||"-"),1)]))),128)),!w.value&&N.value.length===0?(x(),T("tr",gt,t[16]||(t[16]=[s("td",{colspan:"5",class:"text-center text-medium-emphasis"},"لا توجد حركات",-1)]))):q("",!0)])]),_:1}),s("div",yt,[o(rt,{modelValue:_.value,"onUpdate:modelValue":[t[1]||(t[1]=a=>_.value=a),h],length:Math.max(1,Math.ceil(M.value/F.value)),disabled:w.value},null,8,["modelValue","length","disabled"])])]),_:1})]),_:1}),o(it,{modelValue:b.value,"onUpdate:modelValue":t[4]||(t[4]=a=>b.value=a),"max-width":"520"},{default:n(()=>[o(E,null,{default:n(()=>[o(U,null,{default:n(()=>t[18]||(t[18]=[d("شحن المحفظة")])),_:1}),o(j,null,{default:n(()=>[o(ot,{modelValue:D.value,"onUpdate:modelValue":t[2]||(t[2]=a=>D.value=a),type:"number",label:"المبلغ (IQD)",variant:"outlined",min:"1"},null,8,["modelValue"]),t[19]||(t[19]=s("div",{class:"text-caption text-medium-emphasis mt-2"}," سيتم تحويلك إلى صفحة الدفع الخاصة بـ Wayl. ",-1))]),_:1}),o(st,null,{default:n(()=>[o(nt),o(V,{variant:"text",onClick:t[3]||(t[3]=a=>b.value=!1)},{default:n(()=>t[20]||(t[20]=[d("إلغاء")])),_:1}),o(V,{color:"primary",loading:I.value,onClick:O},{default:n(()=>t[21]||(t[21]=[d(" متابعة الدفع ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(dt,{modelValue:p.value.show,"onUpdate:modelValue":t[6]||(t[6]=a=>p.value.show=a),color:p.value.color,location:"top",timeout:5e3},{actions:n(()=>[o(V,{variant:"text",onClick:t[5]||(t[5]=a=>p.value.show=!1)},{default:n(()=>t[22]||(t[22]=[d("إغلاق")])),_:1})]),default:n(()=>[d(c(p.value.message)+" ",1)]),_:1},8,["modelValue","color"])])}}};export{ht as default};
