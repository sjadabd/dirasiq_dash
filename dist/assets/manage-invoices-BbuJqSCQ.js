import{_ as ue}from"./BaseAlert-CIbD5vpV.js";import{_ as $}from"./ConfirmDangerDialog-BQpL8wVe.js";import{_ as me}from"./SmartTable-BBOnU4NK.js";import{m as pe}from"./vue3-apexcharts-AN_aYgs7.js";import{ac as z,ax as fe,af as Q,ab as L,a2 as ee,av as ce,ad as R,b as e,b8 as ge,A as te,B as ve,aQ as ye,ar as H,bp as be,aA as le,aO as he,z as C,an as De,as as ae,p as k,ae as oe,aG as xe,ay as Ve,aI as Ae,au as Ie,aC as ke,aD as we,a0 as Pe,al as Ce,ai as _e,aU as Ne,a8 as I,ao as Se,cs as Te,bL as Ue,f as w,e as o,o as V,s as y,t as S,d as D,i as Ee,c as M,n as T,a as Oe,v as x,V as Y,a_ as h,aZ as F,F as j,x as G}from"./index-Dmazqufq.js";import{V as P,a as p}from"./VRow-Cfs-sVJ7.js";import{V as A,a as U,c as J,b as K}from"./VCard-5UFuo9Gy.js";import{_ as Be}from"./AppBreadcrumbs-4YtabGru.js";import _ from"./teacher_api-nZLuEPFA.js";import{n as Me}from"./number-DRUmGIrN.js";import{_ as Ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as X}from"./VDialog-DbDU-h44.js";import{V as E}from"./VDivider-BLGk5e6u.js";import{V as N}from"./VSelect-Ci3tM8yu.js";import{V as ze}from"./VChip-mqYz0viO.js";import{V as O}from"./VCardText-CjxXXCA6.js";import"./VDataTable-Cu3_7uXZ.js";import"./VTable-DFA04fiE.js";import"./filter-Bq6oWsmX.js";import"./VTooltip-C4tPPmBK.js";import"./VAvatar-Dibs5cVm.js";import"./VImg-CpbG_9zB.js";import"./axios-BuMR_4uE.js";import"./VList-2eAnxCjm.js";const B=Symbol.for("vuetify:v-expansion-panel"),ne=z({...Q(),...fe()},"VExpansionPanelText"),W=L()({name:"VExpansionPanelText",props:ne(),setup(l,t){let{slots:s}=t;const i=ee(B);if(!i)throw new Error("[Vuetify] v-expansion-panel-text needs to be placed inside v-expansion-panel");const{hasContent:a,onAfterLeave:u}=ce(l,i.isSelected);return R(()=>e(ge,{onAfterLeave:u},{default:()=>{var b;return[te(e("div",{class:["v-expansion-panel-text",l.class],style:l.style},[s.default&&a.value&&e("div",{class:"v-expansion-panel-text__wrapper"},[(b=s.default)==null?void 0:b.call(s)])]),[[ve,i.isSelected.value]])]}})),{}}}),ie=z({color:String,expandIcon:{type:H,default:"$expand"},collapseIcon:{type:H,default:"$collapse"},hideActions:Boolean,focusable:Boolean,static:Boolean,ripple:{type:[Boolean,Object],default:!1},readonly:Boolean,...Q(),...ye()},"VExpansionPanelTitle"),Z=L()({name:"VExpansionPanelTitle",directives:{Ripple:be},props:ie(),setup(l,t){let{slots:s}=t;const i=ee(B);if(!i)throw new Error("[Vuetify] v-expansion-panel-title needs to be placed inside v-expansion-panel");const{backgroundColorClasses:a,backgroundColorStyles:u}=le(l,"color"),{dimensionStyles:b}=he(l),g=C(()=>({collapseIcon:l.collapseIcon,disabled:i.disabled.value,expanded:i.isSelected.value,expandIcon:l.expandIcon,readonly:l.readonly})),m=C(()=>i.isSelected.value?l.collapseIcon:l.expandIcon);return R(()=>{var f;return te(e("button",{class:["v-expansion-panel-title",{"v-expansion-panel-title--active":i.isSelected.value,"v-expansion-panel-title--focusable":l.focusable,"v-expansion-panel-title--static":l.static},a.value,l.class],style:[u.value,b.value,l.style],type:"button",tabindex:i.disabled.value?-1:void 0,disabled:i.disabled.value,"aria-expanded":i.isSelected.value,onClick:l.readonly?void 0:i.toggle},[e("span",{class:"v-expansion-panel-title__overlay"},null),(f=s.default)==null?void 0:f.call(s,g.value),!l.hideActions&&e(ae,{defaults:{VIcon:{icon:m.value}}},{default:()=>{var r;return[e("span",{class:"v-expansion-panel-title__icon"},[((r=s.actions)==null?void 0:r.call(s,g.value))??e(k,null,null)])]}})]),[[De("ripple"),l.ripple]])}),{}}}),se=z({title:String,text:String,bgColor:String,...Ae(),...Ve(),...xe(),...oe(),...ie(),...ne()},"VExpansionPanel"),Le=L()({name:"VExpansionPanel",props:se(),emits:{"group:selected":l=>!0},setup(l,t){let{slots:s}=t;const i=Ie(l,B),{backgroundColorClasses:a,backgroundColorStyles:u}=le(l,"bgColor"),{elevationClasses:b}=ke(l),{roundedClasses:g}=we(l),m=C(()=>(i==null?void 0:i.disabled.value)||l.disabled),f=C(()=>i.group.items.value.reduce((n,v,c)=>(i.group.selected.value.includes(v.id)&&n.push(c),n),[])),r=C(()=>{const n=i.group.items.value.findIndex(v=>v.id===i.id);return!i.isSelected.value&&f.value.some(v=>v-n===1)}),d=C(()=>{const n=i.group.items.value.findIndex(v=>v.id===i.id);return!i.isSelected.value&&f.value.some(v=>v-n===-1)});return Pe(B,i),R(()=>{const n=!!(s.text||l.text),v=!!(s.title||l.title),c=Z.filterProps(l),de=W.filterProps(l);return e(l.tag,{class:["v-expansion-panel",{"v-expansion-panel--active":i.isSelected.value,"v-expansion-panel--before-active":r.value,"v-expansion-panel--after-active":d.value,"v-expansion-panel--disabled":m.value},g.value,a.value,l.class],style:[u.value,l.style]},{default:()=>[e("div",{class:["v-expansion-panel__shadow",...b.value]},null),e(ae,{defaults:{VExpansionPanelTitle:{...c},VExpansionPanelText:{...de}}},{default:()=>{var q;return[v&&e(Z,{key:"title"},{default:()=>[s.title?s.title():l.title]}),n&&e(W,{key:"text"},{default:()=>[s.text?s.text():l.text]}),(q=s.default)==null?void 0:q.call(s)]}})]})}),{groupItem:i}}}),Re=["default","accordion","inset","popout"],Fe=z({flat:Boolean,...Ue(),...Te(se(),["bgColor","collapseIcon","color","eager","elevation","expandIcon","focusable","hideActions","readonly","ripple","rounded","tile","static"]),...Se(),...Q(),...oe(),variant:{type:String,default:"default",validator:l=>Re.includes(l)}},"VExpansionPanels"),je=L()({name:"VExpansionPanels",props:Fe(),emits:{"update:modelValue":l=>!0},setup(l,t){let{slots:s}=t;const{next:i,prev:a}=Ce(l,B),{themeClasses:u}=_e(l),b=C(()=>l.variant&&`v-expansion-panels--variant-${l.variant}`);return Ne({VExpansionPanel:{bgColor:I(l,"bgColor"),collapseIcon:I(l,"collapseIcon"),color:I(l,"color"),eager:I(l,"eager"),elevation:I(l,"elevation"),expandIcon:I(l,"expandIcon"),focusable:I(l,"focusable"),hideActions:I(l,"hideActions"),readonly:I(l,"readonly"),ripple:I(l,"ripple"),rounded:I(l,"rounded"),static:I(l,"static")}}),R(()=>e(l.tag,{class:["v-expansion-panels",{"v-expansion-panels--flat":l.flat,"v-expansion-panels--tile":l.tile},u.value,b.value,l.class],style:l.style},{default:()=>{var g;return[(g=s.default)==null?void 0:g.call(s,{prev:a,next:i})]}})),{next:i,prev:a}}}),Ge={class:"text-h6 font-weight-bold text-white"},Je={class:"text-h6 font-weight-bold text-white"},We={class:"text-h6 font-weight-bold text-white"},Ze={class:"text-h6 font-weight-bold text-white"},Qe={class:"text-h6 font-weight-bold text-white"},re={__name:"report-invoices",props:{report:{type:Object,default:()=>({studyYear:"2025-2026",counts:{totalPaid:0,totalPending:0,totalDiscounted:0},totals:{totalAmount:0,totalPaidAmount:0,discountAmount:0,remainingAmount:0}})}},setup(l){const t=pe,s=l,i=g=>(g==null?void 0:g.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","))||"0",a=C(()=>{var f,r,d,n;const g=((r=(f=s.report)==null?void 0:f.totals)==null?void 0:r.totalAmount)||0,m=((n=(d=s.report)==null?void 0:d.totals)==null?void 0:n.discountAmount)||0;return Math.max(0,Number(g)-Number(m))}),u=C(()=>{var g,m,f,r,d,n,v,c;return[((m=(g=s.report)==null?void 0:g.totals)==null?void 0:m.totalAmount)||0,((r=(f=s.report)==null?void 0:f.totals)==null?void 0:r.discountAmount)||0,((n=(d=s.report)==null?void 0:d.totals)==null?void 0:n.totalPaidAmount)||0,((c=(v=s.report)==null?void 0:v.totals)==null?void 0:c.remainingAmount)||0]}),b=C(()=>({chart:{type:"donut",fontFamily:"Cairo, sans-serif"},labels:["الإجمالي","الخصم","المدفوع","المتبقي"],colors:["#0B2545","#3FA9F5","#6EF2B4","#FF8A00"],legend:{position:"bottom",horizontalAlign:"center",fontSize:"14px",fontFamily:"Cairo, sans-serif"},dataLabels:{enabled:!0,style:{fontSize:"14px",fontFamily:"Cairo, sans-serif"}},tooltip:{y:{formatter:g=>i(g)+" د.ع"}},plotOptions:{pie:{donut:{size:"65%",labels:{show:!0,total:{show:!0,label:"الإجمالي",fontSize:"16px",fontFamily:"Cairo, sans-serif",formatter:function(g){return g.globals.seriesTotals.reduce((m,f)=>m+f,0)}}}}}},responsive:[{breakpoint:480,options:{chart:{width:280},legend:{position:"bottom"}}}]}));return(g,m)=>(V(),w(je,null,{default:o(()=>[e(Le,null,{default:o(()=>[e(Z,null,{default:o(()=>{var f;return[y(" تقرير فواتير الطلاب ("+S(((f=l.report)==null?void 0:f.studyYear)||"2025-2026")+") ",1)]}),_:1}),e(W,null,{default:o(()=>[e(P,{class:"mb-6"},{default:o(()=>[e(p,{cols:"12",sm:"6",md:"2"},{default:o(()=>[e(A,{class:"pa-4 text-center stat-card",elevation:"2",color:"primary"},{default:o(()=>{var f,r;return[e(k,{size:"32",class:"mb-2",color:"white"},{default:o(()=>m[0]||(m[0]=[y("mdi-cash-multiple")])),_:1}),m[1]||(m[1]=D("div",{class:"text-body-2 text-white mb-1"},"إجمالي المبالغ",-1)),D("div",Ge,S(i(((r=(f=l.report)==null?void 0:f.totals)==null?void 0:r.totalAmount)||0))+" د.ع",1)]}),_:1})]),_:1}),e(p,{cols:"12",sm:"6",md:"2"},{default:o(()=>[e(A,{class:"pa-4 text-center stat-card",elevation:"2",color:"info"},{default:o(()=>{var f,r;return[e(k,{size:"32",class:"mb-2",color:"white"},{default:o(()=>m[2]||(m[2]=[y("mdi-ticket-percent")])),_:1}),m[3]||(m[3]=D("div",{class:"text-body-2 text-white mb-1"},"إجمالي الخصم",-1)),D("div",Je,S(i(((r=(f=l.report)==null?void 0:f.totals)==null?void 0:r.discountAmount)||0))+" د.ع",1)]}),_:1})]),_:1}),e(p,{cols:"12",sm:"6",md:"3"},{default:o(()=>[e(A,{class:"pa-4 text-center stat-card",elevation:"2",color:"secondary"},{default:o(()=>[e(k,{size:"32",class:"mb-2",color:"white"},{default:o(()=>m[4]||(m[4]=[y("mdi-calculator")])),_:1}),m[5]||(m[5]=D("div",{class:"text-body-2 text-white mb-1"},"الإجمالي بعد الخصم",-1)),D("div",We,S(i(a.value))+" د.ع",1)]),_:1})]),_:1}),e(p,{cols:"12",sm:"6",md:"2"},{default:o(()=>[e(A,{class:"pa-4 text-center stat-card",elevation:"2",color:"success"},{default:o(()=>{var f,r;return[e(k,{size:"32",class:"mb-2",color:"white"},{default:o(()=>m[6]||(m[6]=[y("mdi-cash-check")])),_:1}),m[7]||(m[7]=D("div",{class:"text-body-2 text-white mb-1"},"إجمالي المدفوع",-1)),D("div",Ze,S(i(((r=(f=l.report)==null?void 0:f.totals)==null?void 0:r.totalPaidAmount)||0))+" د.ع",1)]}),_:1})]),_:1}),e(p,{cols:"12",sm:"6",md:"3"},{default:o(()=>[e(A,{class:"pa-4 text-center stat-card",elevation:"2",color:"error"},{default:o(()=>{var f,r;return[e(k,{size:"32",class:"mb-2",color:"white"},{default:o(()=>m[8]||(m[8]=[y("mdi-cash-remove")])),_:1}),m[9]||(m[9]=D("div",{class:"text-body-2 text-white mb-1"},"المتبقي",-1)),D("div",Qe,S(i(((r=(f=l.report)==null?void 0:f.totals)==null?void 0:r.remainingAmount)||0))+" د.ع",1)]}),_:1})]),_:1})]),_:1}),e(P,null,{default:o(()=>[e(p,{cols:"12"},{default:o(()=>[e(A,{class:"pa-4",elevation:"2"},{default:o(()=>[m[10]||(m[10]=D("h4",{class:"text-h6 font-weight-bold mb-4 text-center"},"تفصيل المبالغ",-1)),e(Ee(t),{type:"donut",options:b.value,series:u.value,height:"350"},null,8,["options","series"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}))}},qe={components:{ReportInvoices:re,ConfirmDangerDialog:$},data(){return{keyName:"teacher-manage-invoices",results:JSON.parse(localStorage.getItem("user")),breadcrumbItems:[{title:"الرئيسية",disabled:!1,to:"/teacher/index"},{title:"فواتير الطلاب",disabled:!0}],progress:0,loading:!1,studyYears:[],yearsLoading:!1,filters:{studyYear:JSON.parse(localStorage.getItem("studyYear"))||"",status:"",deleted:!1},statusItems:[{text:"الكل",value:""},{text:"مدفوعة",value:"paid"},{text:"غير مدفوعة",value:"unpaid"},{text:"جزئية",value:"partial"},{text:"متأخرة",value:"overdue"}],deletedItems:[{text:"محذوف",value:!0},{text:"غير محذوف",value:!1}],report:{},editDialog:{open:!1,invoiceId:null,current:{amountPaid:0,totalDiscount:0,remaining:0},form:{dueDate:"",notes:"",invoiceType:"",paymentMode:"",amountDue:null,installments:[],payments:[],additionalDiscounts:[]}},headers:[{title:"#",type:"strong",sortable:!1,key:"num"},{title:"اسم الطالب",type:"link",sortable:!0,key:"student_name"},{title:"طريقة الدفع",type:"strong",sortable:!0,key:"payment_mode"},{title:"الصف والجلسة",type:"session_title",sortable:!0,key:"grade_name"},{title:"المبلغ المستحق",type:"number",sortable:!0,key:"amount_due"},{title:"إجمالي الخصومات",type:"number",sortable:!0,key:"discount_total"},{title:"المدفوع",type:"number",sortable:!0,key:"amount_paid"},{title:"المتبقي",type:"number",sortable:!0,key:"remaining_amount"},{title:"الحالة",type:"status",sortable:!0,key:"invoice_status"},{title:"العمليات",type:"strong",sortable:!1,key:"actions"}],items:[],tableActions:["تعديل","حذف","اعادة تفعيل"],loadingTable:!1,totalItems:0,tableOptions:{page:1,limit:10,search:null},payDialog:{open:!1,invoiceId:null,form:{amount:null,paymentMethod:"cash",installmentId:"",paidAt:"",notes:""}},discDialog:{open:!1,invoiceId:null,form:{amount:null,notes:""}},paymentMethods:[{text:"نقد",value:"cash"},{text:"تحويل بنكي",value:"bank_transfer"},{text:"بطاقة",value:"card"}],saving:!1,deleteDialog:{open:!1,loading:!1,id:null,messages:[],title:null,confirmButtonText:null},restoreDialog:{open:!1,loading:!1,id:null,messages:[],title:null,confirmButtonText:null,checkboxLabel:null},alert:{open:!1,type:"success",message:""}}},created(){const l=JSON.parse(localStorage.getItem(this.keyName));l&&(l.filters&&(this.filters={...this.filters,...l.filters}),l.tableOptions&&(this.tableOptions={...this.tableOptions,...l.tableOptions})),this.loadAcademicYears()},methods:{reload(){localStorage.removeItem(this.keyName),this.filters={studyYear:"",status:"",deleted:!1},this.tableOptions={page:1,limit:10,search:null},this.loadAcademicYears()},numberWithComma:Me,async loadAcademicYears(){var l;try{this.yearsLoading=!0;const t=await _.getAcademicYears(),s=((l=t==null?void 0:t.data)==null?void 0:l.data)||{},i=Array.isArray(s.years)?s.years:[],a=s.active||null;this.studyYears=i.map(u=>({label:u.year,value:u.year})),this.filters.studyYear||(this.filters.studyYear=(a==null?void 0:a.year)||""),await this.fetchInvoices()}catch{await this.fetchInvoices()}finally{this.yearsLoading=!1}},goToProfile(l){const t=l==null?void 0:l.id;t&&this.$router.push({path:`/teacher/invoices/${t}`,state:l})},async fetchInvoices(){var l,t;this.loadingTable=!0;try{const s={studyYear:this.filters.studyYear,status:this.filters.status,page:this.tableOptions.page,limit:this.tableOptions.limit};this.filters.deleted===!0&&(s.deleted=!0),localStorage.setItem(this.keyName,JSON.stringify({filters:this.filters,tableOptions:this.tableOptions}));const{data:i}=await _.listInvoices(s),a=(i==null?void 0:i.data)||[];this.totalItems=a.length,this.items=a.map((u,b)=>({...u,num:(this.tableOptions.page-1)*this.tableOptions.limit+b+1,detailsText:"تفاصيل",detailsLink:`/teacher/invoices/${u.id}`,is_deleted:typeof u.is_deleted<"u"?u.is_deleted:!!u.deleted_at})),this.fetchInvoicesReport()}catch(s){this.showAlert("error",((t=(l=s==null?void 0:s.response)==null?void 0:l.data)==null?void 0:t.message)||"تعذر جلب الفواتير")}finally{this.loadingTable=!1}},async fetchInvoicesReport(){var l,t;this.loadingTable=!0;try{const s={studyYear:this.filters.studyYear,status:this.filters.status,page:this.tableOptions.page,limit:this.tableOptions.limit};this.filters.deleted===!0&&(s.deleted=!0);const{data:i}=await _.getInvoicesSummary(s),a=(i==null?void 0:i.data)||null;a?this.report={studyYear:this.filters.studyYear||void 0,counts:{totalPaid:Number(a.paidCount||0),totalPending:Number(a.remainingCount||0),totalDiscounted:Number(a.discountCount||0)},totals:{totalAmount:Number(a.totalAmount||0),totalPaidAmount:Number(a.totalPaid||0),discountAmount:Number(a.totalDiscount||0),remainingAmount:Number(a.totalRemaining||0)}}:this.report=null}catch(s){this.showAlert("error",((t=(l=s==null?void 0:s.response)==null?void 0:l.data)==null?void 0:t.message)||"تعذر جلب الفواتير")}finally{this.loadingTable=!1}},onUpdateTableOptions(l){this.tableOptions={...this.tableOptions,...l},this.fetchInvoices()},openAddPayment(l){this.payDialog.invoiceId=l.id,this.payDialog.form={amount:null,paymentMethod:"cash",installmentId:"",paidAt:"",notes:""},this.payDialog.open=!0},async handleAddPayment(){var l,t;if(!this.payDialog.invoiceId||!this.payDialog.form.amount){this.showAlert("error","الرجاء إدخال مبلغ صحيح");return}this.saving=!0;try{const s={amount:Number(this.payDialog.form.amount),paymentMethod:this.payDialog.form.paymentMethod,installmentId:this.payDialog.form.installmentId||void 0,paidAt:this.payDialog.form.paidAt||void 0,notes:this.payDialog.form.notes||void 0,studyYear:this.filters.studyYear||void 0};await _.addInvoicePayment(this.payDialog.invoiceId,s),this.showAlert("success","تمت إضافة الدفعة"),this.payDialog.open=!1,this.fetchInvoices()}catch(s){this.showAlert("error",((t=(l=s==null?void 0:s.response)==null?void 0:l.data)==null?void 0:t.message)||"تعذر إضافة الدفعة")}finally{this.saving=!1}},openAddDiscount(l){this.discDialog.invoiceId=l.id,this.discDialog.form={amount:null,notes:""},this.discDialog.open=!0},openDeleteDialog(l){this.deleteDialog.id=(l==null?void 0:l.id)||null,this.deleteDialog.messages=["سيتم حذف الفاتورة حذفًا منطقيًا (Soft Delete).","يمكن استرجاعها لاحقًا من خلال عملية الاسترجاع."],this.deleteDialog.title="تأكيد الحذف",this.deleteDialog.confirmButtonText="حذف الفاتورة",this.deleteDialog.open=!!this.deleteDialog.id},openRestoreDialog(l){this.restoreDialog.id=(l==null?void 0:l.id)||null,this.restoreDialog.messages=["سيتم استرجاع الفاتورة مع أقساطها وقيودها.","ستتمكن من تعديلها واستخدامها كما كانت."],this.restoreDialog.title="تأكيد الاسترجاع",this.restoreDialog.confirmButtonText="استرجاع الفاتورة",this.restoreDialog.checkboxLabel="أفهم التحذير وأؤكد الاسترجاع",this.restoreDialog.open=!!this.restoreDialog.id},async handleDelete(){var l,t,s;if(this.deleteDialog.id){this.deleteDialog.loading=!0;try{const i=await _.softDeleteInvoice(this.deleteDialog.id);this.showAlert("success",((l=i==null?void 0:i.data)==null?void 0:l.message)||"تم الحذف"),this.deleteDialog.open=!1,this.fetchInvoices()}catch(i){this.showAlert("error",((s=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:s.message)||"تعذر الحذف")}finally{this.deleteDialog.loading=!1}}},async handleRestore(){var l,t,s;if(this.restoreDialog.id){this.restoreDialog.loading=!0;try{const i=await _.restoreInvoice(this.restoreDialog.id);this.showAlert("success",((l=i==null?void 0:i.data)==null?void 0:l.message)||"تم الاسترجاع"),this.restoreDialog.open=!1,this.fetchInvoices()}catch(i){this.showAlert("error",((s=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:s.message)||"تعذر الاسترجاع")}finally{this.restoreDialog.loading=!1}}},async handleAddDiscount(){var l,t;if(!this.discDialog.invoiceId||!this.discDialog.form.amount){this.showAlert("error","الرجاء إدخال مبلغ صحيح");return}this.saving=!0;try{const s={amount:Number(this.discDialog.form.amount),notes:this.discDialog.form.notes||void 0,studyYear:this.filters.studyYear||void 0};await _.addInvoiceDiscount(this.discDialog.invoiceId,s),this.showAlert("success","تمت إضافة الخصم"),this.discDialog.open=!1,this.fetchInvoices()}catch(s){this.showAlert("error",((t=(l=s==null?void 0:s.response)==null?void 0:l.data)==null?void 0:t.message)||"تعذر إضافة الخصم")}finally{this.saving=!1}},openEditInvoice(l){l!=null&&l.id&&this.$router.push({path:`/teacher/invoices/edit/${l.id}`,state:l})},addEditInstallment(){this.editDialog.form.installments.push({installmentNumber:this.editDialog.form.installments.length+1,plannedAmount:null,dueDate:"",initialPaidAmount:0})},removeEditInstallment(l){this.editDialog.form.installments.splice(l,1)},addEditPayment(){this.editDialog.form.payments.push({amount:null,paymentMethod:"cash",installmentNumber:void 0,paidAt:"",notes:""})},removeEditPayment(l){this.editDialog.form.payments.splice(l,1)},addEditAdditionalDiscount(){this.editDialog.form.additionalDiscounts.push({amount:null,notes:""})},removeEditAdditionalDiscount(l){this.editDialog.form.additionalDiscounts.splice(l,1)},async handleUpdateInvoice(){var g,m,f;if(!this.editDialog.invoiceId)return;const l=this.editDialog.invoiceId,t=this.editDialog.form,s=this.editDialog.current,i={};if(t.dueDate===null)i.dueDate=null;else if(t.dueDate&&t.dueDate.trim()!==""){const r=new Date(t.dueDate+"T00:00:00Z").toISOString();i.dueDate=r}if(t.notes===null?i.notes=null:typeof t.notes=="string"&&t.notes.trim()!==""&&(i.notes=t.notes.trim()),t.invoiceType&&(i.invoiceType=t.invoiceType),t.paymentMode&&(i.paymentMode=t.paymentMode),t.amountDue!=null&&t.amountDue!==""){const r=Number(t.amountDue),d=Number(s.amountPaid)+Number(s.totalDiscount);if(isNaN(r)){this.showAlert("error","المبلغ المستحق غير صالح");return}if(r<d){this.showAlert("error",`المبلغ المستحق يجب ألا يقل عن مجموع المدفوع (${s.amountPaid}) + الخصومات (${s.totalDiscount})`);return}i.amountDue=r}if(Array.isArray(t.installments)&&t.installments.length>0){const r=[];for(const d of t.installments)if(d&&Number.isFinite(Number(d.installmentNumber))&&Number.isFinite(Number(d.plannedAmount))&&d.dueDate){const n=new Date(d.dueDate).toISOString();r.push({installmentNumber:Number(d.installmentNumber),plannedAmount:Number(d.plannedAmount),dueDate:n,...d.notes?{notes:String(d.notes)}:{},...d.initialPaidAmount!=null&&d.initialPaidAmount!==""?{initialPaidAmount:Number(d.initialPaidAmount)}:{}})}r.length>0&&(i.installments=r)}let a=0;if(Array.isArray(t.payments)&&t.payments.length>0){const r=[];for(const d of t.payments)if(d&&Number.isFinite(Number(d.amount))&&d.paymentMethod){const n={amount:Number(d.amount),paymentMethod:String(d.paymentMethod)};if(d.installmentNumber!=null&&d.installmentNumber!==""&&(n.installmentNumber=Number(d.installmentNumber)),d.paidAt){const v=d.paidAt.includes("T")?new Date(d.paidAt).toISOString():new Date(d.paidAt+"T00:00:00Z").toISOString();n.paidAt=v}d.notes&&(n.notes=String(d.notes)),a+=n.amount,r.push(n)}r.length>0&&(i.payments=r)}let u=0;if(Array.isArray(t.additionalDiscounts)&&t.additionalDiscounts.length>0){const r=[];for(const d of t.additionalDiscounts)if(d&&Number.isFinite(Number(d.amount))){const n={amount:Number(d.amount)};d.notes&&(n.notes=String(d.notes)),u+=n.amount,r.push(n)}r.length>0&&(i.additionalDiscounts=r)}(g=this.filters)!=null&&g.studyYear&&(i.studyYear=this.filters.studyYear);const b=Number(a)+Number(u);if(b>Number(s.remaining)){this.showAlert("error",`إجمالي الدفعات والخصومات الإضافية (${b}) يتجاوز المتبقي الحالي (${s.remaining})`);return}if(Object.keys(i).length===0){this.showAlert("error","لم يتم تحديد أي تعديل لإرساله");return}this.saving=!0;try{await _.updateInvoice(l,i),this.showAlert("success","تم تعديل الفاتورة بنجاح"),this.editDialog.open=!1,await this.fetchInvoices()}catch(r){this.showAlert("error",((f=(m=r==null?void 0:r.response)==null?void 0:m.data)==null?void 0:f.message)||"تعذر تعديل الفاتورة")}finally{this.saving=!1}},showAlert(l,t){Object.assign(this.alert,{open:!0,type:l,message:t})}}};function He(l,t,s,i,a,u){const b=Be,g=re,m=Oe("RouterLink"),f=me,r=$,d=ue;return V(),M("div",null,[e(b,{items:a.breadcrumbItems},null,8,["items"]),t[43]||(t[43]=D("br",null,null,-1)),e(g,{report:a.report},null,8,["report"]),e(A,{class:"my-4 operations-card",elevation:"3",rounded:"lg"},{default:o(()=>[e(U,{class:"d-flex align-center py-4 px-6"},{default:o(()=>[e(k,{icon:"mdi-cog-outline",color:"primary",class:"me-2",size:"24"}),t[24]||(t[24]=D("h3",{class:"text-h5 font-weight-bold"},"العمليات",-1))]),_:1}),e(E),e(J,null,{default:o(()=>[e(P,{class:"align-center justify-start pa-2"},{default:o(()=>[e(m,{to:{name:"teacher-invoices-create-invoice"}},{default:o(()=>[e(x,{color:"primary","prepend-icon":"ri-add-line"},{default:o(()=>t[25]||(t[25]=[y("إنشاء فاتورة")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(A,{class:"my-4",elevation:"3",rounded:"lg"},{default:o(()=>[e(U,{class:"d-flex align-center py-4 px-6"},{default:o(()=>[e(k,{icon:"ri-filter-3-line",color:"primary",class:"me-2",size:"24"}),t[26]||(t[26]=D("h3",{class:"text-h6 font-weight-bold"},"تصفية",-1)),e(Y)]),_:1}),e(E),e(J,null,{default:o(()=>[e(P,{class:"py-3"},{default:o(()=>[e(p,{cols:"12",md:"4"},{default:o(()=>[e(N,{modelValue:a.filters.studyYear,"onUpdate:modelValue":[t[0]||(t[0]=n=>a.filters.studyYear=n),u.fetchInvoices],items:a.studyYears,"item-title":"label","item-value":"value",label:"السنة الدراسية",variant:"outlined",loading:a.yearsLoading},null,8,["modelValue","items","loading","onUpdate:modelValue"])]),_:1}),e(p,{cols:"12",md:"4"},{default:o(()=>[e(N,{modelValue:a.filters.status,"onUpdate:modelValue":[t[1]||(t[1]=n=>a.filters.status=n),u.fetchInvoices],items:a.statusItems,"item-title":"text","item-value":"value",label:"حالة الفاتورة",variant:"outlined"},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1}),e(p,{cols:"12",md:"4",class:"d-flex align-center"},{default:o(()=>[e(N,{modelValue:a.filters.deleted,"onUpdate:modelValue":[t[2]||(t[2]=n=>a.filters.deleted=n),u.fetchInvoices],items:a.deletedItems,"item-title":"text","item-value":"value",label:"حالة حذف الفاتورة",variant:"outlined"},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(A,{class:"my-4",elevation:"3",rounded:"lg"},{default:o(()=>[e(U,{class:"py-4 px-6"},{default:o(()=>[e(P,{class:"align-center"},{default:o(()=>[e(p,{cols:"auto"},{default:o(()=>[e(x,{color:"primary",onClick:t[3]||(t[3]=n=>u.reload()),icon:"ri-refresh-line",variant:"tonal",rounded:"circle",size:"small",class:"rotate-on-hover"})]),_:1}),e(p,null,{default:o(()=>t[27]||(t[27]=[D("h3",{class:"text-h5 font-weight-bold text-center"},"فواتير الطلاب",-1)])),_:1}),e(p,{cols:"auto",class:"d-flex gap-2"},{default:o(()=>[e(ze,{color:"primary",variant:"elevated",class:"font-weight-medium"},{default:o(()=>[y(S(u.numberWithComma(a.totalItems))+" عدد السجلات ",1)]),_:1})]),_:1})]),_:1})]),_:1}),e(E),e(J,null,{default:o(()=>[e(f,{headers:a.headers,items:a.items,actions:a.tableActions,loading:a.loadingTable,totalItems:a.totalItems,tableOptions:a.tableOptions,onUpdateTableOptions:u.onUpdateTableOptions,onEditItem:u.openEditInvoice,onUpdateResponseItem:u.openAddDiscount,onDeleteItem:u.openDeleteDialog,onEnableItem:u.openRestoreDialog,onShowItem:u.goToProfile},null,8,["headers","items","actions","loading","totalItems","tableOptions","onUpdateTableOptions","onEditItem","onUpdateResponseItem","onDeleteItem","onEnableItem","onShowItem"])]),_:1})]),_:1}),e(X,{modelValue:a.payDialog.open,"onUpdate:modelValue":t[10]||(t[10]=n=>a.payDialog.open=n),"max-width":"520"},{default:o(()=>[e(A,{title:"إضافة دفعة"},{default:o(()=>[e(O,null,{default:o(()=>[e(P,null,{default:o(()=>[e(p,{cols:"12"},{default:o(()=>[e(h,{modelValue:a.payDialog.form.amount,"onUpdate:modelValue":t[4]||(t[4]=n=>a.payDialog.form.amount=n),modelModifiers:{number:!0},type:"number",label:"المبلغ",variant:"outlined"},null,8,["modelValue"])]),_:1}),e(p,{cols:"12"},{default:o(()=>[e(N,{modelValue:a.payDialog.form.paymentMethod,"onUpdate:modelValue":t[5]||(t[5]=n=>a.payDialog.form.paymentMethod=n),items:a.paymentMethods,"item-title":"text","item-value":"value",label:"طريقة الدفع",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),e(p,{cols:"12"},{default:o(()=>[e(h,{modelValue:a.payDialog.form.paidAt,"onUpdate:modelValue":t[6]||(t[6]=n=>a.payDialog.form.paidAt=n),type:"datetime-local",label:"تاريخ الدفع",variant:"outlined"},null,8,["modelValue"])]),_:1}),e(p,{cols:"12"},{default:o(()=>[e(h,{modelValue:a.payDialog.form.installmentId,"onUpdate:modelValue":t[7]||(t[7]=n=>a.payDialog.form.installmentId=n),label:"معرّف القسط (اختياري)",variant:"outlined"},null,8,["modelValue"])]),_:1}),e(p,{cols:"12"},{default:o(()=>[e(h,{modelValue:a.payDialog.form.notes,"onUpdate:modelValue":t[8]||(t[8]=n=>a.payDialog.form.notes=n),label:"ملاحظات",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(K,null,{default:o(()=>[e(x,{onClick:t[9]||(t[9]=n=>a.payDialog.open=!1)},{default:o(()=>t[28]||(t[28]=[y("إلغاء")])),_:1}),e(x,{color:"primary",loading:a.saving,onClick:u.handleAddPayment},{default:o(()=>t[29]||(t[29]=[y("حفظ")])),_:1},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a.restoreDialog.open?(V(),w(r,{key:0,modelValue:a.restoreDialog.open,"onUpdate:modelValue":t[11]||(t[11]=n=>a.restoreDialog.open=n),messages:a.restoreDialog.messages,title:a.restoreDialog.title,confirmButtonText:a.restoreDialog.confirmButtonText,checkboxLabel:a.restoreDialog.checkboxLabel,onConfirm:u.handleRestore},null,8,["modelValue","messages","title","confirmButtonText","checkboxLabel","onConfirm"])):T("",!0),a.deleteDialog.open?(V(),w(r,{key:1,modelValue:a.deleteDialog.open,"onUpdate:modelValue":t[12]||(t[12]=n=>a.deleteDialog.open=n),messages:a.deleteDialog.messages,title:a.deleteDialog.title,confirmButtonText:a.deleteDialog.confirmButtonText,onConfirm:u.handleDelete},null,8,["modelValue","messages","title","confirmButtonText","onConfirm"])):T("",!0),e(X,{modelValue:a.editDialog.open,"onUpdate:modelValue":t[21]||(t[21]=n=>a.editDialog.open=n),"max-width":"520"},{default:o(()=>[e(A,{title:"تعديل الفاتورة"},{default:o(()=>[e(O,null,{default:o(()=>[e(P,null,{default:o(()=>[e(p,{cols:"12"},{default:o(()=>[e(h,{modelValue:a.editDialog.form.dueDate,"onUpdate:modelValue":t[13]||(t[13]=n=>a.editDialog.form.dueDate=n),type:"date",label:"تاريخ الاستحقاق",variant:"outlined",hint:"اتركه فارغًا لإبقاءه كما هو، أو احذف القيمة (null) من زر أدناه","persistent-hint":""},null,8,["modelValue"]),e(x,{variant:"text",size:"small",onClick:t[14]||(t[14]=n=>a.editDialog.form.dueDate=null)},{default:o(()=>t[30]||(t[30]=[y("إزالة التاريخ (null)")])),_:1})]),_:1}),e(p,{cols:"12"},{default:o(()=>[e(h,{modelValue:a.editDialog.form.notes,"onUpdate:modelValue":t[15]||(t[15]=n=>a.editDialog.form.notes=n),label:"ملاحظات",variant:"outlined",hint:"اتركه فارغًا لإبقاءه كما هو، أو اضغط إزالة لمسح القيمة (null)","persistent-hint":""},null,8,["modelValue"]),e(x,{variant:"text",size:"small",onClick:t[16]||(t[16]=n=>a.editDialog.form.notes=null)},{default:o(()=>t[31]||(t[31]=[y("إزالة الملاحظات (null)")])),_:1})]),_:1}),e(p,{cols:"12"},{default:o(()=>[e(N,{modelValue:a.editDialog.form.invoiceType,"onUpdate:modelValue":t[17]||(t[17]=n=>a.editDialog.form.invoiceType=n),items:[{text:"عربون حجز",value:"reservation"},{text:"كورس",value:"course"},{text:"قسط",value:"installment"},{text:"غرامة",value:"penalty"}],"item-title":"text","item-value":"value",label:"نوع الفاتورة",variant:"outlined",clearable:""},null,8,["modelValue"])]),_:1}),e(p,{cols:"12"},{default:o(()=>[e(N,{modelValue:a.editDialog.form.paymentMode,"onUpdate:modelValue":t[18]||(t[18]=n=>a.editDialog.form.paymentMode=n),items:[{text:"كاش",value:"cash"},{text:"أقساط",value:"installments"}],"item-title":"text","item-value":"value",label:"طريقة الدفع",variant:"outlined",clearable:""},null,8,["modelValue"])]),_:1}),e(p,{cols:"12"},{default:o(()=>[e(h,{modelValue:a.editDialog.form.amountDue,"onUpdate:modelValue":t[19]||(t[19]=n=>a.editDialog.form.amountDue=n),modelModifiers:{number:!0},type:"number",label:"المبلغ المستحق",variant:"outlined",hint:"يجب ألا يقل عن مجموع (المدفوع + الخصومات) الحالية","persistent-hint":""},null,8,["modelValue"])]),_:1})]),_:1}),e(A,{variant:"tonal",class:"mt-4"},{default:o(()=>[e(U,{class:"d-flex align-center"},{default:o(()=>[e(k,{icon:"ri-calendar-schedule-line",class:"me-2"}),t[33]||(t[33]=y(" خطة الأقساط (اختياري) ")),e(Y),e(x,{size:"small",variant:"tonal","prepend-icon":"ri-add-line",onClick:u.addEditInstallment},{default:o(()=>t[32]||(t[32]=[y("إضافة قسط")])),_:1},8,["onClick"])]),_:1}),e(E),e(O,null,{default:o(()=>[a.editDialog.form.installments.length?T("",!0):(V(),w(F,{key:0,type:"info",variant:"tonal"},{default:o(()=>t[34]||(t[34]=[y("لا يوجد أقساط")])),_:1})),(V(!0),M(j,null,G(a.editDialog.form.installments,(n,v)=>(V(),w(P,{key:v,class:"mb-1"},{default:o(()=>[e(p,{cols:"12",md:"2"},{default:o(()=>[e(h,{modelValue:n.installmentNumber,"onUpdate:modelValue":c=>n.installmentNumber=c,modelModifiers:{number:!0},type:"number",label:"# القسط",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),e(p,{cols:"12",md:"3"},{default:o(()=>[e(h,{modelValue:n.plannedAmount,"onUpdate:modelValue":c=>n.plannedAmount=c,modelModifiers:{number:!0},type:"number",label:"المبلغ المخطط",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),e(p,{cols:"12",md:"3"},{default:o(()=>[e(h,{modelValue:n.dueDate,"onUpdate:modelValue":c=>n.dueDate=c,type:"date",label:"تاريخ الاستحقاق",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),e(p,{cols:"12",md:"3"},{default:o(()=>[e(h,{modelValue:n.initialPaidAmount,"onUpdate:modelValue":c=>n.initialPaidAmount=c,modelModifiers:{number:!0},type:"number",label:"مدفوع ابتدائي",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),e(p,{cols:"12",md:"1",class:"d-flex align-center"},{default:o(()=>[e(x,{color:"error",size:"small",icon:"ri-delete-bin-line",variant:"text",onClick:c=>u.removeEditInstallment(v)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),e(A,{variant:"tonal",class:"mt-4"},{default:o(()=>[e(U,{class:"d-flex align-center"},{default:o(()=>[e(k,{icon:"ri-money-dollar-circle-line",class:"me-2"}),t[36]||(t[36]=y(" دفعات إضافية (اختياري) ")),e(Y),e(x,{size:"small",variant:"tonal","prepend-icon":"ri-add-line",onClick:u.addEditPayment},{default:o(()=>t[35]||(t[35]=[y("إضافة دفعة")])),_:1},8,["onClick"])]),_:1}),e(E),e(O,null,{default:o(()=>[a.editDialog.form.payments.length?T("",!0):(V(),w(F,{key:0,type:"info",variant:"tonal"},{default:o(()=>t[37]||(t[37]=[y("لا يوجد دفعات")])),_:1})),(V(!0),M(j,null,G(a.editDialog.form.payments,(n,v)=>(V(),w(P,{key:v,class:"mb-1"},{default:o(()=>[e(p,{cols:"12",md:"3"},{default:o(()=>[e(h,{modelValue:n.amount,"onUpdate:modelValue":c=>n.amount=c,modelModifiers:{number:!0},type:"number",label:"المبلغ",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),e(p,{cols:"12",md:"3"},{default:o(()=>[e(N,{modelValue:n.paymentMethod,"onUpdate:modelValue":c=>n.paymentMethod=c,items:a.paymentMethods,"item-title":"text","item-value":"value",label:"طريقة الدفع",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue","items"])]),_:2},1024),e(p,{cols:"12",md:"3"},{default:o(()=>[e(h,{modelValue:n.paidAt,"onUpdate:modelValue":c=>n.paidAt=c,type:"datetime-local",label:"تاريخ الدفع",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),e(p,{cols:"12",md:"2"},{default:o(()=>[e(h,{modelValue:n.installmentNumber,"onUpdate:modelValue":c=>n.installmentNumber=c,modelModifiers:{number:!0},type:"number",label:"# القسط (اختياري)",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),e(p,{cols:"12",md:"1",class:"d-flex align-center"},{default:o(()=>[e(x,{color:"error",size:"small",icon:"ri-delete-bin-line",variant:"text",onClick:c=>u.removeEditPayment(v)},null,8,["onClick"])]),_:2},1024),e(p,{cols:"12"},{default:o(()=>[e(h,{modelValue:n.notes,"onUpdate:modelValue":c=>n.notes=c,label:"ملاحظات",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),e(A,{variant:"tonal",class:"mt-4"},{default:o(()=>[e(U,{class:"d-flex align-center"},{default:o(()=>[e(k,{icon:"ri-price-tag-3-line",class:"me-2"}),t[39]||(t[39]=y(" خصومات إضافية (اختياري) ")),e(Y),e(x,{size:"small",variant:"tonal","prepend-icon":"ri-add-line",onClick:u.addEditAdditionalDiscount},{default:o(()=>t[38]||(t[38]=[y("إضافة خصم ")])),_:1},8,["onClick"])]),_:1}),e(E),e(O,null,{default:o(()=>[a.editDialog.form.additionalDiscounts.length?T("",!0):(V(),w(F,{key:0,type:"info",variant:"tonal"},{default:o(()=>t[40]||(t[40]=[y("لا يوجد خصومات ")])),_:1})),(V(!0),M(j,null,G(a.editDialog.form.additionalDiscounts,(n,v)=>(V(),w(P,{key:v,class:"mb-1"},{default:o(()=>[e(p,{cols:"12",md:"4"},{default:o(()=>[e(h,{modelValue:n.amount,"onUpdate:modelValue":c=>n.amount=c,modelModifiers:{number:!0},type:"number",label:"المبلغ",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),e(p,{cols:"12",md:"7"},{default:o(()=>[e(h,{modelValue:n.notes,"onUpdate:modelValue":c=>n.notes=c,label:"ملاحظات",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),e(p,{cols:"12",md:"1",class:"d-flex align-center"},{default:o(()=>[e(x,{color:"error",size:"small",icon:"ri-delete-bin-line",variant:"text",onClick:c=>u.removeEditAdditionalDiscount(v)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}),e(K,null,{default:o(()=>[e(x,{variant:"text",onClick:t[20]||(t[20]=n=>a.editDialog.open=!1)},{default:o(()=>t[41]||(t[41]=[y("إلغاء")])),_:1}),e(x,{color:"primary",loading:a.saving,onClick:u.handleUpdateInvoice},{default:o(()=>t[42]||(t[42]=[y("حفظ")])),_:1},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a.alert.open?(V(),w(d,{key:2,modelValue:a.alert.open,"onUpdate:modelValue":t[22]||(t[22]=n=>a.alert.open=n),type:a.alert.type,message:a.alert.message,closable:!0,"close-text":"موافق",onClose:t[23]||(t[23]=n=>a.alert.open=!1)},null,8,["modelValue","type","message"])):T("",!0)])}const xt=Ye(qe,[["render",He]]);export{xt as default};
