import{_ as j}from"./BaseAlert-DD7TYDid.js";import{_ as B}from"./ConfirmDangerDialog-CMa2bCpZ.js";import{_ as U}from"./SmartTable-raxuwEO6.js";import{_ as N}from"./AppBreadcrumbs-C2qXUlsW.js";import c from"./teacher_api-CttZnCtW.js";import{n as _}from"./number-DRUmGIrN.js";import{_ as P}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as h,a as A,c as w,b as f}from"./VCard-DlaxaK5b.js";import{V as D}from"./VDialog-Cxtu-VAV.js";import{c as S,b as s,f as x,n as k,e as o,o as b,d as v,p as O,v as p,s as u,t as L,V as J}from"./index-omKhXJNb.js";import{V as T}from"./VDivider-BYIWte0q.js";import{V as C,a as R}from"./VRow-Du8-Eqpf.js";import{V as E}from"./VSelect-Cgo16f76.js";import{V as W}from"./VChip-n5LLO8zQ.js";import{V as y}from"./VCardText-C-Z2woWC.js";import{V}from"./VTextarea-u5K6CJRw.js";import{V as Y}from"./VSwitch-Dxuq803t.js";import"./VDataTable-B8pDatzQ.js";import"./VPagination-DWTsJtGR.js";import"./VTable-2KcgklgL.js";import"./filter-DI_52EWd.js";import"./VTooltip-Dg8TXygl.js";import"./axios-CERTCeax.js";import"./VAvatar-wQju2yKo.js";import"./VImg-iVV7VdE5.js";import"./VList-DkM7Hypf.js";const z={data(){return{keyName:"show-bookings",results:JSON.parse(localStorage.getItem("user")),breadcrumbItems:[{title:"الرئيسية",disabled:!1,to:"/teacher/index"},{title:"الحجوزات",disabled:!0}],loading:!1,progress:0,table:{totalItems:0,Data:[],actions:["موافقة اولية","تاكيد","رفض","تحديث رد","حذف","اعادة تفعيل"],loading:!1,headers:[{title:"#",type:"strong",sortable:!0,key:"num"},{title:"اسم الكورس",type:"link",sortable:!0,key:"course.courseName"},{title:"اسم الطالب",type:"strong",sortable:!0,key:"student.name"},{title:"الصف",type:"strong",sortable:!0,key:"course.gradeName"},{title:"الحالة",type:"status",sortable:!0,key:"status"},{title:"تاريخ ارسال الحجز",type:"date",sortable:!0,key:"createdAt"},{title:"رسالة الطالب",type:"strong",sortable:!0,key:"studentMessage"},{title:"رد الاستاذ",type:"strong",sortable:!0,key:"teacherResponse"},{title:"العمليات",type:"strong",sortable:!1,key:"actions"}],tableSettings:{options:{page:1,limit:10,scroll:0,sortBy:"",search:null,status:null,grade_id:null,subject_id:null,study_year:JSON.parse(localStorage.getItem("studyYear")),sort:'{"key":"createdAt","order":"desc"}'}}},gradeLevelAll:[],courseIsStatus:[{text:"الكل",value:null},{text:"قيد الانتظار",value:"pending"},{text:"موافقة أولية",value:"pre_approved"},{text:"تأكيد الحجز",value:"confirmed"},{text:"مقبول",value:"approved"},{text:"مرفوض",value:"rejected"},{text:"ملغي",value:"cancelled"}],preApproveDialog:{open:!1,data:null,teacherResponse:"مرحباً بكم في الدورة، يرجى إحضار مبلغ الحجز لتأكيد الحجز"},consentDialog:{open:!1,data:null,teacherResponse:"مرحباً بكم في الدورة، يرجى إحضار مبلغ الحجز لتأكيد الحجز",reservationPaid:!1},enableDialog:{open:!1,data:null,messages:[],title:null,confirmButtonText:null,checkboxLabel:null},deleteDialog:{open:!1,data:null,messages:[],title:null,confirmButtonText:null},rejectDialog:{open:!1,data:null,rejectionReason:"",teacherResponse:""},updateResponseDialog:{open:!1,data:null,teacherResponse:""},alert:{open:!1,message:null,type:"success"},insufficientBalanceDialog:{open:!1}}},created(){const l=JSON.parse(localStorage.getItem(this.keyName));this.table.tableSettings=l||this.table.tableSettings,this.tempScrollTop=(l==null?void 0:l.scrollTop)||0},mounted(){window.addEventListener("scroll",this.handleScroll),this.$watch(()=>this.table.Data,l=>{(l==null?void 0:l.length)>0&&this.tempScrollTop&&setTimeout(()=>{window.scrollTo({top:this.tempScrollTop,behavior:"smooth"}),this.tempScrollTop=0},300)},{deep:!0})},computed:{hasReservationSelected(){var l,e,i;return((i=(e=(l=this.consentDialog)==null?void 0:l.data)==null?void 0:e.course)==null?void 0:i.hasReservation)===!0}},beforeUnmount(){var l;(l=this.unwatch)==null||l.call(this),window.removeEventListener("scroll",this.handleScroll)},methods:{numberWithComma:_,handleDataAdded(l){this.getDataAxios(),this.showAlert("success",l)},handleScroll(){const l=window.scrollY||window.pageYOffset,e=JSON.parse(localStorage.getItem(this.keyName))||{};e.scrollTop=l,localStorage.setItem(this.keyName,JSON.stringify(e))},reload(){localStorage.removeItem(this.keyName),this.table.tableSettings.options={page:1,limit:10,scroll:0,sortBy:"",search:null,status:null,grade_id:null,subject_id:null,study_year:JSON.parse(localStorage.getItem("studyYear")),sort:JSON.stringify({key:"createdAt",order:"desc"})},this.getDataAxios()},updateTableOptions(l){this.table.tableSettings.options={...this.table.tableSettings.options,...l,search:l.search?l.search:null},this.getDataAxios()},async getDataAxios(){var e,i,a;this.progress=0,this.loading=!0;const l=setInterval(()=>{this.progress<90&&(this.progress+=10)},100);try{localStorage.setItem(this.keyName,JSON.stringify(this.table.tableSettings));const t=await c.getBookings(this.table.tableSettings);if((e=t.data)!=null&&e.error)return this.showAlert("error",t.data.message||"حدث خطأ أثناء جلب البيانات");this.table.Data=t.data.data,this.table.totalItems=t.data.pagination.total}catch(t){this.showAlert("error",((a=(i=t==null?void 0:t.response)==null?void 0:i.data)==null?void 0:a.message)||"حدث خطأ أثناء جلب البيانات")}finally{clearInterval(l),this.progress=100,setTimeout(()=>{this.loading=!1,this.progress=0},500)}},preApproveItem(l){this.preApproveDialog.data=l,this.preApproveDialog.open=!0},async handlePreApprove(){var e,i;this.progress=0,this.loading=!0;const l=setInterval(()=>{this.progress<90&&(this.progress+=10)},100);try{const a=await c.preApproveBookings(this.preApproveDialog.data.id,this.preApproveDialog.teacherResponse);this.showAlert("success",a.data.message||"تم الحذف بنجاح"),this.getDataAxios()}catch(a){this.showAlert("error",((i=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:i.message)||"حدث خطأ أثناء عملية الحذف")}finally{clearInterval(l),this.progress=100,setTimeout(()=>{this.loading=!1,this.progress=0,this.preApproveDialog.teacherResponse=null,this.preApproveDialog.open=!1},500)}},consentItem(l){this.consentDialog.data=l,this.consentDialog.open=!0},async handleConsent(){var e,i,a,t,r;this.progress=0,this.loading=!0;const l=setInterval(()=>{this.progress<90&&(this.progress+=10)},100);try{const d=((a=(i=(e=this.consentDialog)==null?void 0:e.data)==null?void 0:i.course)==null?void 0:a.hasReservation)===!0,g={teacherResponse:this.consentDialog.teacherResponse,reservationPaid:d?this.consentDialog.reservationPaid===!0:!0},m=await c.consentBookings(this.consentDialog.data.id,g);this.showAlert("success",m.data.message||"تم الحذف بنجاح"),this.getDataAxios()}catch(d){const g=((r=(t=d==null?void 0:d.response)==null?void 0:t.data)==null?void 0:r.message)||(d==null?void 0:d.message)||"حدث خطأ أثناء العملية",m=String(g).toLowerCase();m.includes("insufficient")||m.includes("wallet")||m.includes("balance")||String(g).includes("رصيد")||String(g).includes("غير كافي")?this.insufficientBalanceDialog.open=!0:this.showAlert("error",g)}finally{clearInterval(l),this.progress=100,setTimeout(()=>{this.loading=!1,this.progress=0,this.consentDialog.teacherResponse=null,this.consentDialog.reservationPaid=!1,this.consentDialog.open=!1},500)}},goToWalletTopup(){this.insufficientBalanceDialog.open=!1,this.$router.push({path:"/teacher/wallet",query:{poll:"1"}})},rejectItem(l){this.rejectDialog.data=l,this.rejectDialog.rejectionReason="",this.rejectDialog.teacherResponse="",this.rejectDialog.open=!0},async handleReject(){var e,i;if(!this.rejectDialog.rejectionReason||!this.rejectDialog.rejectionReason.trim()){this.showAlert("error","سبب الرفض مطلوب");return}this.progress=0,this.loading=!0;const l=setInterval(()=>{this.progress<90&&(this.progress+=10)},100);try{const a=await c.rejectBooking(this.rejectDialog.data.id,{rejectionReason:this.rejectDialog.rejectionReason,teacherResponse:this.rejectDialog.teacherResponse||void 0});this.showAlert("success",a.data.message||"تم رفض الحجز"),this.getDataAxios()}catch(a){this.showAlert("error",((i=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:i.message)||"حدث خطأ أثناء عملية الرفض")}finally{clearInterval(l),this.progress=100,setTimeout(()=>{this.loading=!1,this.progress=0,this.rejectDialog.open=!1},500)}},updateResponseItem(l){this.updateResponseDialog.data=l,this.updateResponseDialog.teacherResponse=(l==null?void 0:l.teacherResponse)||"",this.updateResponseDialog.open=!0},async handleUpdateResponse(){var e,i;this.progress=0,this.loading=!0;const l=setInterval(()=>{this.progress<90&&(this.progress+=10)},100);try{const a=await c.updateBookingResponse(this.updateResponseDialog.data.id,this.updateResponseDialog.teacherResponse);this.showAlert("success",a.data.message||"تم التحديث بنجاح"),this.getDataAxios()}catch(a){this.showAlert("error",((i=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:i.message)||"حدث خطأ أثناء عملية التحديث")}finally{clearInterval(l),this.progress=100,setTimeout(()=>{this.loading=!1,this.progress=0,this.updateResponseDialog.open=!1},500)}},enableItem(l){this.enableDialog.data=l,this.enableDialog.messages=["سيتم إعادة تفعيل الحجز.","ستتمكن من مواصلة الإجراءات عليه."],this.enableDialog.title="تأكيد إعادة التفعيل",this.enableDialog.confirmButtonText="إعادة تفعيل الحجز",this.enableDialog.checkboxLabel="أفهم التحذير وأؤكد إعادة التفعيل",this.enableDialog.open=!0},async handleRestore(){var e,i;this.progress=0,this.loading=!0;const l=setInterval(()=>{this.progress<90&&(this.progress+=10)},100);try{const a=await c.reactivateBooking(this.enableDialog.data.id,null);this.showAlert("success",a.data.message||"تمت إعادة التفعيل بنجاح"),this.getDataAxios()}catch(a){this.showAlert("error",((i=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:i.message)||"حدث خطأ أثناء عملية إعادة التفعيل")}finally{clearInterval(l),this.progress=100,setTimeout(()=>{this.loading=!1,this.progress=0,this.enableDialog.open=!1},500)}},deleteItem(l){this.deleteDialog.data=l,this.deleteDialog.messages=["سيتم حذف الحجز.","لا يمكن استرجاعه بعد الحذف."],this.deleteDialog.title="تأكيد الحذف",this.deleteDialog.confirmButtonText="حذف الحجز",this.deleteDialog.open=!0},async handleDelete(){var e,i;this.progress=0,this.loading=!0;const l=setInterval(()=>{this.progress<90&&(this.progress+=10)},100);try{const a=await c.deleteBooking(this.deleteDialog.data.id);this.showAlert("success",a.data.message||"تم حذف الحجز بنجاح"),this.getDataAxios()}catch(a){this.showAlert("error",((i=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:i.message)||"حدث خطأ أثناء عملية الحذف")}finally{clearInterval(l),this.progress=100,setTimeout(()=>{this.loading=!1,this.progress=0,this.deleteDialog.open=!1},500)}},showAlert(l,e){Object.assign(this.alert,{type:l,message:e,open:!0})}}},q={key:0,class:"mt-4"};function M(l,e,i,a,t,r){const d=N,g=U,m=B,I=j;return b(),S("div",null,[s(d,{items:t.breadcrumbItems},null,8,["items"]),s(h,{class:"my-4 filter-card",elevation:"3",rounded:"lg"},{default:o(()=>[s(A,{class:"d-flex align-center py-4 px-6"},{default:o(()=>[s(O,{icon:"mdi mdi-filter-outline",color:"primary",class:"me-2",size:"24"}),e[22]||(e[22]=v("h3",{class:"text-h5 font-weight-bold"},"تصفية",-1))]),_:1}),s(T),s(w,null,{default:o(()=>[s(C,{style:{"padding-block":"10px"}},{default:o(()=>[s(R,{cols:"12",md:"4"},{default:o(()=>[s(E,{modelValue:t.table.tableSettings.options.status,"onUpdate:modelValue":[e[0]||(e[0]=n=>t.table.tableSettings.options.status=n),r.getDataAxios],items:t.courseIsStatus,"item-title":"text","item-value":"value",label:"حالة الحجز",variant:"outlined"},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),s(h,{class:"my-4 data-table-card",elevation:"3",rounded:"lg"},{default:o(()=>[s(A,{class:"py-4 px-6"},{default:o(()=>[s(C,{class:"align-center"},{default:o(()=>[s(R,{cols:"auto"},{default:o(()=>[s(p,{color:"primary",onClick:e[1]||(e[1]=n=>r.reload()),icon:"ri-refresh-line",variant:"tonal",rounded:"circle",size:"small",class:"rotate-on-hover"})]),_:1}),s(R,null,{default:o(()=>e[23]||(e[23]=[v("h3",{class:"text-h5 font-weight-bold text-center"},"الحجوزات",-1)])),_:1}),s(R,{cols:"auto"},{default:o(()=>[s(W,{color:"primary",variant:"elevated",class:"font-weight-medium"},{default:o(()=>[u(L(r.numberWithComma(t.table.totalItems))+" عدد السجلات ",1)]),_:1})]),_:1})]),_:1})]),_:1}),s(T),s(w,null,{default:o(()=>[s(g,{headers:t.table.headers,items:t.table.Data,actions:t.table.actions,loading:t.table.loading,totalItems:t.table.totalItems,tableOptions:t.table.tableSettings.options,onUpdateTableOptions:r.updateTableOptions,onPreApproveItem:r.preApproveItem,onConsentItem:r.consentItem,onRejectItem:r.rejectItem,onUpdateResponseItem:r.updateResponseItem,onEnableItem:r.enableItem,onDeleteItem:r.deleteItem,class:"reservation-table"},null,8,["headers","items","actions","loading","totalItems","tableOptions","onUpdateTableOptions","onPreApproveItem","onConsentItem","onRejectItem","onUpdateResponseItem","onEnableItem","onDeleteItem"])]),_:1})]),_:1}),s(D,{modelValue:t.preApproveDialog.open,"onUpdate:modelValue":e[4]||(e[4]=n=>t.preApproveDialog.open=n),"max-width":"500"},{default:o(()=>[s(h,{title:"الموافقة الاولية على حجز الطالب"},{default:o(()=>[s(y,null,{default:o(()=>[s(V,{modelValue:t.preApproveDialog.teacherResponse,"onUpdate:modelValue":e[2]||(e[2]=n=>t.preApproveDialog.teacherResponse=n),label:"ملاحظة"},null,8,["modelValue"])]),_:1}),s(f,null,{default:o(()=>[s(p,{onClick:e[3]||(e[3]=n=>t.preApproveDialog.open=!1)},{default:o(()=>e[24]||(e[24]=[u("الغاء")])),_:1}),s(p,{onClick:r.handlePreApprove},{default:o(()=>e[25]||(e[25]=[u("موافقة اولية")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(D,{modelValue:t.rejectDialog.open,"onUpdate:modelValue":e[8]||(e[8]=n=>t.rejectDialog.open=n),"max-width":"500"},{default:o(()=>[s(h,{title:"رفض حجز الطالب"},{default:o(()=>[s(y,null,{default:o(()=>[s(V,{modelValue:t.rejectDialog.rejectionReason,"onUpdate:modelValue":e[5]||(e[5]=n=>t.rejectDialog.rejectionReason=n),label:"سبب الرفض (مطلوب)"},null,8,["modelValue"]),s(V,{class:"mt-2",modelValue:t.rejectDialog.teacherResponse,"onUpdate:modelValue":e[6]||(e[6]=n=>t.rejectDialog.teacherResponse=n),label:"ملاحظة (اختياري)"},null,8,["modelValue"])]),_:1}),s(f,null,{default:o(()=>[s(p,{onClick:e[7]||(e[7]=n=>t.rejectDialog.open=!1)},{default:o(()=>e[26]||(e[26]=[u("الغاء")])),_:1}),s(p,{color:"error",onClick:r.handleReject},{default:o(()=>e[27]||(e[27]=[u("رفض")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(D,{modelValue:t.updateResponseDialog.open,"onUpdate:modelValue":e[11]||(e[11]=n=>t.updateResponseDialog.open=n),"max-width":"500"},{default:o(()=>[s(h,{title:"تحديث رد المعلم"},{default:o(()=>[s(y,null,{default:o(()=>[s(V,{modelValue:t.updateResponseDialog.teacherResponse,"onUpdate:modelValue":e[9]||(e[9]=n=>t.updateResponseDialog.teacherResponse=n),label:"رد المعلم"},null,8,["modelValue"])]),_:1}),s(f,null,{default:o(()=>[s(p,{onClick:e[10]||(e[10]=n=>t.updateResponseDialog.open=!1)},{default:o(()=>e[28]||(e[28]=[u("الغاء")])),_:1}),s(p,{color:"primary",onClick:r.handleUpdateResponse},{default:o(()=>e[29]||(e[29]=[u("تحديث")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(D,{modelValue:t.consentDialog.open,"onUpdate:modelValue":e[15]||(e[15]=n=>t.consentDialog.open=n),"max-width":"500"},{default:o(()=>[s(h,{title:"الموافقة على حجز الطالب"},{default:o(()=>[s(y,null,{default:o(()=>[s(V,{modelValue:t.consentDialog.teacherResponse,"onUpdate:modelValue":e[12]||(e[12]=n=>t.consentDialog.teacherResponse=n),label:"ملاحظة"},null,8,["modelValue"]),r.hasReservationSelected?(b(),S("div",q,[s(Y,{modelValue:t.consentDialog.reservationPaid,"onUpdate:modelValue":e[13]||(e[13]=n=>t.consentDialog.reservationPaid=n),inset:"",color:"primary","true-value":!0,"false-value":!1,label:"تم دفع العربون؟"},null,8,["modelValue"]),e[30]||(e[30]=v("div",{class:"text-caption text-medium-emphasis"}," إذا لم يتم دفع العربون بعد، اختر إلغاء التفعيل لإرسال رسالة طلب الدفع. ",-1))])):k("",!0)]),_:1}),s(f,null,{default:o(()=>[s(p,{onClick:e[14]||(e[14]=n=>t.consentDialog.open=!1)},{default:o(()=>e[31]||(e[31]=[u("الغاء")])),_:1}),s(p,{onClick:r.handleConsent},{default:o(()=>e[32]||(e[32]=[u("موافقة")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t.enableDialog.open?(b(),x(m,{key:0,modelValue:t.enableDialog.open,"onUpdate:modelValue":e[16]||(e[16]=n=>t.enableDialog.open=n),messages:t.enableDialog.messages,title:t.enableDialog.title,confirmButtonText:t.enableDialog.confirmButtonText,checkboxLabel:t.enableDialog.checkboxLabel,onConfirm:r.handleRestore},null,8,["modelValue","messages","title","confirmButtonText","checkboxLabel","onConfirm"])):k("",!0),t.deleteDialog.open?(b(),x(m,{key:1,modelValue:t.deleteDialog.open,"onUpdate:modelValue":e[17]||(e[17]=n=>t.deleteDialog.open=n),messages:t.deleteDialog.messages,title:t.deleteDialog.title,confirmButtonText:t.deleteDialog.confirmButtonText,onConfirm:r.handleDelete},null,8,["modelValue","messages","title","confirmButtonText","onConfirm"])):k("",!0),s(D,{modelValue:t.insufficientBalanceDialog.open,"onUpdate:modelValue":e[19]||(e[19]=n=>t.insufficientBalanceDialog.open=n),"max-width":"520"},{default:o(()=>[s(h,{title:"رصيد المحفظة غير كافي"},{default:o(()=>[s(y,null,{default:o(()=>e[33]||(e[33]=[v("div",null,"رصيد محفظتك غير كافي لتأكيد الطلب.",-1),v("div",{class:"text-caption text-medium-emphasis mt-2"}," يمكنك شحن المحفظة ثم العودة وإعادة المحاولة. (سيتم تأكيد الدفع من خلال الـ webhook وقد يتأخر ثواني) ",-1)])),_:1}),s(f,null,{default:o(()=>[s(J),s(p,{variant:"text",onClick:e[18]||(e[18]=n=>t.insufficientBalanceDialog.open=!1)},{default:o(()=>e[34]||(e[34]=[u("إغلاق")])),_:1}),s(p,{color:"primary",onClick:r.goToWalletTopup},{default:o(()=>e[35]||(e[35]=[u("شحن المحفظة")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t.alert.open?(b(),x(I,{key:2,modelValue:t.alert.open,"onUpdate:modelValue":e[20]||(e[20]=n=>t.alert.open=n),type:t.alert.type,message:t.alert.message,closable:!0,"close-text":"موافق",onClose:e[21]||(e[21]=n=>t.alert.open=!1)},null,8,["modelValue","type","message"])):k("",!0)])}const be=P(z,[["render",M]]);export{be as default};
