import{_ as L}from"./BaseAlert-B7PZHURR.js";import{_ as P}from"./AppDateTimePicker-CvTLQXuu.js";import{_ as B}from"./AppBreadcrumbs-CbmSjfOn.js";import{T as M}from"./teacher_api-CgB6fFx4.js";import{_ as j}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as D,b as T}from"./VCard-CBPwRQhR.js";import{c as U,b as l,f as I,x as k,e as i,a as z,o as v,d as y,k as Y,V as C,A as V,q as _,b7 as b,t as w,b9 as O,F as R,s as E}from"./index-B_A_UGf-.js";import{V as F}from"./VDivider-Conlu035.js";import{V as A}from"./VCardText-BWyx6VBY.js";import{V as S,a as r}from"./VRow-DsXvHsvC.js";import{V as N}from"./VSelect-BCxvD-wi.js";import"./VDialog-N4WR69CN.js";import"./axios-WFtL0f35.js";import"./VAvatar-BaPloNUq.js";import"./VImg-Mh6Lj_73.js";import"./VList-khjaFYbC.js";import"./VChip-BWlPf9tC.js";const J={data(){return{results:JSON.parse(localStorage.getItem("user")),breadcrumbItems:[{title:"الرئيسية",disabled:!1,to:"/teacher/index"},{title:"فواتير الطلاب",disabled:!1,to:{name:"teacher-invoices-manage-invoices"}},{title:"تعديل فاتورة",disabled:!0}],loading:!1,saving:!1,progress:0,alert:{open:!1,type:"success",message:""},invoiceId:this.$route.params.invoiceId,studyYears:[],yearsLoading:!1,paymentModes:[{text:"نقد",value:"cash"},{text:"أقساط",value:"installments"}],invoiceTypes:[{text:"دورة",value:"course"},{text:"أخرى",value:"other"}],paymentMethods:[{text:"نقد",value:"cash"},{text:"تحويل بنكي",value:"bank_transfer"},{text:"بطاقة",value:"card"}],form:{studyYear:JSON.parse(localStorage.getItem("studyYear"))||"",paymentMode:"installments",invoiceType:"course",amountDue:null,dueDate:null,invoiceDate:null,discountAmount:0,notes:"",installments:[],payments:[],additionalDiscounts:[]},current:{amountPaid:0,totalDiscount:0,remaining:0}}},created(){var e,m,u,t,a;const n=((e=this.$route)==null?void 0:e.state)||((a=(t=(u=(m=this.$router)==null?void 0:m.options)==null?void 0:u.history)==null?void 0:t.state)==null?void 0:a.data);n&&typeof n=="object"&&(this.form.studyYear=n.study_year||this.form.studyYear,this.form.paymentMode=n.payment_mode||this.form.paymentMode,this.form.invoiceType=n.invoice_type||this.form.invoiceType,this.form.amountDue=n.amount_due!=null?Number(n.amount_due):this.form.amountDue,this.form.dueDate=n.due_date?String(n.due_date).slice(0,10):this.form.dueDate,this.form.notes=n.notes||this.form.notes),this.loadAcademicYears()},mounted(){this.loadDetails()},methods:{async loadAcademicYears(){var n;try{this.yearsLoading=!0;const e=await M.getAcademicYears(),m=((n=e==null?void 0:e.data)==null?void 0:n.data)||{},u=Array.isArray(m.years)?m.years:[],t=m.active||null;this.studyYears=u.map(a=>({label:a.year,value:a.year})),this.form.studyYear||(this.form.studyYear=(t==null?void 0:t.year)||"")}catch{}finally{this.yearsLoading=!1}},formatMoney(n){if(n===""||n===null||typeof n>"u")return"";const e=Number(n);return isFinite(e)?e.toLocaleString():String(n)},parseMoney(n){if(n===""||n===null||typeof n>"u")return null;const e=String(n).replace(/[^0-9.-]/g,""),m=Number(e);return isFinite(m)?m:null},onFormatMoney(n,e){const m=this.parseMoney(e);this.form[n]=m},onFormatInstallmentAmount(n,e){const m=this.parseMoney(e);this.form.installments[n]&&(this.form.installments[n].plannedAmount=m)},showAlert(n,e){Object.assign(this.alert,{open:!0,type:n,message:e})},async loadDetails(){var n,e,m;try{this.loading=!0;const u=await M.getInvoiceInstallments(this.invoiceId),t=((n=u==null?void 0:u.data)==null?void 0:n.data)||{},a=t.invoice||{},d=Array.isArray(t.installments)?t.installments:[],h=Array.isArray(t.entries)?t.entries:[];if(a){this.form.studentId=a.student_id||this.form.studentId,this.form.studyYear=a.study_year||this.form.studyYear,this.form.paymentMode=a.payment_mode||this.form.paymentMode,this.form.invoiceType=a.invoice_type||this.form.invoiceType,this.form.amountDue=a.amount_due!=null?Number(a.amount_due):this.form.amountDue,this.form.dueDate=a.due_date?String(a.due_date).slice(0,10):null,this.form.invoiceDate=a.invoice_date?String(a.invoice_date).slice(0,10):null,this.form.notes=a.notes||this.form.notes;const o=a.amount_paid!=null?Number(a.amount_paid):0,f=a.discount_total!=null?Number(a.discount_total):0,x=a.remaining_amount!=null?Number(a.remaining_amount):0;this.current={amountPaid:o,totalDiscount:f,remaining:x},this.form.discountAmount=f}this.form.installments=d.filter(o=>typeof o.installment_number<"u").map(o=>({installmentNumber:o.installment_number,plannedAmount:o.planned_amount!=null?Number(o.planned_amount):null,dueDate:o.due_date?String(o.due_date).slice(0,10):null,paid:o.is_paid===!0,paidDate:o.paid_date?String(o.paid_date).slice(0,10):null,paidAmount:o.paid_amount!=null?Number(o.paid_amount):null,notes:o.notes||"",_id:o.id}));const p={};for(const o of d)p[o.id]=o.installment_number;const g=[],s=[];let c=0;if(h&&h.length)for(const o of h){const f=(o==null?void 0:o.amount)!=null?Number(o.amount):null;f&&(o.entry_type==="payment"?g.push({amount:f,paymentMethod:o.payment_method||"cash",installmentNumber:o.installment_id?p[o.installment_id]:void 0,paidAt:o.paid_at?String(o.paid_at).slice(0,16):"",notes:o.notes||""}):o.entry_type==="discount"&&(c+=f))}else if(d&&d.length)for(const o of d){const f=(o==null?void 0:o.amount)!=null?Number(o.amount):null;o.entry_type==="discount"&&f&&(c+=f)}if(this.form.payments=g,this.form.additionalDiscounts=[],(!a||a.discount_total==null)&&(this.form.discountAmount=c),(!a||a.amount_paid==null)&&(d!=null&&d.length)){const o=d.reduce((f,x)=>f+(Number(x.paid_amount)||0),0);this.current.amountPaid=o}if((this.form.amountDue==null||this.form.amountDue===0)&&(d!=null&&d.length)){const o=d.find(f=>f.entry_type==="amount_due"&&f.amount!=null);o&&(this.form.amountDue=Number(o.amount))}}catch(u){this.showAlert("error",((m=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:m.message)||"تعذر جلب تفاصيل الفاتورة")}finally{this.loading=!1}},addInstallment(){this.form.installments.push({installmentNumber:this.form.installments.length+1,plannedAmount:null,dueDate:null,initialPaidAmount:0})},removeInstallment(n){this.form.installments.splice(n,1)},addPayment(){this.form.payments.push({amount:null,paymentMethod:"cash",installmentNumber:void 0,paidAt:"",notes:""})},removePayment(n){this.form.payments.splice(n,1)},addAdditionalDiscount(){this.form.additionalDiscounts.push({amount:null,notes:""})},removeAdditionalDiscount(n){this.form.additionalDiscounts.splice(n,1)},async submit(){var e,m;const n={};if(this.form.studentId&&(n.studentId=this.form.studentId),this.form.paymentMode&&(n.paymentMode=this.form.paymentMode),this.form.invoiceType&&(n.invoiceType=this.form.invoiceType),this.form.amountDue!=null&&this.form.amountDue!==""&&(n.amountDue=Number(this.form.amountDue)),this.form.discountAmount!=null&&this.form.discountAmount!==""&&(n.discountAmount=Number(this.form.discountAmount)),this.form.invoiceDate===null?n.invoiceDate=null:this.form.invoiceDate&&this.form.invoiceDate.trim()!==""&&(n.invoiceDate=this.form.invoiceDate),this.form.dueDate===null?n.dueDate=null:this.form.dueDate&&this.form.dueDate.trim()!==""&&(n.dueDate=this.form.dueDate),this.form.notes===null?n.notes=null:typeof this.form.notes=="string"&&this.form.notes.trim()!==""&&(n.notes=this.form.notes.trim()),Array.isArray(this.form.installments)&&this.form.installments.length>0){const u=[];for(const t of this.form.installments)if(t&&Number.isFinite(Number(t.installmentNumber))&&Number.isFinite(Number(t.plannedAmount))&&t.dueDate){const a={...t._id?{id:String(t._id)}:{},installmentNumber:Number(t.installmentNumber),plannedAmount:Number(t.plannedAmount),dueDate:t.dueDate,...t.notes?{notes:String(t.notes)}:{},...t.paidAmount!=null&&t.paidAmount!==""?{paidAmount:Number(t.paidAmount)}:{}};t.paid===!0?(a.is_paid=!0,t.paidDate&&(a.paidDate=t.paidDate)):a.is_paid=!1,u.push(a)}u.length>0&&(n.installments=u)}if(Object.keys(n).length===0)return this.showAlert("error","لم يتم تحديد أي تعديل لإرساله");this.saving=!0;try{await M.updateInvoice(this.invoiceId,n),this.showAlert("success","تم تعديل الفاتورة بنجاح"),this.$router.push({name:"teacher-invoices-manage-invoices"})}catch(u){this.showAlert("error",((m=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:m.message)||"تعذر تعديل الفاتورة")}finally{this.saving=!1}}}},q={class:"text-subtitle-1"},G={class:"text-subtitle-1"},H={class:"mt-4 d-flex justify-end"};function K(n,e,m,u,t,a){const d=B,h=z("RouterLink"),p=P,g=L;return v(),U("div",null,[l(d,{items:t.breadcrumbItems},null,8,["items"]),l(D,{class:"my-4",elevation:"3",rounded:"lg"},{default:i(()=>[l(T,{class:"py-4 px-6 d-flex align-center"},{default:i(()=>[l(Y,{icon:"ri-file-edit-line",color:"primary",class:"me-2",size:"24"}),e[11]||(e[11]=y("h3",{class:"text-h6 font-weight-bold"},"تعديل الفاتورة",-1)),l(C),l(h,{to:{name:"teacher-invoices-manage-invoices"}},{default:i(()=>[l(V,{variant:"text","prepend-icon":"ri-arrow-right-line"},{default:i(()=>e[10]||(e[10]=[_("رجوع")])),_:1})]),_:1})]),_:1}),l(F),l(A,null,{default:i(()=>[l(S,null,{default:i(()=>[l(r,{cols:"12",md:"4"},{default:i(()=>[l(N,{modelValue:t.form.studyYear,"onUpdate:modelValue":e[0]||(e[0]=s=>t.form.studyYear=s),items:t.studyYears,"item-title":"label","item-value":"value",label:"السنة الدراسية",variant:"outlined",loading:t.yearsLoading},null,8,["modelValue","items","loading"])]),_:1}),l(r,{cols:"12",md:"4"},{default:i(()=>[l(N,{modelValue:t.form.paymentMode,"onUpdate:modelValue":e[1]||(e[1]=s=>t.form.paymentMode=s),items:t.paymentModes,"item-title":"text","item-value":"value",label:"طريقة الدفع",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),l(r,{cols:"12",md:"4"},{default:i(()=>[l(N,{modelValue:t.form.invoiceType,"onUpdate:modelValue":e[2]||(e[2]=s=>t.form.invoiceType=s),items:t.invoiceTypes,"item-title":"text","item-value":"value",label:"نوع الفاتورة",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),l(r,{cols:"12",md:"4"},{default:i(()=>[l(b,{"model-value":a.formatMoney(t.form.amountDue),"onUpdate:modelValue":e[3]||(e[3]=s=>a.onFormatMoney("amountDue",s)),label:"المبلغ المستحق",variant:"outlined"},null,8,["model-value"])]),_:1}),l(r,{cols:"12",md:"4"},{default:i(()=>[l(p,{modelValue:t.form.dueDate,"onUpdate:modelValue":e[4]||(e[4]=s=>t.form.dueDate=s),label:"تاريخ الاستحقاق",variant:"outlined"},null,8,["modelValue"])]),_:1}),l(r,{cols:"12",md:"4"},{default:i(()=>[l(p,{modelValue:t.form.invoiceDate,"onUpdate:modelValue":e[5]||(e[5]=s=>t.form.invoiceDate=s),label:"تاريخ الفاتورة",variant:"outlined"},null,8,["modelValue"])]),_:1}),l(r,{cols:"12",md:"4"},{default:i(()=>[l(b,{"model-value":a.formatMoney(t.form.discountAmount),"onUpdate:modelValue":e[6]||(e[6]=s=>a.onFormatMoney("discountAmount",s)),label:"خصم عام",variant:"outlined"},null,8,["model-value"])]),_:1}),l(r,{cols:"12"},{default:i(()=>[l(b,{modelValue:t.form.notes,"onUpdate:modelValue":e[7]||(e[7]=s=>t.form.notes=s),label:"ملاحظات",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1}),l(S,{class:"mt-2"},{default:i(()=>[l(r,{cols:"12",md:"6"},{default:i(()=>[l(D,{variant:"tonal"},{default:i(()=>[l(A,null,{default:i(()=>[e[12]||(e[12]=y("div",{class:"text-caption"},"المدفوع الحالي",-1)),y("div",q,w(Number(t.current.amountPaid).toLocaleString()),1)]),_:1})]),_:1})]),_:1}),l(r,{cols:"12",md:"6"},{default:i(()=>[l(D,{variant:"tonal"},{default:i(()=>[l(A,null,{default:i(()=>[e[13]||(e[13]=y("div",{class:"text-caption"},"الخصومات الحالية",-1)),y("div",G,w(Number(t.current.totalDiscount).toLocaleString()),1)]),_:1})]),_:1})]),_:1})]),_:1}),l(D,{variant:"tonal",class:"mt-4"},{default:i(()=>[l(T,{class:"d-flex align-center"},{default:i(()=>[l(Y,{icon:"ri-calendar-schedule-line",class:"me-2"}),e[15]||(e[15]=_(" خطة الأقساط (اختياري) ")),l(C),l(V,{size:"small",variant:"tonal","prepend-icon":"ri-add-line",onClick:a.addInstallment},{default:i(()=>e[14]||(e[14]=[_("إضافة قسط")])),_:1},8,["onClick"])]),_:1}),l(F),l(A,null,{default:i(()=>[t.form.installments.length?k("",!0):(v(),I(O,{key:0,type:"info",variant:"tonal"},{default:i(()=>e[16]||(e[16]=[_("لا يوجد أقساط")])),_:1})),(v(!0),U(R,null,E(t.form.installments,(s,c)=>(v(),I(S,{key:c,class:"mb-1"},{default:i(()=>[l(r,{cols:"12",md:"2"},{default:i(()=>[l(b,{modelValue:s.installmentNumber,"onUpdate:modelValue":o=>s.installmentNumber=o,modelModifiers:{number:!0},type:"number",label:"# القسط",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(r,{cols:"12",md:"2"},{default:i(()=>[l(b,{"model-value":a.formatMoney(s.plannedAmount),"onUpdate:modelValue":o=>a.onFormatInstallmentAmount(c,o),label:"المبلغ المخطط",variant:"outlined"},null,8,["model-value","onUpdate:modelValue"])]),_:2},1024),l(r,{cols:"12",md:"2"},{default:i(()=>[l(p,{modelValue:s.dueDate,"onUpdate:modelValue":o=>s.dueDate=o,label:"تاريخ الاستحقاق",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(r,{cols:"12",md:"2"},{default:i(()=>[l(N,{modelValue:s.paid,"onUpdate:modelValue":o=>s.paid=o,items:[{text:"غير مدفوع",value:!1},{text:"مدفوع",value:!0}],"item-title":"text","item-value":"value",label:"مدفوع؟",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(r,{cols:"12",md:"2"},{default:i(()=>[l(p,{modelValue:s.paidDate,"onUpdate:modelValue":o=>s.paidDate=o,disabled:!s.paid,label:"تاريخ التسديد",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024),l(r,{cols:"12",md:"1",class:"d-flex align-center"},{default:i(()=>[l(V,{color:"error",size:"small",icon:"ri-delete-bin-line",variant:"text",onClick:o=>a.removeInstallment(c)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),y("div",H,[l(V,{color:"primary",loading:t.saving,"prepend-icon":"ri-save-3-line",onClick:a.submit},{default:i(()=>e[17]||(e[17]=[_("حفظ التعديلات")])),_:1},8,["loading","onClick"])])]),_:1})]),_:1}),t.alert.open?(v(),I(g,{key:0,modelValue:t.alert.open,"onUpdate:modelValue":e[8]||(e[8]=s=>t.alert.open=s),type:t.alert.type,message:t.alert.message,closable:!0,"close-text":"موافق",onClose:e[9]||(e[9]=s=>t.alert.open=!1)},null,8,["modelValue","type","message"])):k("",!0)])}const fe=j(J,[["render",K]]);export{fe as default};
