import{_ as Y}from"./BaseAlert-DD7TYDid.js";import{_ as T}from"./AppDateTimePicker-BgyvrkNf.js";import{_ as F}from"./AppBreadcrumbs-C2qXUlsW.js";import y from"./teacher_api-CttZnCtW.js";import{_ as S}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as b,a as A}from"./VCard-DlaxaK5b.js";import{c as I,b as l,f as g,n as D,e as a,a as B,o as f,d as _,p as x,V as N,v as h,s as p,a_ as c,aZ as z,F as O,x as P}from"./index-omKhXJNb.js";import{V as C}from"./VDivider-BYIWte0q.js";import{V as M}from"./VCardText-C-Z2woWC.js";import{V as U,a as m}from"./VRow-Du8-Eqpf.js";import{V as d}from"./VSelect-Cgo16f76.js";import"./VDialog-Cxtu-VAV.js";import"./axios-CERTCeax.js";import"./VAvatar-wQju2yKo.js";import"./VImg-iVV7VdE5.js";import"./VList-DkM7Hypf.js";import"./VChip-n5LLO8zQ.js";const R={data(){return{results:JSON.parse(localStorage.getItem("user")),breadcrumbItems:[{title:"الرئيسية",disabled:!1,to:"/teacher/index"},{title:"فواتير الطلاب",disabled:!1,to:{name:"teacher-invoices-manage-invoices"}},{title:"إنشاء فاتورة",disabled:!0}],loading:!1,saving:!1,progress:0,alert:{open:!1,type:"success",message:""},studyYears:[],yearsLoading:!1,paymentModes:[{text:"نقد",value:"cash"},{text:"أقساط",value:"installments"}],invoiceTypes:[{text:"دورة",value:"course"},{text:"أخرى",value:"other"}],paymentMethods:[{text:"نقد",value:"cash"},{text:"تحويل بنكي",value:"bank_transfer"},{text:"بطاقة",value:"card"}],courseItems:[],coursesLoading:!1,studentItems:[],studentsLoading:!1,form:{studentId:"",courseId:"",studyYear:JSON.parse(localStorage.getItem("studyYear"))||"",paymentMode:"installments",invoiceType:"course",amountDue:null,dueDate:"",notes:"",discountAmount:0,installments:[],payments:[],additionalDiscounts:[]}}},created(){this.loadAcademicYears()},mounted(){this.loadCourses()},methods:{formatMoney(o){if(o===""||o===null||typeof o>"u")return"";const e=Number(o);return isFinite(e)?e.toLocaleString():String(o)},parseMoney(o){if(o===""||o===null||typeof o>"u")return null;const e=String(o).replace(/[^0-9.-]/g,""),i=Number(e);return isFinite(i)?i:null},onFormatMoney(o,e){const i=this.parseMoney(e);this.form[o]=i},onFormatInstallmentAmount(o,e){const i=this.parseMoney(e);this.form.installments[o]&&(this.form.installments[o].plannedAmount=i)},async loadAcademicYears(){var o;try{this.yearsLoading=!0;const e=await y.getAcademicYears(),i=((o=e==null?void 0:e.data)==null?void 0:o.data)||{},s=Array.isArray(i.years)?i.years:[],t=i.active||null;this.studyYears=s.map(r=>({label:r.year,value:r.year})),this.form.studyYear||(this.form.studyYear=(t==null?void 0:t.year)||"")}catch{}finally{this.yearsLoading=!1}},addInstallment(){this.form.installments.push({installmentNumber:this.form.installments.length+1,plannedAmount:null,dueDate:"",paid:!1,paidDate:""})},removeInstallment(o){this.form.installments.splice(o,1)},addPayment(){this.form.payments.push({amount:null,paymentMethod:"cash",installmentNumber:void 0,paidAt:"",notes:""})},removePayment(o){this.form.payments.splice(o,1)},addAdditionalDiscount(){this.form.additionalDiscounts.push({amount:null,notes:""})},removeAdditionalDiscount(o){this.form.additionalDiscounts.splice(o,1)},async loadCourses(){var o;try{this.coursesLoading=!0;const e=await y.getCourseNames(),i=((o=e==null?void 0:e.data)==null?void 0:o.data)||[];this.courseItems=i.map(s=>({text:s.name||s.course_name||"-",value:s.id}))}catch{this.showAlert("error","تعذر جلب أسماء الدورات")}finally{this.coursesLoading=!1}},async onCourseChange(){var o;if(this.form.studentId="",this.studentItems=[],!!this.form.courseId)try{this.studentsLoading=!0;const e=await y.getStudentsByCourse(this.form.courseId),i=((o=e==null?void 0:e.data)==null?void 0:o.data)||[];this.studentItems=i.map(s=>({id:s.id||s.student_id,name:s.name||s.student_name}))}catch{this.showAlert("error","تعذر جلب طلاب الكورس")}finally{this.studentsLoading=!1}},async submit(){var e,i;if(!this.form.studentId||!this.form.courseId||!this.form.studyYear||this.form.amountDue==null){this.showAlert("error","الرجاء إدخال الحقول الأساسية (طالب، كورس، سنة، مبلغ)");return}const o={studentId:this.form.studentId,courseId:this.form.courseId,studyYear:this.form.studyYear,paymentMode:this.form.paymentMode,amountDue:Number(this.form.amountDue)};if(this.form.invoiceType&&(o.invoiceType=this.form.invoiceType),this.form.discountAmount!=null&&this.form.discountAmount!==""&&(o.discountAmount=Number(this.form.discountAmount)),this.form.dueDate===null?o.dueDate=null:this.form.dueDate&&this.form.dueDate.trim()!==""&&(o.dueDate=this.form.dueDate),this.form.notes===null?o.notes=null:typeof this.form.notes=="string"&&this.form.notes.trim()!==""&&(o.notes=this.form.notes.trim()),this.form.paymentMode==="installments"){if(!Array.isArray(this.form.installments)||this.form.installments.length===0)return this.showAlert("error","خطة الأقساط مطلوبة عند اختيار طريقة الدفع بالأقساط");const s=[];for(const t of this.form.installments)if(t&&Number.isFinite(Number(t.installmentNumber))&&Number.isFinite(Number(t.plannedAmount))&&t.dueDate){const r={installmentNumber:Number(t.installmentNumber),plannedAmount:Number(t.plannedAmount),dueDate:t.dueDate,...t.notes?{notes:String(t.notes)}:{}};t.paid===!0&&(r.paid=!0,t.paidDate&&(r.paidDate=t.paidDate)),s.push(r)}if(s.length===0)return this.showAlert("error","خطة الأقساط غير صالحة");o.installments=s}this.saving=!0;try{const{data:s}=await y.createInvoice(o);this.showAlert("success",(s==null?void 0:s.message)||"تم إنشاء الفاتورة"),this.$router.push({name:"teacher-invoices-manage-invoices"})}catch(s){this.showAlert("error",((i=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:i.message)||"تعذر إنشاء الفاتورة")}finally{this.saving=!1}},showAlert(o,e){Object.assign(this.alert,{open:!0,type:o,message:e})}}},j={class:"mt-4 d-flex justify-end"};function J(o,e,i,s,t,r){const L=F,k=B("RouterLink"),v=T,w=Y;return f(),I("div",null,[l(L,{items:t.breadcrumbItems},null,8,["items"]),l(b,{class:"my-4",elevation:"3",rounded:"lg"},{default:a(()=>[l(A,{class:"py-4 px-6 d-flex align-center"},{default:a(()=>[l(x,{icon:"ri-file-add-line",color:"primary",class:"me-2",size:"24"}),e[12]||(e[12]=_("h3",{class:"text-h6 font-weight-bold"},"إنشاء فاتورة",-1)),l(N),l(k,{to:{name:"teacher-invoices-manage-invoices"}},{default:a(()=>[l(h,{variant:"text","prepend-icon":"ri-arrow-right-line"},{default:a(()=>e[11]||(e[11]=[p("رجوع")])),_:1})]),_:1})]),_:1}),l(C),l(M,null,{default:a(()=>[l(U,null,{default:a(()=>[l(m,{cols:"12",md:"4"},{default:a(()=>[l(d,{modelValue:t.form.courseId,"onUpdate:modelValue":[e[0]||(e[0]=n=>t.form.courseId=n),r.onCourseChange],items:t.courseItems,"item-title":"text","item-value":"value",label:"اختر الكورس",variant:"outlined",loading:t.coursesLoading,disabled:t.coursesLoading,clearable:""},null,8,["modelValue","items","loading","disabled","onUpdate:modelValue"])]),_:1}),l(m,{cols:"12",md:"4"},{default:a(()=>[l(d,{modelValue:t.form.studentId,"onUpdate:modelValue":e[1]||(e[1]=n=>t.form.studentId=n),items:t.studentItems,"item-title":"name","item-value":"id",label:"اختر الطالب",variant:"outlined",loading:t.studentsLoading,disabled:t.studentsLoading||!t.form.courseId,clearable:""},null,8,["modelValue","items","loading","disabled"])]),_:1}),l(m,{cols:"12",md:"4"},{default:a(()=>[l(d,{modelValue:t.form.studyYear,"onUpdate:modelValue":e[2]||(e[2]=n=>t.form.studyYear=n),items:t.studyYears,"item-title":"label","item-value":"value",label:"السنة الدراسية",variant:"outlined",loading:t.yearsLoading},null,8,["modelValue","items","loading"])]),_:1}),l(m,{cols:"12",md:"4"},{default:a(()=>[l(d,{modelValue:t.form.paymentMode,"onUpdate:modelValue":e[3]||(e[3]=n=>t.form.paymentMode=n),items:t.paymentModes,"item-title":"text","item-value":"value",label:"طريقة الدفع",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),l(m,{cols:"12",md:"4"},{default:a(()=>[l(d,{modelValue:t.form.invoiceType,"onUpdate:modelValue":e[4]||(e[4]=n=>t.form.invoiceType=n),items:t.invoiceTypes,"item-title":"text","item-value":"value",label:"نوع الفاتورة",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),l(m,{cols:"12",md:"4"},{default:a(()=>[l(c,{"model-value":r.formatMoney(t.form.amountDue),"onUpdate:modelValue":e[5]||(e[5]=n=>r.onFormatMoney("amountDue",n)),label:"المبلغ المستحق",variant:"outlined"},null,8,["model-value"])]),_:1}),l(m,{cols:"12",md:"4"},{default:a(()=>[l(v,{modelValue:t.form.dueDate,"onUpdate:modelValue":e[6]||(e[6]=n=>t.form.dueDate=n),label:"تاريخ الاستحقاق",variant:"outlined"},null,8,["modelValue"])]),_:1}),l(m,{cols:"12",md:"4"},{default:a(()=>[l(c,{"model-value":r.formatMoney(t.form.discountAmount),"onUpdate:modelValue":e[7]||(e[7]=n=>r.onFormatMoney("discountAmount",n)),label:"خصم عام",variant:"outlined"},null,8,["model-value"])]),_:1}),l(m,{cols:"12"},{default:a(()=>[l(c,{modelValue:t.form.notes,"onUpdate:modelValue":e[8]||(e[8]=n=>t.form.notes=n),label:"ملاحظات",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1}),l(b,{variant:"tonal",class:"mt-4"},{default:a(()=>[l(A,{class:"d-flex align-center"},{default:a(()=>[l(x,{icon:"ri-calendar-schedule-line",class:"me-2"}),e[14]||(e[14]=p(" خطة الأقساط (اختياري) ")),l(N),l(h,{size:"small",variant:"tonal","prepend-icon":"ri-add-line",onClick:r.addInstallment},{default:a(()=>e[13]||(e[13]=[p("إضافة قسط")])),_:1},8,["onClick"])]),_:1}),l(C),l(M,null,{default:a(()=>[t.form.installments.length?D("",!0):(f(),g(z,{key:0,type:"info",variant:"tonal"},{default:a(()=>e[15]||(e[15]=[p("لا يوجد أقساط")])),_:1})),(f(!0),I(O,null,P(t.form.installments,(n,V)=>(f(),g(U,{key:V,class:"mb-1"},{default:a(()=>[l(m,{cols:"12",md:"2"},{default:a(()=>[l(c,{modelValue:n.installmentNumber,"onUpdate:modelValue":u=>n.installmentNumber=u,modelModifiers:{number:!0},type:"number",label:"# القسط",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(m,{cols:"12",md:"3"},{default:a(()=>[l(c,{"model-value":r.formatMoney(n.plannedAmount),"onUpdate:modelValue":u=>r.onFormatInstallmentAmount(V,u),label:"المبلغ المخطط",variant:"outlined"},null,8,["model-value","onUpdate:modelValue"])]),_:2},1024),l(m,{cols:"12",md:"2"},{default:a(()=>[l(v,{modelValue:n.dueDate,"onUpdate:modelValue":u=>n.dueDate=u,label:"تاريخ الاستحقاق",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(m,{cols:"12",md:"2"},{default:a(()=>[l(d,{modelValue:n.paid,"onUpdate:modelValue":u=>n.paid=u,items:[{text:"غير مدفوع",value:!1},{text:"مدفوع",value:!0}],"item-title":"text","item-value":"value",label:"مدفوع؟",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(m,{cols:"12",md:"2"},{default:a(()=>[l(v,{modelValue:n.paidDate,"onUpdate:modelValue":u=>n.paidDate=u,disabled:!n.paid,label:"تاريخ التسديد",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024),l(m,{cols:"12",md:"1",class:"d-flex align-center"},{default:a(()=>[l(h,{color:"error",size:"small",icon:"ri-delete-bin-line",variant:"text",onClick:u=>r.removeInstallment(V)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),_("div",j,[l(h,{color:"primary",loading:t.saving,"prepend-icon":"ri-save-3-line",onClick:r.submit},{default:a(()=>e[16]||(e[16]=[p("حفظ الفاتورة")])),_:1},8,["loading","onClick"])])]),_:1})]),_:1}),t.alert.open?(f(),g(w,{key:0,modelValue:t.alert.open,"onUpdate:modelValue":e[9]||(e[9]=n=>t.alert.open=n),type:t.alert.type,message:t.alert.message,closable:!0,"close-text":"موافق",onClose:e[10]||(e[10]=n=>t.alert.open=!1)},null,8,["modelValue","type","message"])):D("",!0)])}const ie=S(R,[["render",J]]);export{ie as default};
