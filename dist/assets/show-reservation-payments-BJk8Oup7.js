import{_ as P}from"./SmartTable-BNEhEptK.js";import{_ as T}from"./AppBreadcrumbs-5R_D72iC.js";import V from"./teacher_api-DyrQANjO.js";import{V as g,a as S,c as k}from"./VCard-CTAW927Q.js";import{z as w,c as I,b as t,e,o as N,s as D,p as Y,t as u,d as r,b0 as x,at as L,f as B,n as R,a as J,v as U}from"./index-N2EhsRQt.js";import{V as b}from"./VCardText-Q2eeque7.js";import{V as h,a as i}from"./VRow--YcB0Yd0.js";import{V as A}from"./VDivider-D-Cf14qE.js";import{n as z}from"./number-DRUmGIrN.js";import{_ as j}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as M}from"./VSelect-Di_TKuth.js";import{V as W}from"./VChip-v8q_B89j.js";import"./VDataTable-CWyK32cU.js";import"./VTable-uKW7adu2.js";import"./filter-0X3vSYrS.js";import"./VTooltip-qYS1AgXw.js";import"./axios-CK0PAUQZ.js";import"./VAvatar-M6cRQjPV.js";import"./VImg-DOYF3Gzb.js";import"./VList-BwysrA6o.js";const q={class:"text-h6"},E={class:"text-h6"},F={class:"text-h6"},G={class:"text-h6"},H={class:"text-h6"},K={class:"text-h6"},Q={class:"text-h6"},X={class:"text-h6"},Z={class:"d-flex align-center mb-2"},$={__name:"report-reservation",props:{data:{type:Object,required:!0,default:()=>({})},studyYear:{type:String,default:""}},setup(a){const o=a,n=l=>Number(l||0).toLocaleString(),m=w(()=>{const l=Number(o.data.totalAmount||0),s=Number(o.data.totalPaid||0);return l<=0?0:Math.min(100,Math.max(0,s/l*100))});return(l,s)=>(N(),I("div",null,[t(g,{elevation:"2",rounded:"lg",class:"mb-4"},{default:e(()=>[t(S,{class:"d-flex align-center"},{default:e(()=>[t(Y,{icon:"ri-bar-chart-2-line",class:"me-2"}),D(" ملخص السنة الدراسية "+u(a.studyYear),1)]),_:1}),t(b,null,{default:e(()=>[t(h,null,{default:e(()=>[t(i,{cols:"12",md:"3"},{default:e(()=>[t(g,{variant:"tonal"},{default:e(()=>[t(b,null,{default:e(()=>[s[0]||(s[0]=r("div",{class:"text-caption"},"إجمالي المبالغ",-1)),r("div",q,u(n(a.data.totalAmount)),1)]),_:1})]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:e(()=>[t(g,{variant:"tonal"},{default:e(()=>[t(b,null,{default:e(()=>[s[1]||(s[1]=r("div",{class:"text-caption"},"إجمالي المدفوع",-1)),r("div",E,u(n(a.data.totalPaid)),1)]),_:1})]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:e(()=>[t(g,{variant:"tonal"},{default:e(()=>[t(b,null,{default:e(()=>[s[2]||(s[2]=r("div",{class:"text-caption"},"إجمالي الخصومات",-1)),r("div",F,u(n(a.data.totalDiscount)),1)]),_:1})]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:e(()=>[t(g,{variant:"tonal"},{default:e(()=>[t(b,null,{default:e(()=>[s[3]||(s[3]=r("div",{class:"text-caption"},"المتبقي",-1)),r("div",G,u(n(a.data.totalRemaining)),1)]),_:1})]),_:1})]),_:1})]),_:1}),t(A,{class:"my-4"}),t(h,null,{default:e(()=>[t(i,{cols:"12",md:"3"},{default:e(()=>[t(x,{type:"success",variant:"tonal"},{default:e(()=>[s[4]||(s[4]=r("div",{class:"text-caption"},"عدد المدفوعة",-1)),r("div",H,u(n(a.data.paidCount)),1)]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:e(()=>[t(x,{type:"warning",variant:"tonal"},{default:e(()=>[s[5]||(s[5]=r("div",{class:"text-caption"},"عدد المتبقية",-1)),r("div",K,u(n(a.data.remainingCount)),1)]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:e(()=>[t(x,{type:"info",variant:"tonal"},{default:e(()=>[s[6]||(s[6]=r("div",{class:"text-caption"},"عدد بخصم",-1)),r("div",Q,u(n(a.data.discountCount)),1)]),_:1})]),_:1}),t(i,{cols:"12",md:"3"},{default:e(()=>[t(x,{color:"primary",variant:"tonal"},{default:e(()=>[s[7]||(s[7]=r("div",{class:"text-caption"},"إجمالي الفواتير",-1)),r("div",X,u(n(a.data.totalCount)),1)]),_:1})]),_:1})]),_:1}),t(h,{class:"mt-4"},{default:e(()=>[t(i,{cols:"12"},{default:e(()=>[r("div",Z,[s[8]||(s[8]=r("span",{class:"me-2"},"نسبة المدفوع",-1)),r("strong",null,u(m.value.toFixed(1))+"%",1)]),t(L,{"model-value":m.value,color:"success",height:"10",rounded:""},null,8,["model-value"])]),_:1})]),_:1})]),_:1})]),_:1})]))}},tt={components:{ReportCharts:$},data(){return{keyName:"show-reservation-payments",results:JSON.parse(localStorage.getItem("user")),breadcrumbItems:[{title:"الرئيسية",disabled:!1,to:"/teacher/index"},{title:"فواتير العربون",disabled:!0}],loading:!1,progress:0,studyYears:[],yearsLoading:!1,table:{totalItems:0,Data:[],actions:[],loading:!1,headers:[{title:"#",type:"strong",sortable:!1,key:"num"},{title:"اسم الطالب",type:"strong",sortable:!0,key:"studentName"},{title:"اسم الكورس",type:"strong",sortable:!0,key:"courseName"},{title:"المبلغ",type:"number",sortable:!0,key:"amount"},{title:"الحالة",type:"status",sortable:!0,key:"status"},{title:"تاريخ الدفع",type:"date",sortable:!0,key:"paidAt"},{title:"تفاصيل",type:"link",sortable:!1,key:"reportText"}],tableSettings:{options:{page:1,limit:10,sortBy:"",search:null,study_year:JSON.parse(localStorage.getItem("studyYear")),sort:JSON.stringify({key:"paidAt",order:"desc"})}}},report:null,fetchedStudyYear:null,reportChartsData:null,alert:{open:!1,message:null,type:"success"}}},created(){const a=JSON.parse(localStorage.getItem(this.keyName));a&&(this.table.tableSettings=a),this.loadAcademicYears()},methods:{numberWithComma:z,async loadAcademicYears(){var a,o,n,m;try{this.yearsLoading=!0;const l=await V.getAcademicYears(),s=((a=l==null?void 0:l.data)==null?void 0:a.data)||{},f=Array.isArray(s.years)?s.years:[],p=s.active||null;this.studyYears=f.map(d=>({label:d.year,value:d.year})),(m=(n=(o=this.table)==null?void 0:o.tableSettings)==null?void 0:n.options)!=null&&m.study_year||(this.table.tableSettings.options.study_year=(p==null?void 0:p.year)||null),this.getDataAxios()}catch{this.getDataAxios()}finally{this.yearsLoading=!1}},reload(){localStorage.removeItem(this.keyName),this.table.tableSettings.options={page:1,limit:10,sortBy:"",search:null,study_year:JSON.parse(localStorage.getItem("studyYear")),sort:JSON.stringify({key:"paidAt",order:"desc"})},this.getDataAxios()},updateTableOptions(a){this.table.tableSettings.options={...this.table.tableSettings.options,...a,search:a.search?a.search:null},this.getDataAxios()},async getDataAxios(){var o,n,m,l,s,f,p;this.progress=0,this.loading=!0;const a=setInterval(()=>{this.progress<90&&(this.progress+=10)},100);try{localStorage.setItem(this.keyName,JSON.stringify(this.table.tableSettings));const d=await V.getReservationPayments(this.table.tableSettings),c=((o=d==null?void 0:d.data)==null?void 0:o.data)||{},C=c.items||[];this.report=c.report||null;const v=((n=this.report)==null?void 0:n.counts)||{},_=((m=this.report)==null?void 0:m.totals)||{};this.fetchedStudyYear=c.studyYear||((l=this.report)==null?void 0:l.studyYear)||this.table.tableSettings.options.study_year,this.reportChartsData={totalAmount:Number(_.totalAmount||0),totalPaid:Number(_.totalPaidAmount||0),totalDiscount:Number(_.discountAmount||0),totalRemaining:Number(_.remainingAmount||0),totalCount:Number((v.totalPaid||0)+(v.totalPending||0)),paidCount:Number(v.totalPaid||0),remainingCount:Number(v.totalPending||0),discountCount:0},this.table.Data=C.map((y,O)=>({num:(this.table.tableSettings.options.page-1)*this.table.tableSettings.options.limit+O+1,studentName:y.studentName,courseName:y.courseName,amount:y.amount,status:y.status,paidAt:y.paidAt,reportText:"عرض",reportLink:y.reportLink})),this.table.totalItems=((s=c==null?void 0:c.pagination)==null?void 0:s.total)||C.length}catch(d){this.showAlert("error",((p=(f=d==null?void 0:d.response)==null?void 0:f.data)==null?void 0:p.message)||"حدث خطأ أثناء جلب البيانات")}finally{clearInterval(a),this.progress=100,setTimeout(()=>{this.loading=!1,this.progress=0},300)}},goToDetails(a){const o=(a==null?void 0:a.reportLink)||(a==null?void 0:a.report)&&a.report.to||null;o&&this.$router.push(o)},showAlert(a,o){Object.assign(this.alert,{type:a,message:o,open:!0})}}};function et(a,o,n,m,l,s){const f=T,p=J("ReportCharts"),d=P;return N(),I("div",null,[t(f,{items:l.breadcrumbItems},null,8,["items"]),o[4]||(o[4]=r("br",null,null,-1)),l.reportChartsData?(N(),B(p,{key:0,data:l.reportChartsData,studyYear:l.fetchedStudyYear||l.report&&l.report.studyYear},null,8,["data","studyYear"])):R("",!0),t(g,{class:"my-4 filter-card",elevation:"3",rounded:"lg"},{default:e(()=>[t(S,{class:"d-flex align-center py-4 px-6"},{default:e(()=>[t(Y,{icon:"mdi mdi-filter-outline",color:"primary",class:"me-2",size:"24"}),o[2]||(o[2]=r("h3",{class:"text-h5 font-weight-bold"},"تصفية",-1))]),_:1}),t(A),t(k,null,{default:e(()=>[t(h,{style:{"padding-block":"10px"}},{default:e(()=>[t(i,{cols:"12",md:"4"},{default:e(()=>[t(M,{modelValue:l.table.tableSettings.options.study_year,"onUpdate:modelValue":[o[0]||(o[0]=c=>l.table.tableSettings.options.study_year=c),s.getDataAxios],items:l.studyYears,"item-title":"label","item-value":"value",label:"السنة الدراسية",variant:"outlined",loading:l.yearsLoading},null,8,["modelValue","items","loading","onUpdate:modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(g,{class:"my-4 data-table-card",elevation:"3",rounded:"lg"},{default:e(()=>[t(S,{class:"py-4 px-6"},{default:e(()=>[t(h,{class:"align-center"},{default:e(()=>[t(i,{cols:"auto"},{default:e(()=>[t(U,{color:"primary",onClick:o[1]||(o[1]=c=>s.reload()),icon:"ri-refresh-line",variant:"tonal",rounded:"circle",size:"small",class:"rotate-on-hover"})]),_:1}),t(i,null,{default:e(()=>o[3]||(o[3]=[r("h3",{class:"text-h5 font-weight-bold text-center"},"فواتير عربون الحجوزات",-1)])),_:1}),t(i,{cols:"auto",class:"d-flex gap-2"},{default:e(()=>[t(W,{color:"primary",variant:"elevated",class:"font-weight-medium"},{default:e(()=>[D(u(s.numberWithComma(l.table.totalItems))+" عدد السجلات ",1)]),_:1})]),_:1})]),_:1})]),_:1}),t(A),t(k,null,{default:e(()=>[t(d,{headers:l.table.headers,items:l.table.Data,actions:l.table.actions,loading:l.table.loading,totalItems:l.table.totalItems,tableOptions:l.table.tableSettings.options,onUpdateTableOptions:s.updateTableOptions,onShowItem:s.goToDetails,class:"reservation-payments-table"},null,8,["headers","items","actions","loading","totalItems","tableOptions","onUpdateTableOptions","onShowItem"])]),_:1})]),_:1})])}const St=j(tt,[["render",et]]);export{St as default};
