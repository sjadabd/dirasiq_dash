import{_ as w}from"./BaseAlert-DhiW1pkC.js";import{_ as L}from"./ConfirmDangerDialog-BZm2XFtt.js";import{_ as U}from"./SmartTable-CLkcAuzq.js";import{_ as N}from"./AppBreadcrumbs-CL1Mn0e1.js";import c from"./teacher_api-e-hm75z5.js";import{_ as O}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as y,a as _,c as S,b as F}from"./VCard-DJFVzfaq.js";import{V as B}from"./VDialog-BARV40Gk.js";import{c as K,b as s,f as J,n as z,e as o,o as D,d as b,p as x,v as f,s as p,t as k,V as j,a_ as V}from"./index-Cq5mHdd1.js";import{V as g}from"./VDivider-BttVlJLf.js";import{V as C,a as d}from"./VRow-C1y3VVie.js";import{V as h}from"./VSelect-D56nOm3K.js";import{V as M}from"./VChip-CKn48zu6.js";import{V as A}from"./VCardText-DbIVWSue.js";import"./number-DRUmGIrN.js";import"./VDataTable-BV3QB1La.js";import"./VTable-BnE0OQoQ.js";import"./filter-D2UYLjkj.js";import"./VTooltip-CPeNRJkP.js";import"./axios-lwY36-Bu.js";import"./VAvatar-B2hOBT8r.js";import"./VImg-BgkOcihp.js";import"./VList-BLaYBSlW.js";const T="teacher_exams_cache",E=5*60*1e3,H={name:"teacher-exams-manage",data(){return{breadcrumbs:[{title:"الرئيسية",disabled:!1,to:"/teacher/index"},{title:"الامتحانات والدرجات",disabled:!0}],filters:{type:null},typeItems:[{title:"يومي",value:"daily"},{title:"شهري",value:"monthly"}],table:{headers:[{title:"#",type:"strong",sortable:!1,key:"num"},{title:"العنوان/الوصف",type:"link",sortable:!1,key:"title"},{title:"النوع",type:"strong",sortable:!0,key:"exam_type_label"},{title:"التاريخ",type:"strong",sortable:!0,key:"exam_date"},{title:"الدرجة القصوى",type:"strong",sortable:!1,key:"max_score"},{title:"الجلسات",type:"strong",sortable:!1,key:"sessions_label"},{title:"إجراءات",type:"strong",sortable:!1,key:"actions"}],actions:["تعديل","حذف"],items:[],total:0,loading:!1,options:{page:1,limit:10,search:null}},dialog:{open:!1,loading:!1,mode:"create"},form:{id:null,course_id:null,subject_id:null,sessionIds:[],exam_date:"",exam_type:"daily",max_score:20,description:"",notes:""},confirm:{open:!1,id:null,title:"تأكيد الحذف",buttonText:"حذف",messages:["سيتم حذف الامتحان نهائياً"]},alert:{open:!1,type:"success",message:""},courseItems:[],subjectItems:[],sessionItems:[],coursesLoading:!1,subjectsLoading:!1,sessionsLoading:!1,reloading:!1,cacheStatus:{isValid:!1,age:""}}},created(){this.loadCourseNames(),this.loadFromCache()},methods:{showAlert(l,e){Object.assign(this.alert,{type:l,message:e,open:!0})},examTypeLabel(l){return l==="monthly"?"شهري":"يومي"},getCacheKey(){const l=JSON.stringify(this.filters),e=JSON.stringify(this.table.options);return`${T}_${l}_${e}`},saveToCache(l){try{const e={data:l,timestamp:Date.now(),filters:this.filters,options:this.table.options};sessionStorage.setItem(this.getCacheKey(),JSON.stringify(e)),this.updateCacheStatus()}catch(e){console.error("Failed to save cache:",e)}},loadFromCache(){try{const l=sessionStorage.getItem(this.getCacheKey());if(!l)return!1;const e=JSON.parse(l);return Date.now()-e.timestamp>E?(sessionStorage.removeItem(this.getCacheKey()),!1):(this.table.items=e.data.items,this.table.total=e.data.total,this.updateCacheStatus(),!0)}catch(l){return console.error("Failed to load cache:",l),!1}},updateCacheStatus(){try{const l=sessionStorage.getItem(this.getCacheKey());if(!l){this.cacheStatus={isValid:!1,age:""};return}const e=JSON.parse(l),a=Date.now()-e.timestamp,r=Math.floor(a/6e4),t=Math.floor(a%6e4/1e3);this.cacheStatus={isValid:a<=E,age:r>0?`${r} دقيقة`:`${t} ثانية`}}catch{this.cacheStatus={isValid:!1,age:""}}},clearCache(){try{Object.keys(sessionStorage).forEach(e=>{e.startsWith(T)&&sessionStorage.removeItem(e)}),this.cacheStatus={isValid:!1,age:""},this.showAlert("success","تم مسح الكاش بنجاح"),this.getExams()}catch{this.showAlert("error","فشل مسح الكاش")}},async reload(){this.reloading=!0;try{sessionStorage.removeItem(this.getCacheKey()),this.cacheStatus={isValid:!1,age:""},await this.getExams()}catch{this.showAlert("error","فشل تحديث البيانات")}finally{this.reloading=!1}},async getExams(){var l,e,a,r;if(!this.loadFromCache())try{this.table.loading=!0;const t={page:this.table.options.page,limit:this.table.options.limit};this.filters.type&&(t.type=this.filters.type);const n=await c.listExams(t),m=((l=n==null?void 0:n.data)==null?void 0:l.data)||[],I=((e=n==null?void 0:n.data)==null?void 0:e.pagination)||{total:m.length};this.table.total=I.total||0,this.table.items=m.map((u,v)=>({...u,num:(this.table.options.page-1)*this.table.options.limit+(v+1),title:u.description||`امتحان ${this.examTypeLabel(u.exam_type)}`,exam_type_label:this.examTypeLabel(u.exam_type),sessions_label:Array.isArray(u.sessions)&&u.sessions.length?u.sessions.map(i=>`${i.title||""}${i.start_time&&i.end_time?` (${i.start_time} - ${i.end_time})`:""}`).join("، "):"—"})),this.saveToCache({items:this.table.items,total:this.table.total})}catch(t){this.showAlert("error",((r=(a=t==null?void 0:t.response)==null?void 0:a.data)==null?void 0:r.message)||"فشل جلب الامتحانات")}finally{this.table.loading=!1}},updateOptions(l){this.table.options=l,this.getExams()},openCreateDialog(){this.dialog.mode="create",this.resetForm(),this.dialog.open=!0},openEditDialog(l){var e,a;this.dialog.mode="edit",this.form={id:l.id,course_id:l.course_id||((e=l.course)==null?void 0:e.id)||null,subject_id:l.subject_id||((a=l.subject)==null?void 0:a.id)||null,sessionIds:Array.isArray(l.sessions)?l.sessions.map(r=>r.id):[],exam_date:l.exam_date?l.exam_date.substring(0,16):"",exam_type:l.exam_type||"daily",max_score:l.max_score??20,description:l.description||"",notes:l.notes||""},this.dialog.open=!0},resetForm(){this.form={id:null,course_id:null,subject_id:null,sessionIds:[],exam_date:"",exam_type:"daily",max_score:20,description:"",notes:""}},async submitForm(){var l,e;try{this.dialog.loading=!0;const a=this.form,r={course_id:a.course_id,subject_id:a.subject_id,sessionIds:a.sessionIds&&a.sessionIds.length?a.sessionIds:void 0,session_id:!a.sessionIds||!a.sessionIds.length?null:void 0,exam_date:a.exam_date?new Date(a.exam_date).toISOString():null,exam_type:a.exam_type,max_score:a.max_score,description:a.description||null,notes:a.notes||null};this.dialog.mode==="edit"&&a.id?await c.updateExam(a.id,r):await c.createExam(r),this.dialog.open=!1,this.showAlert("success","تم حفظ الامتحان بنجاح"),this.clearCache()}catch(a){this.showAlert("error",((e=(l=a==null?void 0:a.response)==null?void 0:l.data)==null?void 0:e.message)||"فشل حفظ الامتحان")}finally{this.dialog.loading=!1}},confirmDelete(l){this.confirm={open:!0,id:l.id,title:"تأكيد الحذف",buttonText:"حذف",messages:["سيتم حذف الامتحان نهائياً"]}},async doDelete(){var l,e;try{if(!this.confirm.id)return;await c.deleteExam(this.confirm.id),this.showAlert("success","تم حذف الامتحان"),this.clearCache()}catch(a){this.showAlert("error",((e=(l=a==null?void 0:a.response)==null?void 0:l.data)==null?void 0:e.message)||"فشل حذف الامتحان")}finally{this.confirm={...this.confirm,open:!1,id:null}}},goToDetails(l){this.$router.push({name:"teacher-exams-exam-details",query:{id:l.id}})},async loadCourseNames(){var l,e,a;try{this.coursesLoading=!0,this.subjectsLoading=!0,this.sessionsLoading=!0;const[r,t,n]=await Promise.all([c.getCourseNames(),c.getAllSubjects(),c.getSessionNames()]);this.courseItems=(((l=r==null?void 0:r.data)==null?void 0:l.data)||[]).map(m=>({text:m.name,value:m.id})),this.subjectItems=(((e=t==null?void 0:t.data)==null?void 0:e.data)||[]).map(m=>({text:m.name,value:m.id})),this.sessionItems=(((a=n==null?void 0:n.data)==null?void 0:a.data)||[]).map(m=>({text:m.title||m.name||m.label,value:m.id}))}catch{}finally{this.coursesLoading=!1,this.subjectsLoading=!1,this.sessionsLoading=!1}}}},R={class:"text-h6"};function q(l,e,a,r,t,n){const m=N,I=U,u=L,v=w;return D(),K("div",null,[s(m,{items:t.breadcrumbs},null,8,["items"]),s(y,{class:"my-4 operations-card",elevation:"3",rounded:"lg"},{default:o(()=>[s(_,{class:"d-flex align-center py-4 px-6"},{default:o(()=>[s(x,{icon:"mdi-cog-outline",color:"primary",class:"me-2",size:"24"}),e[14]||(e[14]=b("h3",{class:"text-h5 font-weight-bold"},"العمليات",-1))]),_:1}),s(g),s(S,null,{default:o(()=>[s(C,{class:"align-center justify-start pa-2"},{default:o(()=>[s(f,{color:"primary",class:"ms-3","prepend-icon":"ri-add-line",onClick:n.openCreateDialog},{default:o(()=>e[15]||(e[15]=[p(" إضافة امتحان جديد ")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1}),s(y,{class:"my-4 filter-card",elevation:"3",rounded:"lg"},{default:o(()=>[s(_,{class:"d-flex align-center py-4 px-6"},{default:o(()=>[s(x,{icon:"mdi mdi-filter-outline",color:"primary",class:"me-2",size:"24"}),e[16]||(e[16]=b("h3",{class:"text-h5 font-weight-bold"},"تصفية",-1))]),_:1}),s(g),s(S,null,{default:o(()=>[s(C,{style:{"padding-block":"10px"}},{default:o(()=>[s(d,{cols:"12",md:"3"},{default:o(()=>[s(h,{modelValue:t.filters.type,"onUpdate:modelValue":[e[0]||(e[0]=i=>t.filters.type=i),n.getExams],items:t.typeItems,"item-title":"title","item-value":"value",label:"نوع الامتحان",style:{"max-inline-size":"200px"},density:"comfortable",clearable:""},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),s(y,{class:"my-4"},{default:o(()=>[s(_,{class:"py-4 px-6"},{default:o(()=>[s(C,{class:"align-center"},{default:o(()=>[s(d,{cols:"auto"},{default:o(()=>[s(f,{color:"primary",onClick:n.reload,icon:"ri-refresh-line",variant:"tonal",rounded:"circle",size:"small",class:"rotate-on-hover",loading:t.reloading},null,8,["onClick","loading"])]),_:1}),s(d,null,{default:o(()=>e[17]||(e[17]=[b("h3",{class:"text-h5 font-weight-bold text-center"},"الامتحانات والدرجات",-1)])),_:1}),s(d,{cols:"auto"},{default:o(()=>[s(M,{color:"primary",variant:"elevated",class:"font-weight-medium"},{default:o(()=>[p(k(Number(t.table.total).toLocaleString())+" عدد السجلات ",1)]),_:1})]),_:1})]),_:1})]),_:1}),s(g),s(A,null,{default:o(()=>[s(I,{headers:t.table.headers,items:t.table.items,actions:t.table.actions,loading:t.table.loading,totalItems:t.table.total,tableOptions:t.table.options,onUpdateTableOptions:n.updateOptions,onEditItem:n.openEditDialog,onDeleteItem:n.confirmDelete,onShowItem:n.goToDetails},null,8,["headers","items","actions","loading","totalItems","tableOptions","onUpdateTableOptions","onEditItem","onDeleteItem","onShowItem"])]),_:1})]),_:1}),s(B,{modelValue:t.dialog.open,"onUpdate:modelValue":e[11]||(e[11]=i=>t.dialog.open=i),"max-width":"700"},{default:o(()=>[s(y,null,{default:o(()=>[s(_,{class:"d-flex align-center"},{default:o(()=>[s(x,{class:"me-2"},{default:o(()=>e[18]||(e[18]=[p("ri-edit-2-line")])),_:1}),b("span",R,k(t.dialog.mode==="create"?"إنشاء امتحان":"تعديل امتحان"),1),s(j),s(f,{icon:"",variant:"text",onClick:e[1]||(e[1]=i=>t.dialog.open=!1)},{default:o(()=>[s(x,null,{default:o(()=>e[19]||(e[19]=[p("ri-close-line")])),_:1})]),_:1})]),_:1}),s(g),s(A,null,{default:o(()=>[s(C,null,{default:o(()=>[s(d,{cols:"12",md:"6"},{default:o(()=>[s(h,{modelValue:t.form.course_id,"onUpdate:modelValue":e[2]||(e[2]=i=>t.form.course_id=i),items:t.courseItems,"item-title":"text","item-value":"value",label:"الدورة",loading:t.coursesLoading},null,8,["modelValue","items","loading"])]),_:1}),s(d,{cols:"12",md:"6"},{default:o(()=>[s(h,{modelValue:t.form.subject_id,"onUpdate:modelValue":e[3]||(e[3]=i=>t.form.subject_id=i),items:t.subjectItems,"item-title":"text","item-value":"value",label:"المادة",loading:t.subjectsLoading},null,8,["modelValue","items","loading"])]),_:1}),s(d,{cols:"12",md:"12"},{default:o(()=>[s(h,{modelValue:t.form.sessionIds,"onUpdate:modelValue":e[4]||(e[4]=i=>t.form.sessionIds=i),items:t.sessionItems,"item-title":"text","item-value":"value",label:"الجلسات (اختياري متعدد)",chips:"",multiple:"",clearable:"",loading:t.sessionsLoading},null,8,["modelValue","items","loading"])]),_:1}),s(d,{cols:"12",md:"6"},{default:o(()=>[s(V,{modelValue:t.form.exam_date,"onUpdate:modelValue":e[5]||(e[5]=i=>t.form.exam_date=i),type:"datetime-local",label:"تاريخ ووقت الامتحان"},null,8,["modelValue"])]),_:1}),s(d,{cols:"12",md:"6"},{default:o(()=>[s(h,{modelValue:t.form.exam_type,"onUpdate:modelValue":e[6]||(e[6]=i=>t.form.exam_type=i),items:t.typeItems,"item-title":"title","item-value":"value",label:"نوع الامتحان"},null,8,["modelValue","items"])]),_:1}),s(d,{cols:"12",md:"6"},{default:o(()=>[s(V,{modelValue:t.form.max_score,"onUpdate:modelValue":e[7]||(e[7]=i=>t.form.max_score=i),modelModifiers:{number:!0},type:"number",label:"الدرجة القصوى"},null,8,["modelValue"])]),_:1}),s(d,{cols:"12"},{default:o(()=>[s(V,{modelValue:t.form.description,"onUpdate:modelValue":e[8]||(e[8]=i=>t.form.description=i),label:"الوصف (اختياري)"},null,8,["modelValue"])]),_:1}),s(d,{cols:"12"},{default:o(()=>[s(V,{modelValue:t.form.notes,"onUpdate:modelValue":e[9]||(e[9]=i=>t.form.notes=i),label:"ملاحظات (اختياري)"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),s(g),s(F,null,{default:o(()=>[s(j),s(f,{variant:"text",onClick:e[10]||(e[10]=i=>t.dialog.open=!1)},{default:o(()=>e[20]||(e[20]=[p("إلغاء")])),_:1}),s(f,{color:"primary",loading:t.dialog.loading,onClick:n.submitForm},{default:o(()=>e[21]||(e[21]=[p("حفظ")])),_:1},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(u,{modelValue:t.confirm.open,"onUpdate:modelValue":e[12]||(e[12]=i=>t.confirm.open=i),title:t.confirm.title,messages:t.confirm.messages,confirmButtonText:t.confirm.buttonText,onConfirm:n.doDelete},null,8,["modelValue","title","messages","confirmButtonText","onConfirm"]),t.alert.open?(D(),J(v,{key:0,modelValue:t.alert.open,"onUpdate:modelValue":e[13]||(e[13]=i=>t.alert.open=i),type:t.alert.type,message:t.alert.message,closable:!0,"close-text":"موافق"},null,8,["modelValue","type","message"])):z("",!0)])}const ge=O(H,[["render",q],["__scopeId","data-v-8dc8c9b2"]]);export{ge as default};
