const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/exceljs.min-Bx1Ih4Qk.js","assets/_commonjsHelpers-Cpj98o6Y.js","assets/jspdf.es.min-Oc0kvGEn.js","assets/index-B-ugD3CV.js","assets/index-C7I02ZE_.css"])))=>i.map(i=>d[i]);
import{c as J,b as e,f as A,x as S,e as s,J as O,a as M,o as k,d as c,k as y,A as Y,q as b,V as q,t as D}from"./index-B-ugD3CV.js";import{_ as G}from"./BaseAlert-DoKdMpQw.js";import{_ as Q}from"./AppDateTimePicker-CMgdfasL.js";import{_ as X}from"./AppBreadcrumbs-CGDMHBEQ.js";import{T as U}from"./teacher_api-B0aW0cjW.js";import{m as K}from"./vue3-apexcharts-B17McH0x.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as x,b as V,a as H}from"./VCard-q0Xiefi9.js";import{V as L}from"./VDivider-0jTJqE-a.js";import{V as B,a as v}from"./VRow-_6XExfSs.js";import{V as $}from"./VSelect-BF-InOJ4.js";import{V as _}from"./VCardText-Dz05REAW.js";import{V as R}from"./VChip-CqnLjyZp.js";import"./VDialog-tPozjQ9z.js";import"./axios-D6DdSkOE.js";import"./VAvatar-BSxHYKKi.js";import"./VImg-CPt2aJgH.js";import"./VList-Dy5AF_mx.js";const ee={components:{apexchart:K},data(){return{results:JSON.parse(localStorage.getItem("user")),breadcrumbItems:[{title:"الرئيسية",disabled:!1,to:"/teacher/index"},{title:"التقارير المالية",disabled:!0}],loading:!1,progress:0,alert:{open:!1,type:"success",message:""},studyYears:[],yearsLoading:!1,filters:{studyYear:"",from:null,to:null},invoices:{student:{totalDue:0,totalDiscount:0,totalPaid:0,totalRemaining:0},reservation:{totalDue:0,totalDiscount:0,totalPaid:0,totalRemaining:0}},expenses:{total:0},summary:{totalPaidIncome:0,totalDueIncome:0,netProfitPaidBasis:0,netProfitDueBasis:0},previousData:{totalPaidIncome:0,totalDueIncome:0,expenses:0,netProfitPaidBasis:0},animatedPaidIncome:"0",animatedDueIncome:"0",animatedExpenses:"0",animatedNetProfit:"0"}},computed:{discountsTotal(){return Number(this.invoices.student.totalDiscount||0)+Number(this.invoices.reservation.totalDiscount||0)},barChartSeries(){return[{name:"الدخل المقبوض",data:[Number(this.summary.totalPaidIncome||0)]},{name:"المستحقات",data:[Number(this.summary.totalDueIncome||0)]},{name:"المصروفات",data:[Number(this.expenses.total||0)]},{name:"صافي الربح (مقبوض)",data:[Number(this.summary.netProfitPaidBasis||0)]},{name:"صافي الربح (استحقاق)",data:[Number(this.summary.netProfitDueBasis||0)]}]},barChartOptions(){return{chart:{type:"bar",toolbar:{show:!0},animations:{enabled:!0,speed:800}},plotOptions:{bar:{horizontal:!1,columnWidth:"55%",borderRadius:8}},dataLabels:{enabled:!1},stroke:{show:!0,width:2,colors:["transparent"]},xaxis:{categories:["المقارنة المالية"]},yaxis:{title:{text:"المبلغ"}},fill:{opacity:1},tooltip:{y:{formatter:i=>this.n(i)}},colors:["#1976D2","#0288D1","#D32F2F","#388E3C","#689F38"]}},pieChartSeries(){const i=Number(this.invoices.student.totalDiscount||0),t=Number(this.invoices.reservation.totalDiscount||0),o=Number(this.expenses.total||0)-i-t;return[i,t,Math.max(0,o)]},pieChartOptions(){return{chart:{type:"donut",animations:{enabled:!0,speed:800}},labels:["خصومات الطلاب","خصومات الحجوزات","مصروفات أخرى"],colors:["#FF6384","#36A2EB","#FFCE56"],legend:{position:"bottom"},dataLabels:{enabled:!0},tooltip:{y:{formatter:i=>this.n(i)}}}},lineChartPaidSeries(){return[{name:"الدخل المقبوض",data:[Number(this.summary.totalPaidIncome||0)]},{name:"المصروفات",data:[Number(this.expenses.total||0)]},{name:"صافي الربح",data:[Number(this.summary.netProfitPaidBasis||0)]}]},lineChartPaidOptions(){return{chart:{type:"line",toolbar:{show:!1},animations:{enabled:!0,speed:800}},stroke:{curve:"smooth",width:3},xaxis:{categories:["الفترة الحالية"]},colors:["#1976D2","#D32F2F","#388E3C"],markers:{size:6},tooltip:{y:{formatter:i=>this.n(i)}}}},lineChartDueSeries(){return[{name:"المستحقات",data:[Number(this.summary.totalDueIncome||0)]},{name:"الخصومات",data:[this.discountsTotal]},{name:"المصروفات",data:[Number(this.expenses.total||0)]},{name:"صافي الربح",data:[Number(this.summary.netProfitDueBasis||0)]}]},lineChartDueOptions(){return{chart:{type:"line",toolbar:{show:!1},animations:{enabled:!0,speed:800}},stroke:{curve:"smooth",width:3},xaxis:{categories:["الفترة الحالية"]},colors:["#0288D1","#FB8C00","#D32F2F","#689F38"],markers:{size:6},tooltip:{y:{formatter:i=>this.n(i)}}}}},created(){this.loadAcademicYears()},mounted(){this.fetchReport()},methods:{n(i){return Number(i||0).toLocaleString("en-IQ")},showAlert(i,t){Object.assign(this.alert,{open:!0,type:i,message:t})},calculateChange(i,t){if(!t||t===0)return"+0%";const o=(i-t)/t*100;return`${o>=0?"+":""}${o.toFixed(1)}%`},animateValue(i,t,o,n){const a=performance.now(),l=r=>{const f=r-a,h=Math.min(f/o,1),p=i+(t-i)*h;n(Math.floor(p))};requestAnimationFrame(function r(f){l(f),performance.now()-a<o&&requestAnimationFrame(r)})},async exportToExcel(){try{const{default:i}=await O(async()=>{const{default:C}=await import("./exceljs.min-Bx1Ih4Qk.js").then(E=>E.e);return{default:C}},__vite__mapDeps([0,1])),t=new i.Workbook,o=t.addWorksheet("التقرير المالي"),n="0B2545",a="10B981",l="FB8C00",r="D32F2F";o.columns=[{header:"البند",key:"label",width:28},{header:"القيمة",key:"value",width:22},{header:"ملاحظات",key:"note",width:28},{header:"",key:"c3",width:4},{header:"",key:"c4",width:4}],o.mergeCells("A1:E1");const f=o.getCell("A1");f.value="التقرير المالي للمعلم",f.alignment={horizontal:"center",vertical:"middle"},f.font={size:18,bold:!0,color:{argb:"FFFFFFFF"}},f.fill={type:"pattern",pattern:"solid",fgColor:{argb:n}},o.getRow(1).height=28,o.mergeCells("A2:E2");const h=o.getCell("A2"),u=`التاريخ: ${new Date().toISOString().slice(0,10)} | السنة الدراسية: ${this.filters.studyYear||"الكل"} | من: ${this.filters.from||"-"} | إلى: ${this.filters.to||"-"}`;h.value=u,h.alignment={horizontal:"center",vertical:"middle"},h.font={size:11,color:{argb:"FF444444"}},o.getRow(2).height=20;const I=(C,E,T)=>{o.mergeCells(`A${C}:E${C}`);const F=o.getCell(`A${C}`);F.value=E,F.font={bold:!0,color:{argb:"FFFFFFFF"}},F.alignment={horizontal:"right",vertical:"middle"},F.fill={type:"pattern",pattern:"solid",fgColor:{argb:T}}},m=(C,E,T,F)=>{const N=o.addRow({label:C,value:E,note:T});N.getCell("value").numFmt="#,##0",N.alignment={vertical:"middle"},F&&(N.getCell("value").font={color:{argb:F}}),N.eachCell(W=>{W.border={top:{style:"thin",color:{argb:"FFE0E0E0"}},bottom:{style:"thin",color:{argb:"FFE0E0E0"}}}})};let d=4;I(d++,"فواتير الطلاب",n),m("إجمالي المستحق قبل الخصم",this.invoices.student.totalDue||0,"",void 0),m("إجمالي الخصومات",this.invoices.student.totalDiscount||0,"",l),m("إجمالي المدفوع",this.invoices.student.totalPaid||0,"",a),m("إجمالي المتبقي",this.invoices.student.totalRemaining||0,"",r),d+=1,I(d++,"فواتير العربون",n),m("إجمالي المستحق قبل الخصم",this.invoices.reservation.totalDue||0,"",void 0),m("إجمالي الخصومات",this.invoices.reservation.totalDiscount||0,"",l),m("إجمالي المدفوع",this.invoices.reservation.totalPaid||0,"",a),m("إجمالي المتبقي",this.invoices.reservation.totalRemaining||0,"",r),d+=1,I(d++,"المصروفات",n),m("إجمالي المصروفات",this.expenses.total||0,"",r),d+=1,I(d++,"الملخص",n),m("الدخل المقبوض",this.summary.totalPaidIncome||0,"",a),m("الدخل المستحق",this.summary.totalDueIncome||0,"",void 0),m("صافي الربح (مقبوض)",this.summary.netProfitPaidBasis||0,"",a),m("صافي الربح (استحقاق)",this.summary.netProfitDueBasis||0,"",a),o.views=[{state:"frozen",ySplit:3}];const w=await t.xlsx.writeBuffer(),z=new Blob([w],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),j=`financial_report_${new Date().toISOString().slice(0,10)}.xlsx`,P=document.createElement("a");P.href=URL.createObjectURL(z),P.download=j,document.body.appendChild(P),P.click(),document.body.removeChild(P)}catch(i){this.showAlert("error","تعذر إنشاء ملف Excel، يرجى التأكد من توفر المكتبة ExcelJS"),console.error(i)}},updateAnimatedValues(){this.animateValue(0,this.summary.totalPaidIncome,1e3,i=>{this.animatedPaidIncome=this.n(i),this.animateValue(0,this.summary.totalDueIncome,1e3,t=>{this.animatedDueIncome=this.n(t)}),this.animateValue(0,this.expenses.total,1e3,t=>{this.animatedExpenses=this.n(t)}),this.animateValue(0,this.summary.netProfitPaidBasis,1e3,t=>{this.animatedNetProfit=this.n(t)})})},async loadAcademicYears(){var i;try{this.yearsLoading=!0;const t=await U.getAcademicYears(),o=((i=t==null?void 0:t.data)==null?void 0:i.data)||{},n=Array.isArray(o.years)?o.years:[],a=o.active||null;this.studyYears=n.map(l=>({label:l.year,value:l.year})),this.filters.studyYear||(this.filters.studyYear=(a==null?void 0:a.year)||"")}catch(t){console.error("Error loading academic years:",t)}finally{this.yearsLoading=!1}},async fetchReport(){var i,t;try{this.loading=!0;const o={studyYear:this.filters.studyYear||void 0,from:this.filters.from||void 0,to:this.filters.to||void 0};this.previousData={totalPaidIncome:this.summary.totalPaidIncome,totalDueIncome:this.summary.totalDueIncome,expenses:this.expenses.total,netProfitPaidBasis:this.summary.netProfitPaidBasis};const{data:n}=await U.getFinancialReport(o),a=(n==null?void 0:n.data)||{};this.invoices=a.invoices||this.invoices,this.expenses=a.expenses||this.expenses,this.summary=a.summary||this.summary,this.updateAnimatedValues()}catch(o){this.showAlert("error",((t=(i=o==null?void 0:o.response)==null?void 0:i.data)==null?void 0:t.message)||"تعذر جلب التقرير")}finally{this.loading=!1}},applyFilters(){this.fetchReport()},resetFilters(){this.filters={studyYear:this.filters.studyYear||"",from:null,to:null},this.fetchReport()},async exportToPDF(){try{const{default:i}=await O(async()=>{const{default:d}=await import("./html2canvas.esm-CBrSDip1.js");return{default:d}},[]),{jsPDF:t}=await O(async()=>{const{jsPDF:d}=await import("./jspdf.es.min-Oc0kvGEn.js").then(w=>w.j);return{jsPDF:d}},__vite__mapDeps([2,3,4]));await this.$nextTick();const o=this.$refs.printArea,n=o!=null&&o.$el?o.$el:o;if(!n||!(n instanceof HTMLElement)||!document.body.contains(n))return this.showAlert("error","تعذر العثور على محتوى التقرير لطباعته");await new Promise(d=>setTimeout(d,300));const a=await i(n,{scale:2,backgroundColor:"#ffffff",useCORS:!0,logging:!1}),l=a.toDataURL("image/png"),r=new t({orientation:"portrait",unit:"mm",format:"a4"}),f=r.internal.pageSize.getWidth(),h=r.internal.pageSize.getHeight(),p=f-20,u=a.height*p/a.width;let I=10;if(u<=h-20)r.addImage(l,"PNG",10,I,p,u);else{let d=u,w=0;const z=a.width*(h-20)/p;for(;d>0;){const g=document.createElement("canvas");g.width=a.width,g.height=Math.min(z,a.height-w),g.getContext("2d").drawImage(a,0,w,a.width,g.height,0,0,g.width,g.height);const P=g.toDataURL("image/png");w>0&&r.addPage(),r.addImage(P,"PNG",10,10,p,g.height*p/a.width),w+=g.height,d-=g.height*p/a.width}}const m=new Date().toISOString().slice(0,10);r.save(`financial_report_${m}.pdf`)}catch(i){console.error(i),this.showAlert("error","تعذر إنشاء ملف PDF. يرجى تثبيت html2canvas و jspdf")}}}},te={class:"d-flex align-center justify-space-between mb-2"},ae={class:"text-h5 font-weight-bold"},se={class:"d-flex align-center justify-space-between mb-2"},ie={class:"text-h5 font-weight-bold"},oe={class:"d-flex align-center justify-space-between mb-2"},le={class:"text-h5 font-weight-bold"},ne={class:"d-flex align-center justify-space-between mb-2"},re={class:"text-h5 font-weight-bold"};function de(i,t,o,n,a,l){const r=X,f=Q,h=M("apexchart"),p=G;return k(),J("div",null,[e(r,{items:a.breadcrumbItems},null,8,["items"]),e(x,{class:"my-4 operations-card",elevation:"3",rounded:"lg"},{default:s(()=>[e(V,{class:"d-flex align-center py-4 px-6"},{default:s(()=>[e(y,{icon:"mdi-cog-outline",color:"primary",class:"me-2",size:"24"}),t[5]||(t[5]=c("h3",{class:"text-h5 font-weight-bold"},"العمليات",-1))]),_:1}),e(L),e(H,null,{default:s(()=>[e(B,{class:"align-center justify-start pa-2"},{default:s(()=>[e(Y,{color:"primary","prepend-icon":"ri-refresh-line",onClick:l.fetchReport},{default:s(()=>t[6]||(t[6]=[b("تحديث")])),_:1},8,["onClick"]),e(Y,{color:"success","prepend-icon":"ri-file-excel-line",class:"ms-2",onClick:l.exportToExcel},{default:s(()=>t[7]||(t[7]=[b(" تصدير Excel ")])),_:1},8,["onClick"]),e(Y,{color:"error","prepend-icon":"ri-file-pdf-line",class:"ms-2",onClick:l.exportToPDF},{default:s(()=>t[8]||(t[8]=[b(" تصدير PDF ")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1}),e(x,{class:"my-4 filter-card",elevation:"3",rounded:"lg"},{default:s(()=>[e(V,{class:"d-flex align-center py-4 px-6"},{default:s(()=>[e(y,{icon:"mdi mdi-filter-outline",color:"primary",class:"me-2",size:"24"}),t[9]||(t[9]=c("h3",{class:"text-h5 font-weight-bold"},"تصفية",-1))]),_:1}),e(L),e(H,null,{default:s(()=>[e(B,{style:{"padding-block":"10px"}},{default:s(()=>[e(v,{cols:"12",md:"4"},{default:s(()=>[e($,{modelValue:a.filters.studyYear,"onUpdate:modelValue":[t[0]||(t[0]=u=>a.filters.studyYear=u),l.fetchReport],items:a.studyYears,"item-title":"label","item-value":"value",label:"السنة الدراسية",variant:"outlined",loading:a.yearsLoading,density:"comfortable"},null,8,["modelValue","items","onUpdate:modelValue","loading"])]),_:1}),e(v,{cols:"12",md:"4"},{default:s(()=>[e(f,{modelValue:a.filters.from,"onUpdate:modelValue":[t[1]||(t[1]=u=>a.filters.from=u),l.fetchReport],clearable:"",label:"من تاريخ",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(v,{cols:"12",md:"4"},{default:s(()=>[e(f,{modelValue:a.filters.to,"onUpdate:modelValue":[t[2]||(t[2]=u=>a.filters.to=u),l.fetchReport],clearable:"",label:"إلى تاريخ",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(x,{class:"my-4",elevation:"3",rounded:"lg",ref:"printArea"},{default:s(()=>[e(V,{class:"py-4 px-6 d-flex align-center"},{default:s(()=>[e(y,{icon:"ri-bar-chart-2-line",color:"primary",class:"me-2",size:"24"}),t[10]||(t[10]=c("h3",{class:"text-h6 font-weight-bold"},"التقارير المالية",-1)),e(q)]),_:1}),e(L),e(_,null,{default:s(()=>[e(B,{class:"mb-4"},{default:s(()=>[e(v,{cols:"12",md:"3"},{default:s(()=>[e(x,{variant:"tonal",color:"primary",class:"summary-card"},{default:s(()=>[e(_,null,{default:s(()=>[c("div",te,[e(y,{icon:"ri-money-dollar-circle-line",size:"32"}),a.previousData.totalPaidIncome?(k(),A(R,{key:0,color:"success",size:"small"},{default:s(()=>[b(D(l.calculateChange(a.summary.totalPaidIncome,a.previousData.totalPaidIncome)),1)]),_:1})):S("",!0)]),t[11]||(t[11]=c("div",{class:"text-caption text-medium-emphasis mb-1"},"الدخل المقبوض",-1)),c("div",ae,D(a.animatedPaidIncome),1)]),_:1})]),_:1})]),_:1}),e(v,{cols:"12",md:"3"},{default:s(()=>[e(x,{variant:"tonal",color:"info",class:"summary-card"},{default:s(()=>[e(_,null,{default:s(()=>[c("div",se,[e(y,{icon:"ri-calendar-check-line",size:"32"}),a.previousData.totalDueIncome?(k(),A(R,{key:0,color:"success",size:"small"},{default:s(()=>[b(D(l.calculateChange(a.summary.totalDueIncome,a.previousData.totalDueIncome)),1)]),_:1})):S("",!0)]),t[12]||(t[12]=c("div",{class:"text-caption text-medium-emphasis mb-1"},"المستحقات",-1)),c("div",ie,D(a.animatedDueIncome),1)]),_:1})]),_:1})]),_:1}),e(v,{cols:"12",md:"3"},{default:s(()=>[e(x,{variant:"tonal",color:"error",class:"summary-card"},{default:s(()=>[e(_,null,{default:s(()=>[c("div",oe,[e(y,{icon:"ri-shopping-cart-line",size:"32"}),a.previousData.expenses?(k(),A(R,{key:0,color:"warning",size:"small"},{default:s(()=>[b(D(l.calculateChange(a.expenses.total,a.previousData.expenses)),1)]),_:1})):S("",!0)]),t[13]||(t[13]=c("div",{class:"text-caption text-medium-emphasis mb-1"},"المصروفات",-1)),c("div",le,D(a.animatedExpenses),1)]),_:1})]),_:1})]),_:1}),e(v,{cols:"12",md:"3"},{default:s(()=>[e(x,{variant:"tonal",color:"success",class:"summary-card"},{default:s(()=>[e(_,null,{default:s(()=>[c("div",ne,[e(y,{icon:"ri-line-chart-line",size:"32"}),a.previousData.netProfitPaidBasis?(k(),A(R,{key:0,color:"success",size:"small"},{default:s(()=>[b(D(l.calculateChange(a.summary.netProfitPaidBasis,a.previousData.netProfitPaidBasis)),1)]),_:1})):S("",!0)]),t[14]||(t[14]=c("div",{class:"text-caption text-medium-emphasis mb-1"},"صافي الربح (مقبوض)",-1)),c("div",re,D(a.animatedNetProfit),1)]),_:1})]),_:1})]),_:1})]),_:1}),e(B,{class:"mb-4"},{default:s(()=>[e(v,{cols:"12",md:"8"},{default:s(()=>[e(x,{elevation:"2",rounded:"lg"},{default:s(()=>[e(V,{class:"text-subtitle-1 font-weight-bold"},{default:s(()=>[e(y,{icon:"ri-bar-chart-box-line",class:"me-2"}),t[15]||(t[15]=b(" مقارنة الدخل والمصروفات "))]),_:1}),e(_,null,{default:s(()=>[e(h,{type:"bar",height:"350",options:l.barChartOptions,series:l.barChartSeries},null,8,["options","series"])]),_:1})]),_:1})]),_:1}),e(v,{cols:"12",md:"4"},{default:s(()=>[e(x,{elevation:"2",rounded:"lg"},{default:s(()=>[e(V,{class:"text-subtitle-1 font-weight-bold"},{default:s(()=>[e(y,{icon:"ri-pie-chart-line",class:"me-2"}),t[16]||(t[16]=b(" توزيع المصروفات "))]),_:1}),e(_,null,{default:s(()=>[e(h,{type:"donut",height:"350",options:l.pieChartOptions,series:l.pieChartSeries},null,8,["options","series"])]),_:1})]),_:1})]),_:1})]),_:1}),e(B,null,{default:s(()=>[e(v,{cols:"12",md:"6"},{default:s(()=>[e(x,{elevation:"2",rounded:"lg"},{default:s(()=>[e(V,{class:"text-subtitle-1 font-weight-bold"},{default:s(()=>[e(y,{icon:"ri-funds-line",class:"me-2"}),t[17]||(t[17]=b(" التحليل على أساس المقبوض "))]),_:1}),e(_,null,{default:s(()=>[e(h,{type:"line",height:"300",options:l.lineChartPaidOptions,series:l.lineChartPaidSeries},null,8,["options","series"])]),_:1})]),_:1})]),_:1}),e(v,{cols:"12",md:"6"},{default:s(()=>[e(x,{elevation:"2",rounded:"lg"},{default:s(()=>[e(V,{class:"text-subtitle-1 font-weight-bold"},{default:s(()=>[e(y,{icon:"ri-line-chart-fill",class:"me-2"}),t[18]||(t[18]=b(" التحليل على أساس الاستحقاق "))]),_:1}),e(_,null,{default:s(()=>[e(h,{type:"line",height:"300",options:l.lineChartDueOptions,series:l.lineChartDueSeries},null,8,["options","series"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},512),a.alert.open?(k(),A(p,{key:0,modelValue:a.alert.open,"onUpdate:modelValue":t[3]||(t[3]=u=>a.alert.open=u),type:a.alert.type,message:a.alert.message,closable:!0,"close-text":"موافق",onClose:t[4]||(t[4]=u=>a.alert.open=!1)},null,8,["modelValue","type","message"])):S("",!0)])}const Ie=Z(ee,[["render",de],["__scopeId","data-v-b9b7f13a"]]);export{Ie as default};
