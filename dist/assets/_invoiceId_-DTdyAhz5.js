import{_ as O}from"./BaseAlert-B7PZHURR.js";import{_ as q}from"./AppBreadcrumbs-CbmSjfOn.js";import{T as b}from"./teacher_api-CgB6fFx4.js";import{n as P}from"./number-DRUmGIrN.js";import{_ as R}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as _,b as D,c as w}from"./VCard-CBPwRQhR.js";import{V as A}from"./VDialog-N4WR69CN.js";import{c as k,b as e,f as V,x as W,e as n,o as c,d as r,k as C,V as N,t as p,q as m,b9 as v,F as z,s as E,A as h,b7 as S}from"./index-B_A_UGf-.js";import{V as T}from"./VDivider-Conlu035.js";import{V as y}from"./VCardText-BWyx6VBY.js";import{V as x,a as g}from"./VRow-DsXvHsvC.js";import{V as J}from"./VTable-CEsLxIJM.js";import{V as Y}from"./VChip-BWlPf9tC.js";import{V as G}from"./VSelect-BCxvD-wi.js";import"./axios-WFtL0f35.js";import"./VAvatar-BaPloNUq.js";import"./VImg-Mh6Lj_73.js";import"./VList-khjaFYbC.js";const H={data(){return{results:JSON.parse(localStorage.getItem("user")),breadcrumbItems:[{title:"الرئيسية",disabled:!1,to:"/teacher/index"},{title:"فواتير الطلاب",disabled:!1,to:{name:"teacher-invoices-manage-invoices"}},{title:"التفاصيل",disabled:!0}],loading:!1,progress:0,saving:!1,invoiceId:this.$route.params.invoiceId,inv:{id:"",amount_due:0,discount_total:0,amount_paid:0,remaining_amount:0,invoice_status:"",study_year:"",payment_mode:""},totals:{count:0,paidCount:0,partialCount:0,pendingCount:0,overdueCount:0,plannedTotal:0,paidTotal:0,remainingTotal:0},entries:[],entriesLoading:!1,installments:[],installmentsLoading:!1,installmentIndex:{},paymentMethods:[{text:"نقد",value:"cash"},{text:"تحويل بنكي",value:"bank_transfer"},{text:"بطاقة",value:"card"}],payDialog:{open:!1,form:{amount:null,paymentMethod:"cash",installmentId:"",paidAt:"",notes:""}},deleteDialog:{open:!1,loading:!1},restoreDialog:{open:!1,loading:!1},alert:{open:!1,type:"success",message:""}}},created(){var t,d,s,l,i,f;const o=((t=this.$route)==null?void 0:t.state)||((i=(l=(s=(d=this.$router)==null?void 0:d.options)==null?void 0:s.history)==null?void 0:l.state)==null?void 0:i.data);if(o&&typeof o=="object"){const u=(({id:a,amount_due:I,discount_total:M,amount_paid:F,remaining_amount:L,invoice_status:U,study_year:B,payment_mode:j})=>({id:a,amount_due:I,discount_total:M,amount_paid:F,remaining_amount:L,invoice_status:U,study_year:B,payment_mode:j}))(o);this.inv=Object.assign(this.inv,u)}else if((f=this.$route)!=null&&f.query){const u=this.$route.query;this.inv=Object.assign(this.inv,{id:u.id||this.invoiceId,amount_due:Number(u.amount_due)||0,discount_total:Number(u.discount_total)||0,amount_paid:Number(u.amount_paid)||0,remaining_amount:Number(u.remaining_amount)||0,invoice_status:u.invoice_status||"",study_year:u.study_year||"",payment_mode:u.payment_mode||""})}else this.inv.id=this.invoiceId},mounted(){this.loadFull()},methods:{numberWithComma:P,statusColor(o){return o==="paid"?"success":o==="partial"?"warning":o==="overdue"?"error":"secondary"},installmentStatusColor(o){return o==="paid"?"success":o==="pending"?"warning":o==="overdue"?"error":o==="partial"?"warning":"secondary"},toArabicInstallmentStatus(o){return o==="paid"?"مدفوع":o==="pending"?"قيد السداد":o==="overdue"?"متأخر":o==="partial"?"جزئي":o==="cancelled"||o==="canceled"?"ملغي":String(o||"")},async loadFull(){var o,t,d;try{this.loading=!0;const s=await b.getInvoiceFull(this.invoiceId),l=((o=s==null?void 0:s.data)==null?void 0:o.data)||{},i=l.invoice||{},f=Array.isArray(l.installments)?l.installments:[],u=l.totals||{};this.inv.amount_due=i.amount_due!=null?Number(i.amount_due):0,this.inv.discount_total=i.discount_total!=null?Number(i.discount_total):0,this.inv.amount_paid=i.amount_paid!=null?Number(i.amount_paid):0,this.inv.remaining_amount=i.remaining_amount!=null?Number(i.remaining_amount):0,this.inv.study_year=i.study_year||this.inv.study_year,this.inv.payment_mode=i.payment_mode||this.inv.payment_mode,this.inv.invoice_type=i.invoice_type||this.inv.invoice_type,this.installments=f.map(a=>({...a,planned_amount:(a==null?void 0:a.planned_amount)!=null?Number(a.planned_amount):a.planned_amount,paid_amount:(a==null?void 0:a.paid_amount)!=null?Number(a.paid_amount):a.paid_amount,remaining_amount:(a==null?void 0:a.remaining_amount)!=null?Number(a.remaining_amount):a.remaining_amount})),this.totals={count:u.count??0,paidCount:u.paidCount??0,partialCount:u.partialCount??0,pendingCount:u.pendingCount??0,overdueCount:u.overdueCount??0,plannedTotal:u.plannedTotal??0,paidTotal:u.paidTotal??0,remainingTotal:u.remainingTotal??0}}catch(s){this.showAlert("error",((d=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:d.message)||"تعذر جلب تفاصيل الفاتورة")}finally{this.loading=!1}},async handleSoftDelete(){var o,t,d;this.deleteDialog.loading=!0;try{const s=await b.softDeleteInvoice(this.invoiceId);this.showAlert("success",((o=s==null?void 0:s.data)==null?void 0:o.message)||"تم الحذف"),this.deleteDialog.open=!1}catch(s){this.showAlert("error",((d=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:d.message)||"تعذر الحذف")}finally{this.deleteDialog.loading=!1}},async handleRestore(){var o,t,d;this.restoreDialog.loading=!0;try{const s=await b.restoreInvoice(this.invoiceId);this.showAlert("success",((o=s==null?void 0:s.data)==null?void 0:o.message)||"تم الاسترجاع"),this.restoreDialog.open=!1,await this.loadFull()}catch(s){this.showAlert("error",((d=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:d.message)||"تعذر الاسترجاع")}finally{this.restoreDialog.loading=!1}},toArabicType(o){return o==="payment"?"دفعة":o==="discount"?"خصم":o==="refund"?"مرتجع":o==="adjustment"?"تسوية":String(o||"")},formatDate(o){if(!o)return"";const t=new Date(o),d=String(t.getDate()).padStart(2,"0"),s=String(t.getMonth()+1).padStart(2,"0"),l=t.getFullYear();return`${d}/${s}/${l}`},formatDateTime(o){return o?new Date(o).toLocaleString():""},async loadEntries(){var o,t,d,s;this.entriesLoading=!0;try{const l=await b.getInvoiceEntries(this.invoiceId),i=((o=l==null?void 0:l.data)==null?void 0:o.data)||[];this.entries=i.map(f=>({...f,amount:(f==null?void 0:f.amount)!=null?Number(f.amount):f.amount,installment_number:f.installment_number||this.installmentIndex[f.installment_id]||null}))}catch(l){((t=l==null?void 0:l.response)==null?void 0:t.status)!==404&&this.showAlert("error",((s=(d=l==null?void 0:l.response)==null?void 0:d.data)==null?void 0:s.message)||"تعذر جلب قيود الفاتورة")}finally{this.entriesLoading=!1}},async loadInstallments(){var o,t,d,s,l;this.installmentsLoading=!0;try{const i=await b.getInvoiceInstallments(this.invoiceId),f=((o=i==null?void 0:i.data)==null?void 0:o.data)||[];this.installments=f.map(a=>({...a,planned_amount:(a==null?void 0:a.planned_amount)!=null?Number(a.planned_amount):a.planned_amount,paid_amount:(a==null?void 0:a.paid_amount)!=null?Number(a.paid_amount):a.paid_amount,remaining_amount:(a==null?void 0:a.remaining_amount)!=null?Number(a.remaining_amount):a.remaining_amount}));const u={};for(const a of this.installments)u[a.id]=a.installment_number;this.installmentIndex=u,(t=this.entries)!=null&&t.length&&(this.entries=this.entries.map(a=>({...a,installment_number:a.installment_number||this.installmentIndex[a.installment_id]||null})))}catch(i){((d=i==null?void 0:i.response)==null?void 0:d.status)!==404&&this.showAlert("error",((l=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:l.message)||"تعذر جلب الأقساط")}finally{this.installmentsLoading=!1}},openPayDialog(){this.payDialog.open=!0},payInstallment(o){if(!o)return;const t=(o==null?void 0:o.remaining_amount)!=null?Number(o.remaining_amount):null;this.payDialog.form={amount:t&&isFinite(t)?t:this.payDialog.form.amount,paymentMethod:this.payDialog.form.paymentMethod||"cash",installmentId:o.id||"",paidAt:this.payDialog.form.paidAt||new Date().toISOString().slice(0,10),notes:this.payDialog.form.notes||""},this.payDialog.open=!0},openDeleteDialog(){this.deleteDialog.open=!0},openRestoreDialog(){this.restoreDialog.open=!0},async handleAddPayment(){var o,t,d;if(!this.payDialog.form.amount){this.showAlert("error","الرجاء إدخال مبلغ صحيح");return}this.saving=!0;try{const s={amount:Number(this.payDialog.form.amount),paymentMethod:this.payDialog.form.paymentMethod,installmentId:this.payDialog.form.installmentId||void 0,paidAt:this.payDialog.form.paidAt||void 0,notes:this.payDialog.form.notes||void 0},l=await b.addInvoicePayment(this.invoiceId,s);this.showAlert("success",((o=l==null?void 0:l.data)==null?void 0:o.message)||"تمت إضافة الدفعة"),this.payDialog.open=!1,this.payDialog.form={amount:null,paymentMethod:"cash",installmentId:"",paidAt:"",notes:""},await this.loadFull()}catch(s){this.showAlert("error",((d=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:d.message)||"تعذر إضافة الدفعة")}finally{this.saving=!1}},showAlert(o,t){Object.assign(this.alert,{open:!0,type:o,message:t})}}},K={class:"text-h6"},Q={class:"text-h6"},X={class:"text-h6"},Z={class:"text-h6"},$={class:"text-h6"},tt={class:"text-h6"},et={class:"text-h6"},at={"data-label":"#"},nt={"data-label":"المخطط"},lt={"data-label":"المدفوع"},ot={"data-label":"المتبقي"},it={"data-label":"تاريخ الاستحقاق"},st={"data-label":"الحالة"},rt={"data-label":"العمليات"};function ut(o,t,d,s,l,i){const f=q,u=O;return c(),k("div",null,[e(f,{items:l.breadcrumbItems},null,8,["items"]),e(_,{class:"my-4",elevation:"3",rounded:"lg"},{default:n(()=>[e(D,{class:"py-4 px-6 d-flex align-center"},{default:n(()=>[e(C,{icon:"ri-bill-line",color:"primary",class:"me-2",size:"24"}),t[12]||(t[12]=r("h3",{class:"text-h6 font-weight-bold"},"تفاصيل الفاتورة",-1)),e(N)]),_:1}),e(T),e(y,null,{default:n(()=>[e(x,null,{default:n(()=>[e(g,{cols:"12",md:"3"},{default:n(()=>[e(_,{variant:"tonal"},{default:n(()=>[e(y,null,{default:n(()=>[t[13]||(t[13]=r("div",{class:"text-caption"},"المبلغ المستحق",-1)),r("div",K,p(i.numberWithComma(l.inv.amount_due)),1)]),_:1})]),_:1})]),_:1}),e(g,{cols:"12",md:"3"},{default:n(()=>[e(_,{variant:"tonal"},{default:n(()=>[e(y,null,{default:n(()=>[t[14]||(t[14]=r("div",{class:"text-caption"},"إجمالي الخصم",-1)),r("div",Q,p(i.numberWithComma(l.inv.discount_total)),1)]),_:1})]),_:1})]),_:1}),e(g,{cols:"12",md:"3"},{default:n(()=>[e(_,{variant:"tonal"},{default:n(()=>[e(y,null,{default:n(()=>[t[15]||(t[15]=r("div",{class:"text-caption"},"المدفوع",-1)),r("div",X,p(i.numberWithComma(l.inv.amount_paid)),1)]),_:1})]),_:1})]),_:1}),e(g,{cols:"12",md:"3"},{default:n(()=>[e(_,{variant:"tonal"},{default:n(()=>[e(y,null,{default:n(()=>[t[16]||(t[16]=r("div",{class:"text-caption"},"المتبقي",-1)),r("div",Z,p(i.numberWithComma(l.inv.remaining_amount)),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(_,{class:"my-4",elevation:"3",rounded:"lg"},{default:n(()=>[e(D,{class:"py-4 px-6 d-flex align-center"},{default:n(()=>[e(C,{icon:"ri-pie-chart-2-line",class:"me-2"}),t[17]||(t[17]=m(" إحصائيات الفاتورة "))]),_:1}),e(T),e(y,null,{default:n(()=>[e(x,null,{default:n(()=>[e(g,{cols:"12",md:"2"},{default:n(()=>[e(v,{variant:"tonal",type:"info"},{default:n(()=>[m("عدد الأقساط: "+p(l.totals.count),1)]),_:1})]),_:1}),e(g,{cols:"12",md:"2"},{default:n(()=>[e(v,{variant:"tonal",type:"success"},{default:n(()=>[m("مدفوعة: "+p(l.totals.paidCount),1)]),_:1})]),_:1}),e(g,{cols:"12",md:"2"},{default:n(()=>[e(v,{variant:"tonal",type:"warning"},{default:n(()=>[m("قيد السداد: "+p(l.totals.pendingCount),1)]),_:1})]),_:1}),e(g,{cols:"12",md:"2"},{default:n(()=>[e(v,{variant:"tonal",type:"warning"},{default:n(()=>[m("جزئية: "+p(l.totals.partialCount),1)]),_:1})]),_:1}),e(g,{cols:"12",md:"2"},{default:n(()=>[e(v,{variant:"tonal",type:"error"},{default:n(()=>[m("متأخرة: "+p(l.totals.overdueCount),1)]),_:1})]),_:1})]),_:1}),e(x,{class:"mt-2"},{default:n(()=>[e(g,{cols:"12",md:"4"},{default:n(()=>[e(_,{variant:"tonal"},{default:n(()=>[e(y,null,{default:n(()=>[t[18]||(t[18]=r("div",{class:"text-caption"},"مجموع المخطط",-1)),r("div",$,p(i.numberWithComma(l.totals.plannedTotal)),1)]),_:1})]),_:1})]),_:1}),e(g,{cols:"12",md:"4"},{default:n(()=>[e(_,{variant:"tonal"},{default:n(()=>[e(y,null,{default:n(()=>[t[19]||(t[19]=r("div",{class:"text-caption"},"مجموع المدفوع",-1)),r("div",tt,p(i.numberWithComma(l.totals.paidTotal)),1)]),_:1})]),_:1})]),_:1}),e(g,{cols:"12",md:"4"},{default:n(()=>[e(_,{variant:"tonal"},{default:n(()=>[e(y,null,{default:n(()=>[t[20]||(t[20]=r("div",{class:"text-caption"},"مجموع المتبقي",-1)),r("div",et,p(i.numberWithComma(l.totals.remainingTotal)),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(_,{class:"my-4",elevation:"3",rounded:"lg"},{default:n(()=>[e(D,{class:"py-4 px-6 d-flex align-center"},{default:n(()=>[e(C,{icon:"ri-calendar-schedule-line",class:"me-2"}),t[21]||(t[21]=m(" الأقساط "))]),_:1}),e(T),e(y,null,{default:n(()=>[l.installmentsLoading?(c(),V(v,{key:0,type:"info",variant:"tonal"},{default:n(()=>t[22]||(t[22]=[m("جاري التحميل...")])),_:1})):l.installments.length?(c(),V(J,{key:2,density:"comfortable"},{default:n(()=>[t[25]||(t[25]=r("thead",null,[r("tr",null,[r("th",null,"#"),r("th",null,"المخطط"),r("th",null,"المدفوع"),r("th",null,"المتبقي"),r("th",null,"تاريخ الاستحقاق"),r("th",null,"الحالة"),r("th",null,"العمليات")])],-1)),r("tbody",null,[(c(!0),k(z,null,E(l.installments,(a,I)=>(c(),k("tr",{key:I},[r("td",at,p(a.installment_number),1),r("td",nt,p(i.numberWithComma(a.planned_amount)),1),r("td",lt,p(i.numberWithComma(a.paid_amount)),1),r("td",ot,p(i.numberWithComma(a.remaining_amount)),1),r("td",it,p(i.formatDate(a.due_date)),1),r("td",st,[e(Y,{color:i.installmentStatusColor(a.installment_status),size:"small",variant:"flat"},{default:n(()=>[m(p(i.toArabicInstallmentStatus(a.installment_status)),1)]),_:2},1032,["color"])]),r("td",rt,[a.installment_status!=="paid"&&Number(a.remaining_amount)>0?(c(),V(h,{key:0,size:"small",color:"primary",variant:"tonal",loading:l.saving,onClick:M=>i.payInstallment(a)},{default:n(()=>t[24]||(t[24]=[m(" تسديد ")])),_:2},1032,["loading","onClick"])):W("",!0)])]))),128))])]),_:1})):(c(),V(v,{key:1,type:"info",variant:"tonal"},{default:n(()=>t[23]||(t[23]=[m("لا يوجد أقساط")])),_:1}))]),_:1})]),_:1}),e(A,{modelValue:l.payDialog.open,"onUpdate:modelValue":t[5]||(t[5]=a=>l.payDialog.open=a),"max-width":"520"},{default:n(()=>[e(_,{title:"تسديد الدفعة"},{default:n(()=>[e(y,null,{default:n(()=>[e(x,null,{default:n(()=>[e(g,{cols:"12"},{default:n(()=>[e(S,{modelValue:l.payDialog.form.amount,"onUpdate:modelValue":t[0]||(t[0]=a=>l.payDialog.form.amount=a),modelModifiers:{number:!0},type:"number",label:"المبلغ",variant:"outlined",disabled:!0},null,8,["modelValue"])]),_:1}),e(g,{cols:"12"},{default:n(()=>[e(G,{modelValue:l.payDialog.form.paymentMethod,"onUpdate:modelValue":t[1]||(t[1]=a=>l.payDialog.form.paymentMethod=a),items:l.paymentMethods,"item-title":"text","item-value":"value",label:"طريقة الدفع",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),e(g,{cols:"12"},{default:n(()=>[e(S,{modelValue:l.payDialog.form.paidAt,"onUpdate:modelValue":t[2]||(t[2]=a=>l.payDialog.form.paidAt=a),type:"date",label:"تاريخ الدفع",variant:"outlined"},null,8,["modelValue"])]),_:1}),e(g,{cols:"12"},{default:n(()=>[e(S,{modelValue:l.payDialog.form.notes,"onUpdate:modelValue":t[3]||(t[3]=a=>l.payDialog.form.notes=a),label:"ملاحظات",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(w,null,{default:n(()=>[e(h,{onClick:t[4]||(t[4]=a=>l.payDialog.open=!1)},{default:n(()=>t[26]||(t[26]=[m("إلغاء")])),_:1}),e(h,{color:"primary",loading:l.saving,onClick:i.handleAddPayment},{default:n(()=>t[27]||(t[27]=[m("تسديد")])),_:1},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(A,{modelValue:l.deleteDialog.open,"onUpdate:modelValue":t[7]||(t[7]=a=>l.deleteDialog.open=a),"max-width":"520"},{default:n(()=>[e(_,null,{default:n(()=>[e(D,{class:"d-flex align-center"},{default:n(()=>[e(C,{icon:"ri-delete-bin-line",class:"me-2"}),t[28]||(t[28]=m(" تأكيد الحذف "))]),_:1}),e(y,null,{default:n(()=>t[29]||(t[29]=[m(" سيتم حذف الفاتورة حذفًا منطقيًا (Soft Delete) مع أقساطها وقيودها. هل تريد المتابعة؟ ")])),_:1}),e(w,null,{default:n(()=>[e(N),e(h,{variant:"text",onClick:t[6]||(t[6]=a=>l.deleteDialog.open=!1)},{default:n(()=>t[30]||(t[30]=[m("إلغاء")])),_:1}),e(h,{color:"error",loading:l.deleteDialog.loading,onClick:i.handleSoftDelete},{default:n(()=>t[31]||(t[31]=[m("حذف")])),_:1},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(A,{modelValue:l.restoreDialog.open,"onUpdate:modelValue":t[9]||(t[9]=a=>l.restoreDialog.open=a),"max-width":"520"},{default:n(()=>[e(_,null,{default:n(()=>[e(D,{class:"d-flex align-center"},{default:n(()=>[e(C,{icon:"ri-refresh-line",class:"me-2"}),t[32]||(t[32]=m(" تأكيد الاسترجاع "))]),_:1}),e(y,null,{default:n(()=>t[33]||(t[33]=[m(" سيتم استرجاع الفاتورة مع أقساطها وقيودها. هل تريد المتابعة؟ ")])),_:1}),e(w,null,{default:n(()=>[e(N),e(h,{variant:"text",onClick:t[8]||(t[8]=a=>l.restoreDialog.open=!1)},{default:n(()=>t[34]||(t[34]=[m("إلغاء")])),_:1}),e(h,{color:"success",loading:l.restoreDialog.loading,onClick:i.handleRestore},{default:n(()=>t[35]||(t[35]=[m("استرجاع")])),_:1},8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l.alert.open?(c(),V(u,{key:0,modelValue:l.alert.open,"onUpdate:modelValue":t[10]||(t[10]=a=>l.alert.open=a),type:l.alert.type,message:l.alert.message,closable:!0,"close-text":"موافق",onClose:t[11]||(t[11]=a=>l.alert.open=!1)},null,8,["modelValue","type","message"])):W("",!0)])}const kt=R(H,[["render",ut],["__scopeId","data-v-91565494"]]);export{kt as default};
