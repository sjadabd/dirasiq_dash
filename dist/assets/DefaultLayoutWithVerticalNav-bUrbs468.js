import P from"./teacher_api-DSYadeDI.js";import{n as at,_ as st}from"./index-DPOZODrZ.js";import{r as m,k as lt,l as it,m as ot,a as nt,c as x,o,b as s,e as a,h as rt,d as N,f,n as V,p,V as L,q as ut,s as d,v as _,F as dt,x as ct,y as q,i as O,t as S}from"./index-DzRnBGoW.js";import mt from"./NavbarThemeSwitcher-BbmOp3xV.js";import ft from"./UserProfile-CNLgxsNQ.js";import{V as W,a as J,b as E}from"./VCard-DkKUq9Xw.js";import{V as B}from"./VDivider-DOU2dJa1.js";import{V as vt,a as pt}from"./VList-C_vO-TC7.js";import{V as gt}from"./VAvatar-gDhFptrY.js";import{V as H}from"./VImg-DAcp9xse.js";import{V as yt}from"./VBadge-B-YGHxeJ.js";import{V as kt}from"./VCardText-DxpVkpnf.js";import{V as Vt}from"./VDialog-B-d6xDxs.js";import"./axios-CwDcW8lj.js";import"./logo-DZO2jDAJ.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./vue3-perfect-scrollbar-5-J_s6um.js";import"./casl-CiYbLG0E.js";import"./VTooltip-CZZ_rwxI.js";import"./auth_api-BS_laMWQ.js";const _t={class:"d-flex h-100 align-center"},xt={key:1,class:"text-center pa-6 text-medium-emphasis"},bt={key:3,class:"d-flex justify-center pa-2"},Ct={class:"text-h6 font-weight-bold"},ht={key:0,class:"text-body-2 text-medium-emphasis mb-2"},It={style:{"white-space":"pre-line"},class:"mb-3"},Nt={key:1,class:"text-caption text-medium-emphasis"},Gt=Object.assign({inheritAttrs:!1},{__name:"DefaultLayoutWithVerticalNav",setup(St){const $=m(!1),C=m(!1),b=m(!1),v=m([]),w=m(1),T=m(10),h=m(!1),A=m(!1),g=m(0),c=m(null),Q=lt(),G=it(),D=e=>{try{return new Date(e).toLocaleString("en-IQ")}catch{return e}},K=e=>{var t;try{const n=(e==null?void 0:e.type)||((t=e==null?void 0:e.data)==null?void 0:t.type),r=(e==null?void 0:e.data)||{};switch(n){case"new_booking":case"booking_update":return r.bookingId?`/teacher/payments/reservations/${encodeURIComponent(r.bookingId)}`:"/teacher/payments/reservations/show-reservation-payments";case"course_update":return"/teacher/course/show-course";case"teacher_message":case"message":return"/teacher/notifications/show-notifications";default:return null}}catch{return null}},M=async(e=1,t=!1)=>{var n;try{const r=localStorage.getItem("accessToken"),l=localStorage.getItem("user");let i=null;try{i=l?JSON.parse(l):null}catch{i=null}if(!r||!i||(i==null?void 0:i.userType)==="super_admin"){v.value=[],g.value=0,h.value=!1;return}A.value=!0;const y=await P.getNotifications({page:e,limit:T.value}),k=(n=y==null?void 0:y.data)!=null&&n.data?y.data:y,tt=Array.isArray(k==null?void 0:k.data)?k.data:[],R=(k==null?void 0:k.content_url)||"",I=tt.map(u=>{var j,F;return{id:u.id,title:u.title,message:u.message,type:u.type,is_read:!!u.is_read,sentAt:u.sent_at||u.created_at,image:(j=u.data)!=null&&j.imageUrl?R?`${R}${u.data.imageUrl}`:u.data.imageUrl:null,url:((F=u.data)==null?void 0:F.url)||K(u)||null,raw:u}});v.value=t?[...v.value,...I]:I,g.value=v.value.filter(u=>!u.is_read).length;const et=(k.pagination||{}).totalPages||(I.length<T.value?e:e+1);h.value=e<et&&I.length>0,w.value=e}catch(r){console.warn("Failed to fetch notifications:",r)}finally{A.value=!1}},U=()=>{w.value=1,M(1,!1)},X=()=>{const e=w.value+1;M(e,!0)},Y=async e=>{try{C.value=!1,console.debug("[Notifications] item clicked",e==null?void 0:e.id),e!=null&&e.id&&await z(String(e.id)),c.value=e,b.value=!0}catch(t){console.warn("openNotification failed:",t)}},z=async e=>{try{if(!e)return;console.debug("[Notifications] marking read ->",e),await P.markNotificationRead(String(e));const t=v.value.findIndex(n=>String(n.id)===String(e));t>-1&&!v.value[t].is_read&&(v.value[t].is_read=!0),g.value=Math.max(0,g.value-1)}catch(t){console.warn("Failed to mark notification as read:",t)}};ot(()=>{var i;const e=localStorage.getItem("accessToken"),t=localStorage.getItem("user");let n=null;try{n=t?JSON.parse(t):null}catch{n=null}const r=n==null?void 0:n.userType;$.value=!!(e&&n&&r!=="super_admin"),$.value&&U();const l=(i=G.query)==null?void 0:i.notificationId;l&&z(String(l)).then(()=>{}).catch(()=>{})});const Z=async e=>{if(e!=null&&e.url)try{e.url.startsWith("http://")||e.url.startsWith("https://")?window.open(e.url,"_blank"):await Q.push(e.url)}catch{}};return(e,t)=>{const n=nt("IconBtn");return o(),x("div",null,[s(O(st),q(e.$attrs,{"nav-items":O(at)}),{navbar:a(({toggleVerticalOverlayNavActive:r})=>[N("div",_t,[s(n,{id:"vertical-nav-toggle-btn",class:"ms-n2 d-lg-none",onClick:l=>r(!0)},{default:a(()=>[s(p,{icon:"ri-menu-line"})]),_:2},1032,["onClick"]),s(mt),s(L),$.value?(o(),f(ut,{key:0,modelValue:C.value,"onUpdate:modelValue":t[1]||(t[1]=l=>C.value=l),location:"bottom","close-on-content-click":!1},{activator:a(({props:l})=>[s(_,q({icon:"",variant:"text"},l),{default:a(()=>[g.value?(o(),f(yt,{key:0,color:"error",content:g.value,overlap:""},{default:a(()=>[s(p,null,{default:a(()=>t[6]||(t[6]=[d("mdi-bell")])),_:1})]),_:1},8,["content"])):(o(),f(p,{key:1},{default:a(()=>t[7]||(t[7]=[d("mdi-bell")])),_:1}))]),_:2},1040)]),default:a(()=>[s(W,{"min-width":"360"},{default:a(()=>[s(J,{class:"d-flex align-center"},{default:a(()=>[s(p,{start:"",class:"me-2"},{default:a(()=>t[8]||(t[8]=[d("mdi-bell")])),_:1}),t[10]||(t[10]=N("span",{class:"text-subtitle-1"},"الإشعارات",-1)),s(L),s(_,{size:"small",variant:"text",onClick:U},{default:a(()=>t[9]||(t[9]=[d("تحديث")])),_:1})]),_:1}),s(B),v.value.length?(o(),f(vt,{key:0,density:"compact"},{default:a(()=>[(o(!0),x(dt,null,ct(v.value,l=>(o(),f(pt,{key:l.id,onClick:i=>Y(l),title:l.title,subtitle:D(l.sentAt),class:"notification-item"},{prepend:a(()=>[s(gt,{size:"36",color:l.is_read?"grey":"primary"},{default:a(()=>[l.image?(o(),f(H,{key:0,src:l.image,cover:""},null,8,["src"])):(o(),f(p,{key:1,color:"white",size:"18"},{default:a(()=>t[11]||(t[11]=[d("mdi-bell")])),_:1}))]),_:2},1032,["color"])]),_:2},1032,["onClick","title","subtitle"]))),128))]),_:1})):(o(),x("div",xt,"لا توجد إشعارات")),h.value?(o(),f(B,{key:2})):V("",!0),h.value?(o(),x("div",bt,[s(_,{size:"small",loading:A.value,variant:"text",onClick:X},{default:a(()=>t[12]||(t[12]=[d("عرض المزيد")])),_:1},8,["loading"])])):V("",!0),s(E,{class:"justify-end"},{default:a(()=>[s(_,{variant:"text",onClick:t[0]||(t[0]=l=>C.value=!1)},{default:a(()=>t[13]||(t[13]=[d("إغلاق")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])):V("",!0),s(ft)])]),default:a(()=>[rt(e.$slots,"default")]),_:3},16,["nav-items"]),s(Vt,{modelValue:b.value,"onUpdate:modelValue":t[5]||(t[5]=r=>b.value=r),"max-width":"700"},{default:a(()=>[s(W,null,{default:a(()=>{var r;return[s(J,{class:"d-flex align-center"},{default:a(()=>{var l;return[s(p,{start:"",color:"primary",class:"me-2"},{default:a(()=>t[14]||(t[14]=[d("mdi-bell")])),_:1}),N("span",Ct,S((l=c.value)==null?void 0:l.title),1),s(L),s(_,{icon:"",variant:"text",onClick:t[2]||(t[2]=i=>b.value=!1)},{default:a(()=>[s(p,null,{default:a(()=>t[15]||(t[15]=[d("mdi-close")])),_:1})]),_:1})]}),_:1}),s(B),(r=c.value)!=null&&r.image?(o(),f(H,{key:0,src:c.value.image,height:"260",cover:""},null,8,["src"])):V("",!0),s(kt,null,{default:a(()=>{var l,i,y;return[(l=c.value)!=null&&l.sentAt?(o(),x("div",ht,[s(p,{size:"16",class:"me-1"},{default:a(()=>t[16]||(t[16]=[d("mdi-calendar")])),_:1}),d(" "+S(D(c.value.sentAt)),1)])):V("",!0),N("div",It,S((i=c.value)==null?void 0:i.message),1),(y=c.value)!=null&&y.type?(o(),x("div",Nt,[s(p,{size:"14",class:"me-1"},{default:a(()=>t[17]||(t[17]=[d("mdi-tag")])),_:1}),d(" "+S(c.value.type),1)])):V("",!0)]}),_:1}),s(E,{class:"justify-end"},{default:a(()=>{var l;return[(l=c.value)!=null&&l.url?(o(),f(_,{key:0,onClick:t[3]||(t[3]=i=>Z(c.value)),variant:"tonal"},{default:a(()=>t[18]||(t[18]=[d("فتح")])),_:1})):V("",!0),s(_,{variant:"text",onClick:t[4]||(t[4]=i=>b.value=!1)},{default:a(()=>t[19]||(t[19]=[d("إغلاق")])),_:1})]}),_:1})]}),_:1})]),_:1},8,["modelValue"])])}}});export{Gt as default};
