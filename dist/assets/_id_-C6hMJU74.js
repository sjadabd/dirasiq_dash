import{_ as I}from"./BaseAlert-wMiE8tvl.js";import{_ as B}from"./AppBreadcrumbs-5R_D72iC.js";import _ from"./teacher_api-DyrQANjO.js";import{_ as M}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as v,a as b,c as T}from"./VCard-CTAW927Q.js";import{c as h,b as s,f as g,n as O,e as o,o as c,d as i,p as x,V as w,s as p,t as f,b1 as U,v as y,b0 as j,F as z,x as D}from"./index-N2EhsRQt.js";import{V}from"./VChip-v8q_B89j.js";import{V as k}from"./VDivider-D-Cf14qE.js";import{V as E,a as A}from"./VRow--YcB0Yd0.js";import{V as N}from"./VCardText-Q2eeque7.js";import{V as F}from"./VTable-uKW7adu2.js";import{V as L}from"./VSelect-Di_TKuth.js";import"./VDialog-DdZwyjMa.js";import"./axios-CK0PAUQZ.js";import"./VAvatar-M6cRQjPV.js";import"./VImg-DOYF3Gzb.js";import"./VList-BwysrA6o.js";const P={name:"TeacherSessionAttendance",data(){const d=new Date().toISOString().substring(0,10);return{sessionId:this.$route.params.id,sessionInfo:null,filters:{date:d},loading:!1,saving:!1,students:[],attendanceMap:{},statusItems:[{text:"حاضر",value:"present"},{text:"غائب",value:"absent"},{text:"إجازة",value:"leave"}],breadcrumbs:[{title:"الرئيسية",disabled:!1,to:"/teacher/index"},{title:"الجلسات",disabled:!1,to:"/teacher/sessions/manage-sessions"},{title:"حضور الجلسة",disabled:!0}],alert:{open:!1,message:null,type:"success"}}},created(){this.initLoad()},methods:{async initLoad(){await this.loadStudentsBase(),await this.loadAttendance()},async loadStudentsBase(){var d,e,u;try{this.loading=!0;const a=await _.getSessionAttendees(this.sessionId),t=((d=a==null?void 0:a.data)==null?void 0:d.data)||[];this.students=t.map(n=>typeof n=="object"?n:{student_id:n,student_name:String(n),grade_name:"",study_year:""}),this.students.forEach(n=>{this.attendanceMap.hasOwnProperty(n.student_id)||(this.$set?this.$set(this.attendanceMap,n.student_id,null):this.attendanceMap[n.student_id]=null)})}catch(a){this.showAlert("error",((u=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:u.message)||"تعذر جلب طلاب الجلسة")}finally{this.loading=!1}},async loadAttendance(){var d,e,u;try{this.loading=!0;const a=await _.getSessionAttendanceByDate(this.sessionId,this.filters.date),t=((d=a==null?void 0:a.data)==null?void 0:d.data)||[],n={};t.forEach(r=>{const l=r.student_id||r.studentId;l&&(n[String(l)]=r.status||null)});const m={};this.students.forEach(r=>{m[r.student_id]=n.hasOwnProperty(String(r.student_id))?n[String(r.student_id)]:this.attendanceMap[r.student_id]??null}),this.attendanceMap=m}catch(a){this.showAlert("error",((u=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:u.message)||"تعذر جلب حضور الجلسة")}finally{this.loading=!1}},async saveAttendance(){var d,e,u;try{this.saving=!0;const a=Object.keys(this.attendanceMap).map(m=>({studentId:m,status:this.attendanceMap[m]||null})),t={date:this.filters.date,items:a},n=await _.bulkSetSessionAttendance(this.sessionId,t);this.showAlert("success",((d=n==null?void 0:n.data)==null?void 0:d.message)||"تم حفظ الحضور"),await this.loadAttendance()}catch(a){this.showAlert("error",((u=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:u.message)||"تعذر حفظ الحضور")}finally{this.saving=!1}},showAlert(d,e){Object.assign(this.alert,{open:!0,type:d,message:e})}}},R={key:0,class:"text-medium-emphasis"},q={key:1},G={class:"text-center","data-label":"#"},H={class:"text-center","data-label":"اسم الطالب"},J={class:"text-center","data-label":"المرحلة"},K={class:"text-center","data-label":"السنة"},Q={class:"text-center","data-label":"الحالة",style:{"min-inline-size":"180px"}};function W(d,e,u,a,t,n){const m=B,r=I;return c(),h("div",null,[s(m,{items:t.breadcrumbs},null,8,["items"]),s(v,{class:"my-4",elevation:"3",rounded:"lg"},{default:o(()=>[s(b,{class:"d-flex align-center py-4 px-6"},{default:o(()=>[s(x,{icon:"ri-calendar-check-line",color:"primary",class:"me-2",size:"24"}),e[4]||(e[4]=i("h3",{class:"text-h5 font-weight-bold"},"إدارة حضور الجلسة",-1)),s(w),s(V,{color:"primary",variant:"elevated",class:"font-weight-medium"},{default:o(()=>{var l;return[p(f(((l=t.sessionInfo)==null?void 0:l.title)||"جلسة"),1)]}),_:1})]),_:1}),s(k),s(T,null,{default:o(()=>[s(E,{class:"py-3",align:"center"},{default:o(()=>[s(A,{cols:"12",md:"4"},{default:o(()=>[s(U,{modelValue:t.filters.date,"onUpdate:modelValue":[e[0]||(e[0]=l=>t.filters.date=l),n.loadAttendance],type:"date",label:"تاريخ اليوم",variant:"outlined"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(A,{cols:"12",md:"8",class:"d-flex gap-2 justify-end"},{default:o(()=>[s(y,{color:"primary",variant:"tonal","prepend-icon":"ri-refresh-line",loading:t.loading,onClick:n.loadAttendance},{default:o(()=>e[5]||(e[5]=[p(" تحديث ")])),_:1},8,["loading","onClick"]),s(y,{color:"success","prepend-icon":"ri-save-3-line",loading:t.saving,onClick:n.saveAttendance},{default:o(()=>e[6]||(e[6]=[p(" حفظ الحضور ")])),_:1},8,["loading","onClick"]),s(y,{variant:"text","prepend-icon":"ri-arrow-go-back-line",onClick:e[1]||(e[1]=l=>d.$router.back())},{default:o(()=>e[7]||(e[7]=[p(" رجوع ")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),s(v,{class:"my-4",elevation:"3",rounded:"lg"},{default:o(()=>[s(b,{class:"py-4 px-6 d-flex align-center"},{default:o(()=>[s(x,{icon:"ri-team-line",color:"primary",class:"me-2",size:"22"}),e[8]||(e[8]=i("h3",{class:"text-h6 font-weight-bold"},"طلاب الجلسة لليوم المحدد",-1)),s(w),s(V,{color:"primary",variant:"elevated",class:"font-weight-medium"},{default:o(()=>[p(f(t.students.length)+" طالب ",1)]),_:1})]),_:1}),s(k),s(N,null,{default:o(()=>[t.loading?(c(),h("div",R,"جاري التحميل...")):(c(),h("div",q,[t.students.length?(c(),g(F,{key:1,density:"comfortable"},{default:o(()=>[e[10]||(e[10]=i("thead",null,[i("tr",null,[i("th",{class:"text-center"},"#"),i("th",{class:"text-center"},"اسم الطالب"),i("th",{class:"text-center"},"المرحلة"),i("th",{class:"text-center"},"السنة"),i("th",{class:"text-center"},"الحالة")])],-1)),i("tbody",null,[(c(!0),h(z,null,D(t.students,(l,S)=>(c(),h("tr",{key:l.student_id},[i("td",G,[s(V,{size:"small",color:"primary",variant:"flat"},{default:o(()=>[p(f(S+1),1)]),_:2},1024)]),i("td",H,f(l.student_name),1),i("td",J,f(l.grade_name||"-"),1),i("td",K,f(l.study_year||"-"),1),i("td",Q,[s(L,{modelValue:t.attendanceMap[l.student_id],"onUpdate:modelValue":C=>t.attendanceMap[l.student_id]=C,items:t.statusItems,"item-title":"text","item-value":"value",variant:"outlined",density:"comfortable"},null,8,["modelValue","onUpdate:modelValue","items"])])]))),128))])]),_:1})):(c(),g(j,{key:0,type:"info",variant:"tonal"},{default:o(()=>e[9]||(e[9]=[p(" لا يوجد طلاب في هذه الجلسة. ")])),_:1}))]))]),_:1})]),_:1}),t.alert.open?(c(),g(r,{key:0,modelValue:t.alert.open,"onUpdate:modelValue":e[2]||(e[2]=l=>t.alert.open=l),type:t.alert.type,message:t.alert.message,closable:!0,"close-text":"موافق",onClose:e[3]||(e[3]=l=>t.alert.open=!1)},null,8,["modelValue","type","message"])):O("",!0)])}const pe=M(P,[["render",W],["__scopeId","data-v-9e118a64"]]);export{pe as default};
